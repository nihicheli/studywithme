<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Studywithme</title>

<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand:wght@400&family=Nanum+Pen+Script&display=swap" rel="stylesheet">

<style>
  :root{
    --bg-url: url("https://github.com/nihicheli/studywithme/blob/main/image/background%205.png?raw=true");
    --ink: #FBFFF4;
    --ink-sub: rgba(0,0,0,.7);
    --line: transparent;
    --top-gap: 12px;
    --content-top: 20vh;

    /* 데스크톱 기본값(그대로 유지) */
    --maxh-board: 80vh;
    --maxh-timer: 35vh;
    --maxh-window: 40vh;
    --maxh-char: 50vh;

    --maxw-board: 25vw;
    --maxw-window: 15vw;
    --maxw-timer: 35vw;
    --maxw-char: 70vw;
  }
  :root[data-theme="light"]{
    --ink:#202020;
    --ink-sub:rgba(0,0,0,.7);
    --line:transparent;
  }

  *{box-sizing:border-box}
  html,body{
    height:100%; margin:0; color:var(--ink);
    font-family:"Patrick Hand","Nanum Pen Script",system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Arial,sans-serif;
    background:#000; font-size:clamp(12px,1.6vw,14px); letter-spacing:.02em;
  }

  /* 배경 + 10% 검정 오버레이 */
  #app{
    position:relative; height:100dvh; overflow:hidden;
    background-image:
      linear-gradient(rgba(0,0,0,.10), rgba(0,0,0,.10)),
      var(--bg-url);
    background-size:cover; background-position:center;
  }

  .card{ background: rgba(0,0,0,.02); border: 2px solid var(--line); border-radius: 16px; }
  .panel{ padding: 1rem; }

  button, .pill{
    cursor:pointer; user-select:none; outline:0; touch-action: manipulation;
    background: rgba(255,255,255,.08); color:var(--ink);
    border: 1px solid var(--line);
    border-radius: 999px;
    padding: .6rem .9rem;
    font-weight: 700;
    font-family: inherit;
    font-size: 1rem;
  }
  /* 안쪽 포커스 링 */
  button:focus, .pill:focus, button:focus-visible, .pill:focus-visible{
    outline: none; box-shadow: inset 0 0 0 1px #7C9AFF;
  }
  *{ -webkit-tap-highlight-color: transparent; }
  input, textarea, select{ font-family: inherit; font-size: 1rem; color:#fff }

  .row{display:flex; gap:.75rem; align-items:center; flex-wrap:wrap}
  .hwrap{ display:flex; gap:.5rem; align-items:center; overflow-x:auto; }
  .title{font-weight:900; font-size: 1.125rem}

  /* 상단 레이아웃 — 최상단 유지 */
  #topbar{
    position:absolute; left:12px; right:12px; top: var(--top-gap);
    display:grid; grid-template-columns: 1fr auto 1fr; align-items:start; gap:12px;
    z-index: 9000;
  }
  #hamburger{ justify-self:start; width:3.4rem; height:3.4rem; display:grid; place-items:center; font-size:1.2rem; position:relative; z-index:9001; }

  /* 타이머(가운데) */
  #timer{
    justify-self:center; width: min(var(--maxw-timer), 90vw); max-height: var(--maxh-timer);
    display:flex; flex-direction:column; align-items:center; gap:.6rem; text-align:center; overflow:hidden;
  }
  #state{ font-size: 1.25rem; font-weight:900; }
  #time{ font-weight:900; font-size: clamp(2.2rem, 6vw, 4rem); line-height:1; }

  /* Todo list(오른쪽) */
  #board{
    justify-self:end; width: min(var(--maxw-board), 92vw); max-height: var(--maxh-board);
    display:grid; grid-template-rows: auto 1fr auto; overflow:hidden;
  }
  #board .title{margin:0 0 .5rem 0}
  #todo-list{ overflow:auto; padding-right:2px; scrollbar-width: thin; }
  .todo{display:flex; align-items:center; gap:.5rem; padding:.45rem 0; border-bottom:1px solid rgba(255,255,255,.15)}
  .todo:last-child{border-bottom:0}
  .todo .txt{flex:1}
  .todo .del{background:transparent; border:0; color:var(--ink-sub); padding:.3rem .5rem; border-radius:.6rem}
  .todo .del:hover{background:rgba(255,255,255,.12); color:#fff}
  #inputRow{ display:flex; gap:.5rem; align-items:center; padding-top:.6rem; }
  #board input[type="text"]{ width:100%; background:transparent; border: 2px solid var(--line); border-radius: 12px; color:#fff; padding:.5rem .6rem; }

  /* 좌: 창문, 가운데: 캐릭터 */
  #window{ position:absolute; left:2vw; top: var(--content-top); z-index:5; width: min(var(--maxw-window), 90vw); }
  #win-img{ display:block; width:100%; height:auto; max-height: var(--maxh-window); border-radius:16px; border:2px solid var(--line); }

  #character{ position:absolute; left:50%; transform:translateX(-50%); top: calc(var(--content-top) + 20vh); z-index:6; width: min(var(--maxw-char), 96vw); }
  #char-img{ display:block; width:100%; height:auto; max-height: var(--maxh-char); border-radius:18px; border:2px solid var(--line); background:transparent center/contain no-repeat; }

  /* 하단: 음악패널 */
  #bottombar{
    position:fixed; left:12px; right:12px; bottom: 8px;
    display:flex; gap:12px; justify-content:center; align-items:flex-end; z-index:12;
  }
  #bottombar .card{ flex:1 1 0; min-width:260px; }
  #bottombar h4{ margin:0 0 .5rem 0; font-size: 1.125rem; font-weight:900 }

  /* === 소품 레이어 === */
  #propsLayer{
    position:absolute; inset:0; z-index:7;
    pointer-events:none; /* 기본은 클릭 통과 */
  }
  .prop{
    position:absolute; left:40px; top:40px; width:120px; z-index:80;
    pointer-events:auto; /* 소품 자체는 클릭 가능 */
  }
  .prop img{ width:100%; height:auto; display:block; }
  .draggable { cursor: move; }
  .dragging  { opacity:.92; }
  .resizer{
    position:absolute; right:-8px; bottom:-8px; width:16px; height:16px;
    border-radius:4px; background:rgba(255,255,255,.75);
    border:1px solid rgba(0,0,0,.3);
    display:none; z-index:3;
  }
  .edit-on .resizable .resizer{ display:block; }

  /* 드로어/오버레이 — 절대 최상단 */
  #overlay{ position:fixed; inset:0; background:rgba(0,0,0,.35); opacity:0; pointer-events:none; transition:opacity .2s ease; z-index: 10000; }
  #overlay.show{ opacity:1; pointer-events:auto; }

  #drawer{
    position:fixed; top:0; left:0; bottom:0; width:min(380px, 86vw);
    background:#111; color:#eee; border-right:2px solid var(--line);
    transform:translateX(-100%); transition:transform .24s ease; z-index: 10001;
    display:flex; flex-direction:column; gap:0; overflow-y:auto;
  }
  :root[data-theme="light"] #drawer{ background:#fafafa; color:#222; }
  #drawer.open{ transform:translateX(0) }
  .drawer-head{ display:flex; align-items:center; justify-content:space-between; padding:1rem; border-bottom:2px solid var(--line); }
  .drawer-sec{ padding:1rem; border-bottom:2px dashed rgba(255,255,255,.12); }
  :root[data-theme="light"] .drawer-sec{ border-bottom-color: rgba(0,0,0,.12); }
  .drawer-sec h4{ margin:.2rem 0 .8rem; font-weight:900; }

  .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:.5rem; }
  .drawer-sec input[type="number"], .drawer-sec input[type="text"]{
    width:100%; padding:.55rem .7rem; border:2px solid var(--line); border-radius:12px; background:transparent; color:#fff;
  }
  :root[data-theme="light"] .drawer-sec input[type="number"], :root[data-theme="light"] .drawer-sec input[type="text"]{ color:#222; }
  .fill{ flex:1 }

  .chips{ display:flex; gap:.5rem; align-items:center; flex-wrap: wrap; }
  .chips .pill{ border:1px solid var(--line); border-radius:14px; padding:.5rem .75rem; background:rgba(255,255,255,.06); transition: background .15s ease; }
  .chips .pill:hover{ background:rgba(255,255,255,.12); }
  .list-scroll{ max-height: 40vh; overflow: auto; padding-bottom: .25rem; }
  .list-scroll::-webkit-scrollbar{ width:10px; height:10px; }
  .list-scroll::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.22); border-radius:999px; }

  a#creditLink{ color:#9db7ff; text-decoration:none; border-bottom:1px dashed #9db7ff; }
  a#creditLink:hover{ opacity:.85; }

  .pill-input{
    width:100%; padding:.6rem .9rem; border:1px solid var(--line); border-radius:999px;
    background: rgba(255,255,255,.08); color:#fff; line-height:1; outline:none;
    transition: background .15s ease, box-shadow .15s ease; -webkit-appearance:none;
  }
  .pill-input::placeholder{ color: rgba(255,255,255,.6); }
  :root[data-theme="light"] .pill-input{ background: rgba(0,0,0,.06); color:#222; }
  :root[data-theme="light"] .pill-input::placeholder{ color: rgba(0,0,0,.5); }
  .pill-input:focus{ box-shadow: inset 0 0 0 3px #7C9AFF; background: rgba(124,154,255,.15); }
  .drawer-sec .row .pill-input{ flex:1; min-width:0; }

  /* 파일 선택을 pill처럼 */
  .input-file-hidden{
    position:absolute; width:0.1px; height:0.1px;
    opacity:0; overflow:hidden; z-index:-1;
  }
  .file-row{ display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
  .file-pill{ display:inline-flex; align-items:center; gap:.5rem; }
  .file-pill .icon{ font-size:1.1rem; line-height:1; }
  #bgFileName, #propFileName{
    max-width: 10rem;
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    opacity:.8;
  }
  .bg-thumb{
    width:42px; height:28px; border-radius:8px;
    border:1px solid var(--line); background:#000 center/cover no-repeat;
  }

  /* 강제 가로 보기(세로에서) */
  html.portrait-force, body.portrait-force{
    height:100%;
    overflow-x:auto;
    overflow-y:auto;
  }
  .portrait-force #app{
    width: 100vh;
    height: 100vw;
    transform: rotate(90deg) translateY(-100%);
    transform-origin: top left;
  }

  /* 오른쪽 아래: 실시간 패널 (데스크톱 기본) */
  #presencePanel{
    position: fixed;
    right: 0;
    bottom: calc(8px + 112px);
    width: 25vw;
    max-width: 25vw;
    z-index: 8000;
  }
  #presencePanel .dot{ display:inline-block; width:8px; height:8px; border-radius:999px; margin-right:.4rem; background:#9cccff; }
  #presencePanel .dot.work{ background:#7CFF7C; }
  #presencePanel .dot.break{ background:#FFC66D; }
  #presenceList .person{ display:flex; justify-content:space-between; gap:.5rem; padding:.25rem 0; }
  #presenceList .nick{ font-weight:700; }

  /* (추가) 하단 중앙 투명 배너 */
  #adBanner{
    position:fixed; left:50%; bottom:0; transform:translateX(-50%);
    width:min(90vw, 970px); height:90px; z-index:1; pointer-events:none;
  }
  #adBanner img{ width:100%; height:100%; opacity:0; display:block; }

  /* ========== 모바일 전용 오버라이드 (확대) ========== */
  @media (max-width: 720px){
    #character{ transform: translateX(-70%); }
    /* 전반적 확대 */
    html, body{ font-size: clamp(15px, 4.6vw, 18px); }

    :root{
      --content-top: 12vh;
      --maxh-board: 80vh;
      --maxh-timer: 40vh;
      --maxh-window: 50vh;
      --maxh-char: 65vh;

      /* 폭 확대 */
      --maxw-board: 70vw;
      --maxw-window: 40vw;
      --maxw-timer: 86vw;
      --maxw-char: 98vw;
    }

    #bottombar{ flex-direction:column; }
    #bottombar .card{ width:100%; }

    /* “지금 공부중” 패널 → Todo list 규격을 따름 */
    #presencePanel{
      right: 12px;
      bottom: calc(8px + 160px);
      width: min(var(--maxw-board), 92vw);
      max-width: min(var(--maxw-board), 92vw);
      max-height: var(--maxh-board);
      overflow:auto;
    }
  }
</style>
</head>
<body>
<div id="app" class="">
  <!-- 오른쪽 아래: 실시간 패널 -->
  <aside id="presencePanel" class="card panel" style="display:none">
    <div class="row" style="justify-content:space-between">
      <div class="title">지금 공부중</div>
      <div id="meNick" style="opacity:.8"></div>
    </div>
    <div id="presenceList"></div>
  </aside>

  <!-- 소품 레이어 -->
  <div id="propsLayer"></div>

  <!-- 오버레이 + 드로어 -->
  <div id="overlay"></div>
  <aside id="drawer" aria-label="설정">
    <header class="drawer-head">
      <h3 style="margin:0">설정</h3>
      <div class="row">
        <button id="themeToggle" class="pill" title="다크/라이트 전환">🌙</button>
        <button id="closeDrawer" class="pill">닫기</button>
      </div>
    </header>

    <!-- 1) 뽀모도로 / 타이머 -->
    <section class="drawer-sec">
      <h4>뽀모도로 / 타이머</h4>
      <div class="row" id="modeRow">
        <label><input type="radio" name="mode" value="pomodoro" checked> 뽀모도로</label>
        <label><input type="radio" name="mode" value="timer"> 타이머(카운트업)</label>
      </div>
      <div class="grid2" id="pomodoroFields" style="margin-top:.5rem">
        <label>집중(분)
          <input id="workMin" type="number" min="1" value="25">
        </label>
        <label>휴식(분)
          <input id="restMin" type="number" min="1" value="5">
        </label>
      </div>
      <label style="display:block; margin-top:.5rem" id="cyclesWrap">사이클 수(N회)
        <input id="totalCycles" type="number" min="1" value="4">
      </label>
      <div class="row" style="margin-top:.6rem">
        <button id="applyPom" class="pill">적용</button>
      </div>
    </section>

    <!-- 2) 실시간 보기 -->
    <section class="drawer-sec">
      <h4>실시간 보기</h4>
      <div class="row">
        <input id="nickname" class="fill pill-input" placeholder="닉네임(예: do)">
        <button id="presenceToggle" class="pill">공개: 켜짐</button>
      </div>
      <div class="row" style="margin-top:.5rem">
        <button id="shareStudyBtn" class="pill">내 공부시간 공개: 켜짐</button>
      </div>
      <div style="opacity:.8; margin-top:.4rem">※ 목록엔 최대 5명 표시.</div>
    </section>

    <!-- 3) 음악 -->
    <section class="drawer-sec">
      <h4>음악 스타일</h4>
      <div id="moods" class="chips list-scroll"></div>
    </section>

    <section class="drawer-sec">
      <h4>곡 선택</h4>
      <div id="tracks" class="chips list-scroll"></div>
    </section>

    <!-- 화면 표시 / 레이아웃 / 배경 / 소품 / 크레딧 -->
    <section class="drawer-sec">
      <h4>창문/캐릭터 표시</h4>
      <div class="row">
        <button id="toggleWindow" class="pill">창문: 보임</button>
        <button id="toggleCharacter" class="pill">캐릭터: 보임</button>
      </div>
    </section>

    <section class="drawer-sec">
      <h4>화면 설정</h4>
      <div class="row">
        <button id="layoutEdit" class="pill">배치 편집: 꺼짐</button>
        <button id="layoutReset" class="pill" title="원상복구">원상복구</button>
        <button id="rotateToggle" class="pill" title="세로에서 가로로 표시">회전: 켜짐</button>
      </div>
    </section>

    <section class="drawer-sec">
      <h4>배경 선택</h4>
      <div id="bgChips" class="chips"></div>

      <!-- 파일로 배경 선택 -->
      <div class="file-row" style="margin-top:.5rem">
        <input id="customBgFile" type="file" accept="image/*" class="input-file-hidden">
        <label for="customBgFile" class="pill file-pill" title="배경 이미지 선택">
          <span class="icon">📁</span> 배경 파일 선택
        </label>
        <span id="bgFileName">선택 안 됨</span>
        <span id="bgPreview" class="bg-thumb" aria-hidden="true"></span>
      </div>

      <div class="row" style="margin-top:.5rem">
        <input id="customBgUrl" placeholder="배경 이미지 URL 붙여넣기" class="fill pill-input">
        <button id="applyBg" class="pill">적용</button>
      </div>
    </section>

    <section class="drawer-sec">
      <h4>소품</h4>
      <!-- 파일 선택을 URL보다 위로 -->
      <div class="file-row" style="margin-top:.5rem">
        <input id="propFile" type="file" accept="image/*" class="input-file-hidden" />
        <label for="propFile" class="pill file-pill" title="소품 이미지 선택">
          <span class="icon">📁</span> 소품 파일 선택
        </label>
        <span id="propFileName">선택 안 됨</span>
        <button id="propFileAdd" class="pill">파일 추가</button>
      </div>
      <div class="row" style="margin-top:.5rem">
        <input id="propUrl" class="fill pill-input" placeholder="소품 이미지 URL">
        <button id="propAdd" class="pill">추가</button>
      </div>

      <div class="chips" style="margin-top:.5rem">
        <button class="pill propPreset" data-url="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f331.svg">🌱</button>
        <button class="pill propPreset" data-url="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/2615.svg">☕</button>
        <button class="pill propPreset" data-url="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f4a1.svg">💡</button>
        <button class="pill propPreset" data-url="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f4da.svg">📚</button>
      </div>
      <div id="propList" class="list-scroll" style="margin-top:.6rem"></div>
      <div style="opacity:.8; margin-top:.4rem">※ 소품은 추가 즉시 편집 가능(중앙 최소크기 배치)</div>
    </section>

    <section class="drawer-sec">
      <h4>Credits</h4>
      <a id="creditLink" href="#" target="_blank" rel="noopener">Made by do</a>
    </section>
  </aside>

  <!-- 상단: 햄버거 / 타이머 / Todo -->
  <div id="topbar">
    <button id="hamburger" class="card panel" aria-label="메뉴 열기">⋯</button>

    <section id="timer" class="card panel resizable" aria-label="타이머">
      <div id="state">집중중</div>
      <div id="time">25:00</div>
      <div class="row">
        <button class="pill" id="startPause">시작</button>
        <button class="pill" id="reset">리셋</button>
        <button class="pill" id="cyclesBtn" title="사이클 진행 상황">0/4회</button>
      </div>
    </section>

    <section id="board" class="card panel" aria-label="Todo list">
      <div class="title">Todo list</div>
      <div id="todo-list"></div>
      <div id="inputRow">
        <input id="todo-input" type="text" placeholder="할 일을 적고 Enter" />
        <button id="todo-add" class="pill" title="추가">＋</button>
      </div>
    </section>
  </div>

  <!-- 메인: 창문 + 캐릭터 -->
  <div id="window" class="resizable"><img id="win-img" alt="창문" /></div>
  <div id="character" class="resizable"><img id="char-img" alt="캐릭터" /></div>

  <!-- 하단: 음악 -->
  <div id="bottombar">
    <section id="music-controls" class="card panel" aria-label="음악 재생">
      <h4>음악 재생</h4>
      <div class="hwrap">
        <button class="pill" id="playPause">재생</button>
        <button class="pill" id="shuffle">랜덤 OFF</button>
        <button class="pill" id="repeat">반복: 꺼짐</button>
      </div>
      <audio id="player" preload="metadata"></audio>
    </section>
  </div>

  <!-- (추후 광고) 하단 중앙 투명 배너 -->
  <div id="adBanner" aria-hidden="true">
    <img alt="ad-placeholder"
      src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGNgYAAAAAMAASsJTYQAAAAASUVORK5CYII="/>
  </div>
</div>

<script>
  /* ===== 트랙 데이터 ===== */
  const TRACKS = [
    { title: "Bass Meant Jazz",     mood: "Jazz",  url: "https://freepd.com/music/Bass%20Meant%20Jazz.mp3" },
    { title: "Stompin at Midnight", mood: "Jazz",  url: "https://freepd.com/music/Stompin%20at%20Midnight.mp3" },
    { title: "Abstract Anxiety",    mood: "Loud",  url: "https://freepd.com/music/Abstract%20Anxiety.mp3" },
    { title: "Adding the Sun",      mood: "Lo-Fi", url: "https://freepd.com/music/Adding%20the%20Sun.mp3" },
    { title: "Bleu",                mood: "Lo-Fi", url: "https://freepd.com/music/Bleu.mp3" },
    { title: "Study and Relax",     mood: "Lo-Fi", url: "https://freepd.com/music/Study%20and%20Relax.mp3" },
    { title: "Deep Focus",          mood: "Lo-Fi", url: "https://freepd.com/music/Deep%20Focus.mp3" },
    /* White/Pink/Brown Noise (Public Domain) */
    { title: "White Noise",  mood: "Noise", url: "https://archive.org/download/TenMinutesOfWhiteNoisePinkNoiseAndBrownianNoise/WhiteNoise_64kb.mp3" },
    { title: "Pink Noise",   mood: "Noise", url: "https://archive.org/download/TenMinutesOfWhiteNoisePinkNoiseAndBrownianNoise/PinkNoise_64kb.mp3" },
    { title: "Brown Noise",  mood: "Noise", url: "https://archive.org/download/TenMinutesOfWhiteNoisePinkNoiseAndBrownianNoise/BrownianNoise_64kb.mp3" }
  ];

  /* 창문/캐릭터 0.5s 교차 */
  let charA = "https://github.com/nihicheli/studywithme/blob/main/image/Group%209213.png?raw=true";
  let charB = "https://github.com/nihicheli/studywithme/blob/main/image/Group%209214.png?raw=true";
  let winA  = "https://github.com/nihicheli/studywithme/blob/main/image/Group%209215.png?raw=true";
  let winB  = "https://github.com/nihicheli/studywithme/blob/main/image/Group%209216.png?raw=true";
  let showA = true, showWinA = true, blinkTimer = null;

  /* ===== 전역 상태 ===== */
  const lsShare = localStorage.getItem("shareStudy");
  const state = {
    mode: localStorage.getItem("mode") || "pomodoro",
    shareStudy: (lsShare === null) ? true : (lsShare === "1"),   // 기본 ON
    isWork: true, running: false,
    workSec: 25*60, restSec: 5*60, remainSec: 25*60,
    interval: null, shuffle: false, playing: false,
    mood: "전체", trackIdx: 0, repeatMode: "off",
    totalCycles: 4, completedCycles: 0,
    todos: JSON.parse(localStorage.getItem("todos-v1")||"[]"),
    theme: localStorage.getItem("theme") || "dark",
    windowVisible: (localStorage.getItem("ui-window-visible") ?? "1") === "1",
    characterVisible: (localStorage.getItem("ui-character-visible") ?? "1") === "1",
    props: JSON.parse(localStorage.getItem("props-v1")||"[]"),
    rotateOn: (localStorage.getItem("rotateOn") ?? "") === "" ? true : (localStorage.getItem("rotateOn") === "1")
  };
  window.state = state;

  /* 새로고침시 타이머 유지 */
  window.addEventListener('beforeunload', ()=>{
    try{
      const snap = {
        mode: state.mode, isWork: state.isWork, running: state.running,
        workSec: state.workSec, restSec: state.restSec, remainSec: state.remainSec,
        totalCycles: state.totalCycles, completedCycles: state.completedCycles
      };
      sessionStorage.setItem('timer-keep', JSON.stringify(snap));
    }catch(e){}
  });

  let __resumeAfterReload = false;
  (function restoreTimerFromSession(){
    const saved = sessionStorage.getItem('timer-keep');
    if(!saved) return;
    try{
      const s = JSON.parse(saved);
      state.mode = s.mode || state.mode;
      state.isWork = !!s.isWork;
      state.workSec = +s.workSec || state.workSec;
      state.restSec = +s.restSec || state.restSec;
      state.remainSec = +s.remainSec || state.remainSec;
      state.totalCycles = +s.totalCycles || state.totalCycles;
      state.completedCycles = +s.completedCycles || 0;
      __resumeAfterReload = !!s.running;
      localStorage.setItem("mode", state.mode);
    }catch(e){}
    sessionStorage.removeItem('timer-keep');
  })();

  const boardList = document.getElementById("todo-list");
  const todoInput = document.getElementById("todo-input");
  const todoAdd   = document.getElementById("todo-add");
  const charImg   = document.getElementById("char-img");
  const winImg    = document.getElementById("win-img");
  const timeEl    = document.getElementById("time");
  const stateEl   = document.getElementById("state");
  const startPause= document.getElementById("startPause");
  const resetBtn  = document.getElementById("reset");
  const cyclesBtn = document.getElementById("cyclesBtn");
  const playPause = document.getElementById("playPause");
  const shuffleBtn= document.getElementById("shuffle");
  const repeatBtn = document.getElementById("repeat");
  const player    = document.getElementById("player");

  const overlay   = document.getElementById("overlay");
  const drawer    = document.getElementById("drawer");
  const hamburgerBtn = document.getElementById("hamburger");
  const closeDrawer  = document.getElementById("closeDrawer");
  const themeToggle  = document.getElementById("themeToggle");
  const moodsWrap    = document.getElementById("moods");
  const tracksWrap   = document.getElementById("tracks");

  const workMin      = document.getElementById("workMin");
  const restMin      = document.getElementById("restMin");
  const totalCyclesInput = document.getElementById("totalCycles");
  const applyPom     = document.getElementById("applyPom");

  const modeRadios   = document.querySelectorAll('input[name="mode"]');
  const pomodoroFields = document.getElementById("pomodoroFields");
  const cyclesWrap   = document.getElementById("cyclesWrap");

  const bgChips      = document.getElementById("bgChips");
  const customBgUrl  = document.getElementById("customBgUrl");
  const applyBg      = document.getElementById("applyBg");
  const customBgFile = document.getElementById("customBgFile");
  const bgFileName   = document.getElementById("bgFileName");
  const bgPreview    = document.getElementById("bgPreview");

  const toggleWindowBtn    = document.getElementById("toggleWindow");
  const toggleCharacterBtn = document.getElementById("toggleCharacter");
  const windowBox          = document.getElementById("window");
  const characterBox       = document.getElementById("character");

  const layoutEditBtn  = document.getElementById("layoutEdit");
  const layoutResetBtn = document.getElementById("layoutReset");
  const rotateToggle   = document.getElementById("rotateToggle");

  const propsLayer   = document.getElementById("propsLayer");
  const propUrl      = document.getElementById("propUrl");
  const propAdd      = document.getElementById("propAdd");
  const propFile     = document.getElementById("propFile");
  const propFileAdd  = document.getElementById("propFileAdd");
  const propFileName = document.getElementById("propFileName");
  const propList     = document.getElementById("propList");
  const propPresets  = document.querySelectorAll(".propPreset");

  const presencePanel = document.getElementById("presencePanel");
  const meNickEl      = document.getElementById("meNick");
  const presenceList  = document.getElementById("presenceList");
  const presenceToggle= document.getElementById("presenceToggle");
  const nicknameInput = document.getElementById("nickname");

  /* 드로어 여닫기 보장 함수 (오버레이 잔존 방지) */
  function openDrawerNow(){
    drawer.classList.add("open");
    overlay.classList.add("show");
    overlay.style.pointerEvents = "auto";
  }
  function closeDrawerNow(){
    drawer.classList.remove("open");
    overlay.classList.remove("show");
    overlay.style.pointerEvents = "none";
  }

  function applyTheme(t){
    document.documentElement.setAttribute("data-theme", t);
    themeToggle.textContent = (t==="dark" ? "🌙" : "☀️");
    localStorage.setItem("theme", t);
  }

  function init(){
    applyTheme(state.theme);

    hamburgerBtn.addEventListener("click", openDrawerNow);
    closeDrawer  .addEventListener("click", closeDrawerNow);
    overlay      .addEventListener("click", closeDrawerNow);
    themeToggle  .addEventListener("click", ()=>{ state.theme = (state.theme==="dark")?"light":"light"===state.theme?"dark":"dark"; applyTheme(state.theme); });

    modeRadios.forEach(r=>{
      r.checked = (r.value === state.mode);
      r.addEventListener('change', ()=>{
        state.mode = r.value;
        localStorage.setItem("mode", state.mode);
        if(state.mode==='timer'){
          state.isWork = true; state.remainSec = 0; state.completedCycles = 0;
        }else{
          state.isWork = true; state.remainSec = state.workSec; state.completedCycles = 0;
        }
        stopTimer(); updateCyclesBtn(); updateTimerUI(); refreshModeFields();
      });
    });
    refreshModeFields();

    workMin.value = Math.round(state.workSec/60);
    restMin.value = Math.round(state.restSec/60);
    totalCyclesInput.value = state.totalCycles;
    updateCyclesBtn();

    const BG_PRESETS = [
      "https://github.com/nihicheli/studywithme/blob/main/image/background%205.png?raw=true",
      "https://github.com/nihicheli/studywithme/blob/main/image/background%206.png?raw=true",
      "https://github.com/nihicheli/studywithme/blob/main/image/background%202.png?raw=true",
      "https://github.com/nihicheli/studywithme/blob/main/image/background%204.png?raw=true",
      "https://github.com/nihicheli/studywithme/blob/main/image/background%203.png?raw=true"
    ];
    BG_PRESETS.forEach((url,i)=>{
      const btn=document.createElement("button");
      btn.className="pill";
      btn.innerHTML=`<img src="${url}" alt="bg${i}" style="width:42px;height:28px;object-fit:cover;border-radius:8px;vertical-align:middle;margin-right:.4rem;border:1px solid var(--line)"> 배경 ${i+1}`;
      btn.addEventListener("click", ()=> setBackground(url));
      bgChips.appendChild(btn);
    });
    applyBg.addEventListener("click", ()=>{ const url=(customBgUrl.value||"").trim(); if(url) setBackground(url); });
    function setBackground(url){ document.documentElement.style.setProperty("--bg-url", `url("${url}")`); }

    customBgFile?.addEventListener("change", ()=>{
      const file = customBgFile.files && customBgFile.files[0];
      if(!file) return;
      bgFileName.textContent = file.name;
      const reader = new FileReader();
      reader.onload = (e)=>{
        const dataUrl = e.target.result;
        bgPreview.style.backgroundImage = `url("${dataUrl}")`;
        setBackground(dataUrl);
      };
      reader.readAsDataURL(file);
    });

    charImg.src = charA; winImg.src = winA;
    blinkTimer = setInterval(()=>{
      showA = !showA; charImg.src = showA ? charA : charB;
      showWinA = !showWinA; winImg.src = showWinA ? winA : winB;
    }, 500);

    renderTodos();
    todoAdd.addEventListener("click", addTodo);
    todoInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") addTodo(); });

    initMoodsAndTracks();

    player.addEventListener("ended", onEnded);
    player.addEventListener("error", ()=>{
      const list = filteredTrackIdxs();
      if(list.length){
        const curPos = list.indexOf(state.trackIdx);
        const n = list[(curPos+1) % list.length];
        selectTrack(n,true);
      }
    });
    repeatBtn.addEventListener("click", toggleRepeat);

    applyPom.addEventListener("click", ()=>{
      if(state.mode === 'pomodoro'){
        const wm=Math.max(1,parseInt(workMin.value||"25",10));
        const rm=Math.max(1,parseInt(restMin.value||"5",10));
        const tc=Math.max(1,parseInt(totalCyclesInput.value||"4",10));
        state.workSec=wm*60; state.restSec=rm*60; state.totalCycles=tc;
        state.isWork=true; state.remainSec=state.workSec; state.completedCycles=0;
      }else{
        state.isWork=true; state.remainSec=0; state.totalCycles=1; state.completedCycles=0;
      }
      stopTimer(); updateCyclesBtn(); updateTimerUI();
    });
    cyclesBtn.addEventListener("click", ()=>{ state.completedCycles=0; updateCyclesBtn(); });

    updateWindowToggleUI();
    updateCharacterToggleUI();
    toggleWindowBtn.addEventListener("click", ()=>{
      state.windowVisible = !state.windowVisible;
      windowBox.style.display = state.windowVisible ? "" : "none";
      localStorage.setItem("ui-window-visible", state.windowVisible ? "1" : "0");
      updateWindowToggleUI();
    });
    toggleCharacterBtn.addEventListener("click", ()=>{
      state.characterVisible = !state.characterVisible;
      characterBox.style.display = state.characterVisible ? "" : "none";
      localStorage.setItem("ui-character-visible", state.characterVisible ? "1" : "0");
      updateCharacterToggleUI();
    });

    setupLayoutDrag();

    /* 회전(간소화: 스케일 호출 제거) */
    function setRotate(on){
      state.rotateOn = !!on;
      localStorage.setItem('rotateOn', state.rotateOn ? "1" : "0");
      rotateToggle.textContent = `회전: ${state.rotateOn ? "켜짐" : "꺼짐"}`;
      applyRotateState();
    }
    function applyRotateState(){
      const portrait = window.innerHeight > window.innerWidth;
      document.documentElement.classList.toggle('portrait-force', state.rotateOn && portrait);
    }
    rotateToggle.addEventListener('click', ()=> setRotate(!state.rotateOn));
    window.addEventListener('resize', applyRotateState);
    window.addEventListener('orientationchange', ()=> setTimeout(applyRotateState, 50));
    // 저장된 값이 없으면: 스마트폰 = 기본 ON, 그 외 = 기본 OFF
    const savedRotate = localStorage.getItem('rotateOn');
    if (savedRotate === null) {
      setRotate(isSmartphone());        // 스마트폰이면 true, 아니면 false
    } else {
      setRotate(savedRotate === '1');   // 사용자가 이전에 선택한 값 유지
    }

    /* 소품 프리셋 */
    document.querySelectorAll('.propPreset').forEach(btn=>
      btn.addEventListener('click', ()=>{
        addProp(btn.dataset.url, true, {autoEdit:true});
        closeDrawerNow();           /* 오버레이 잔존 방지 */
      })
    );

    /* (개선) 소품 파일 선택: 모바일에서도 '선택 즉시 추가' */
    propFile.addEventListener('change', ()=>{
      const f = propFile.files && propFile.files[0];
      propFileName.textContent = f ? f.name : '선택 안 됨';
      if(f){
        const url = URL.createObjectURL(f);
        addProp(url, true, {autoEdit:true});
        // iOS에서 포커스/버튼 문제 방지: 드로어와 오버레이를 확실히 닫기
        closeDrawerNow();
        // 파일 입력 리셋 (같은 파일 재첨부 가능)
        setTimeout(()=>{ propFile.value=""; propFileName.textContent="선택 안 됨"; }, 0);
      }
    });

    /* (유지) 별도의 '파일 추가' 버튼도 제공 */
    propFileAdd.addEventListener('click', ()=>{
      const f = propFile.files && propFile.files[0];
      if(!f) return;
      const url = URL.createObjectURL(f);
      addProp(url, true, {autoEdit:true});
      propFile.value = ""; propFileName.textContent = "선택 안 됨";
      closeDrawerNow();
    });

    propAdd.addEventListener('click', ()=>{
      const u=(propUrl.value||"").trim(); if(!u) return;
      addProp(u, true, {autoEdit:true});
      propUrl.value="";
      closeDrawerNow();
    });

    renderProps();

    function refreshShareStudyUI(){
      shareStudyBtn.textContent = `내 공부시간 공개: ${state.shareStudy ? "켜짐" : "꺼짐"}`;
    }
    shareStudyBtn.addEventListener('click', ()=>{
      state.shareStudy = !state.shareStudy;
      localStorage.setItem('shareStudy', state.shareStudy ? "1" : "0");
      refreshShareStudyUI();
      window.__presence_broadcastNow?.();
    });
    refreshShareStudyUI();

    updateTimerUI();
    if(__resumeAfterReload){ startTimer(); }
  }

  function refreshModeFields(){
    const isPom = (state.mode === 'pomodoro');
    pomodoroFields.style.display = isPom ? '' : 'none';
    cyclesWrap.style.display     = isPom ? '' : 'none';
    stateEl.textContent = isPom ? (state.isWork?"집중중":"휴식중") : "타이머";
  }

  function renderTodos(){
    boardList.innerHTML = "";
    if(state.todos.length === 0) return;
    state.todos.forEach((t,idx)=>{
      const row=document.createElement("div"); row.className="todo";
      const cb=document.createElement("input"); cb.type="checkbox"; cb.checked=!!t.done;
      cb.addEventListener("change",()=>{ t.done=cb.checked; persistTodos(); renderTodos(); });
      const tx=document.createElement("div"); tx.className="txt"; tx.textContent=t.text;
      tx.style.textDecoration=t.done?"line-through":"none"; tx.style.opacity=t.done?".6":"1";
      const del=document.createElement("button"); del.className="del"; del.textContent="삭제";
      del.addEventListener("click",()=>{ state.todos.splice(idx,1); persistTodos(); renderTodos(); });
      row.append(cb,tx,del); boardList.appendChild(row);
    });
  }
  function persistTodos(){ localStorage.setItem("todos-v1", JSON.stringify(state.todos)); }
  function addTodo(){ const v=todoInput.value.trim(); if(!v) return; state.todos.push({text:v,done:false}); todoInput.value=""; persistTodos(); renderTodos(); }

  function MOODS(){ return ["전체","Lo-Fi","Jazz","Loud","Piano","Noise"]; }
  function filteredTrackIdxs(){
    if(state.mood==="전체") return TRACKS.map((_,i)=>i);
    return TRACKS.map((t,i)=> t.mood===state.mood ? i : -1).filter(i=>i>=0);
  }
  function initMoodsAndTracks(){
    moodsWrap.innerHTML = "";
    MOODS().forEach(m=>{
      const b=document.createElement("button");
      b.className="pill"; b.textContent=m; b.dataset.mood=m;
      b.addEventListener("click", ()=>{ state.mood=m; highlightMood(); renderTracks(); });
      moodsWrap.appendChild(b);
    });
    highlightMood();
    renderTracks(true);
  }
  function renderTracks(initial=false){
    tracksWrap.innerHTML = "";
    const idxs = filteredTrackIdxs();
    idxs.forEach(idx=>{
      const t = TRACKS[idx];
      const b=document.createElement("button");
      b.className="pill"; b.textContent=t.title; b.dataset.idx=idx;
      b.addEventListener("click", ()=> selectTrack(idx, state.playing));
      tracksWrap.appendChild(b);
    });
    if(!idxs.includes(state.trackIdx) && idxs.length){
      selectTrack(idxs[0], false);
    }
    highlightTrack();
    if(initial){ selectTrack(idxs[0] ?? 0, false); }
  }
  function selectTrack(idx, autoplay=false){ state.trackIdx=idx; player.src=TRACKS[idx].url; highlightTrack(); if(autoplay) tryPlay(); }
  function tryPlay(){ player.play().then(()=>{ state.playing=true; playPause.textContent="일시정지"; }).catch(()=>{}); }
  function highlightMood(){ [...moodsWrap.children].forEach(b=>{ b.style.boxShadow = (b.dataset.mood===state.mood) ? "inset 0 0 0 1px #7C9AFF" : "none"; }); }
  function highlightTrack(){ [...tracksWrap.children].forEach(b=>{ b.style.boxShadow = (+b.dataset.idx===state.trackIdx) ? "inset 0 0 0 1px #7C9AFF" : "none"; }); }
  document.getElementById("playPause").addEventListener("click", ()=>{
    if(!player.src) selectTrack(state.trackIdx,false);
    if(!state.playing){ tryPlay(); } else { player.pause(); state.playing=false; playPause.textContent="재생"; }
  });
  document.getElementById("shuffle").addEventListener("click", ()=>{ state.shuffle=!state.shuffle; shuffleBtn.textContent=state.shuffle?"랜덤 ON":"랜덤 OFF"; });
  function toggleRepeat(){ const order=["off","one","all"]; const i=order.indexOf(state.repeatMode); state.repeatMode=order[(i+1)%order.length]; updateRepeatUI(); }
  function updateRepeatUI(){ repeatBtn.textContent="반복: "+(state.repeatMode==="off"?"꺼짐":state.repeatMode==="one"?"한곡":"전체"); player.loop=(state.repeatMode==="one"); }
  updateRepeatUI();
  function onEnded(){
    if(state.repeatMode==="one") return;
    const list = filteredTrackIdxs();
    if(state.shuffle){
      let n = state.trackIdx;
      if(list.length>1){
        while(n===state.trackIdx) n = list[Math.floor(Math.random()*list.length)];
      }
      selectTrack(n,true); return;
    }
    if(state.repeatMode==="all" && list.length){
      const cur = list.indexOf(state.trackIdx);
      const n = list[(cur+1)%list.length];
      selectTrack(n,true); return;
    }
    state.playing=false; playPause.textContent="재생";
  }

  function fmt(sec){
    const s=Math.max(0,sec|0);
    const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), ss=s%60;
    const mm=m.toString().padStart(2,'0'); const s2=ss.toString().padStart(2,'0');
    return h>0?`${h}:${mm}:${s2}`:`${mm}:${s2}`;
  }
  function updateTimerUI(){
    timeEl.textContent=fmt(state.remainSec);
    stateEl.textContent=(state.mode==='pomodoro') ? (state.isWork?"집중중":"휴식중") : "타이머";
    startPause.textContent=state.running?"일시정지":"시작";
    document.title = `${fmt(state.remainSec)} • Studywithme`;
    window.__presence_broadcastNow?.();
  }
  function beep(){ try{ const ctx=new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(); const g=ctx.createGain(); o.connect(g); g.connect(ctx.destination);
    o.type="sine"; o.frequency.value=880; g.gain.setValueAtTime(.0001,ctx.currentTime); g.gain.exponentialRampToValueAtTime(.3,ctx.currentTime+.01); o.start(); g.gain.exponentialRampToValueAtTime(.0001,ctx.currentTime+.25); o.stop(ctx.currentTime+.3);}catch{} }
  function startTimer(){
    if(state.running) return;
    state.running=true; updateTimerUI();
    state.interval=setInterval(()=>{
      if(state.mode==='pomodoro'){
        if(state.remainSec<=0){
          beep();
          const wasWork=state.isWork;
          state.isWork=!state.isWork;
          state.remainSec=state.isWork?state.workSec:state.restSec;
          if(state.isWork && !wasWork){
            state.completedCycles=Math.min(state.totalCycles, state.completedCycles+1);
            updateCyclesBtn();
            if(state.completedCycles>=state.totalCycles){ stopTimer(); }
          }
        } else {
          state.remainSec-=1;
        }
      }else{
        state.remainSec+=1;
      }
      updateTimerUI();
    },1000);
  }
  function stopTimer(){ state.running=false; if(state.interval){ clearInterval(state.interval); state.interval=null; } updateTimerUI(); }
  function resetTimer(){
    stopTimer();
    state.isWork=true;
    state.remainSec = (state.mode==='pomodoro') ? state.workSec : 0;
    updateTimerUI();
  }
  document.getElementById("startPause").addEventListener("click", ()=> state.running?stopTimer():startTimer());
  document.getElementById("reset").addEventListener("click", resetTimer);
  function updateCyclesBtn(){ cyclesBtn.textContent = `${state.completedCycles}/${state.totalCycles}회`; }

  function updateWindowToggleUI(){ toggleWindowBtn.textContent = `창문: ${state.windowVisible ? "보임" : "숨김"}`; windowBox.style.display = state.windowVisible ? "" : "none"; }
  function updateCharacterToggleUI(){ toggleCharacterBtn.textContent = `캐릭터: ${state.characterVisible ? "보임" : "숨김"}`; characterBox.style.display = state.characterVisible ? "" : "none"; }

  function setupLayoutDrag(){
    const APP = document.getElementById('app');
    const DRAG_IDS = ['timer','board','window','character','music-controls'];
    const RESIZE_IDS = ['window','character'];
    const Z_TOP_CAP = 8999;

    const registry = new Map();
    let editOn = false;
    let zTop = 100;

    const posKey = id => `pos-${id}`;

    function restorePositionsOnLoad(){
      DRAG_IDS.forEach(id=>{
        const el = document.getElementById(id);
        if(!el) return;
        const saved = localStorage.getItem(posKey(id));
        if(saved){
          const {left, top, width} = JSON.parse(saved);
          absolutize(el);
          place(el, left, top, width);
        }
      });
    }

    function absolutize(el){
      if(registry.has(el.id)) return;
      const rect = el.getBoundingClientRect();
      const appRect = APP.getBoundingClientRect();

      const ph = document.createElement('div');
      ph.style.width  = rect.width + 'px';
      ph.style.height = rect.height + 'px';
      ph.style.visibility = 'hidden';
      el.parentNode.insertBefore(ph, el);

      el.style.position = 'absolute';
      el.style.width    = rect.width + 'px';
      el.style.left     = (rect.left - appRect.left + window.scrollX) + 'px';
      el.style.top      = (rect.top  - appRect.top  + window.scrollY) + 'px';
      el.style.zIndex   = (parseInt(el.style.zIndex||'10',10));
      APP.appendChild(el);

      if(el.classList.contains('resizable') && !el.querySelector('.resizer')){
        const rz = document.createElement('div');
        rz.className = 'resizer';
        el.appendChild(rz);
      }

      registry.set(el.id, {el, placeholder: ph});
    }

    function place(el, left, top, width){
      if(width) el.style.width = width + 'px';
      el.style.left = left + 'px';
      el.style.top  = top  + 'px';
    }

    function setEditable(on){
      editOn = on;
      document.getElementById('app').classList.toggle('edit-on', on);
      layoutEditBtn.textContent = `배치 편집: ${on ? '켜짐' : '꺼짐'}`;

      DRAG_IDS.forEach(id=>{
        const el = document.getElementById(id);
        if(!el) return;

        if(on){
          if(!registry.has(id)) absolutize(el);
          el.classList.add('draggable');
          enableDrag(el);
          if(RESIZE_IDS.includes(id)) enableResize(el);
        }else{
          el.classList.remove('draggable');
          disableDrag(el);
          if(RESIZE_IDS.includes(id)) disableResize(el);
        }
      });

      document.querySelectorAll('.prop').forEach(el=>{
        if(on){ enableDrag(el); enableResize(el); }
        else  { disableDrag(el); disableResize(el); }
      });
    }

    window.__layoutSetEditable = setEditable;
    window.__layoutFocus = (pid)=>{
      const el = document.querySelector(`.prop[data-pid="${pid}"]`);
      if(!el) return;
      el.style.zIndex = Math.min(++zTop, Z_TOP_CAP);
      el.classList.add('selected');
      setTimeout(()=> el.classList.remove('selected'), 1500);
      el.scrollIntoView?.({behavior:'smooth', block:'center', inline:'center'});
    };

    function enableDrag(el){
      if(el._dragBound) return;
      const onDown = (e)=>{
        if(!editOn) return;
        if(e.target.classList && e.target.classList.contains('resizer')) return;

        e.preventDefault();
        el.classList.add('dragging');
        el.style.zIndex = Math.min(++zTop, Z_TOP_CAP);

        const startX = (e.touches? e.touches[0].clientX : e.clientX);
        const startY = (e.touches? e.touches[0].clientY : e.clientY);
        const startLeft = parseFloat(el.style.left)||0;
        const startTop  = parseFloat(el.style.top)||0;

        const move = (ev)=>{
          const cx = (ev.touches? ev.touches[0].clientX : ev.clientX);
          const cy = (ev.touches? ev.touches[0].clientY : ev.clientY);
          const dx = cx - startX;
          const dy = cy - startY;
          place(el, startLeft + dx, startTop + dy);
        };
        const up = ()=>{
          document.removeEventListener('pointermove', move);
          document.removeEventListener('pointerup', up);
          document.removeEventListener('touchmove', move);
          document.removeEventListener('touchend', up);
          el.classList.remove('dragging');
          persistPos(el);
        };

        document.addEventListener('pointermove', move);
        document.addEventListener('pointerup', up);
        document.addEventListener('touchmove', move, {passive:false});
        document.addEventListener('touchend', up);
      };
      el.addEventListener('pointerdown', onDown);
      el.addEventListener('touchstart', onDown, {passive:false});
      el._dragBound = onDown;
    }
    function disableDrag(el){
      if(!el._dragBound) return;
      el.removeEventListener('pointerdown', el._dragBound);
      el.removeEventListener('touchstart', el._dragBound);
      delete el._dragBound;
    }

    function enableResize(el){
      if(el._resizeBound) return;
      const onDown = (e)=>{
        if(!editOn) return;
        if(!e.target.classList || !e.target.classList.contains('resizer')) return;
        e.preventDefault();
        el.classList.add('dragging');
        el.style.zIndex = Math.min(++zTop, Z_TOP_CAP);

        const startX = (e.touches? e.touches[0].clientX : e.clientX);
        const startWidth = parseFloat(el.style.width) || el.getBoundingClientRect().width;

        const move = (ev)=>{
          const cx = (ev.touches? ev.touches[0].clientX : ev.clientX);
          const dx = cx - startX;
          const newW = Math.max(120, startWidth + dx);
          el.style.width = newW + 'px';
        };
        const up = ()=>{
          document.removeEventListener('pointermove', move);
          document.removeEventListener('pointerup', up);
          document.removeEventListener('touchmove', move);
          document.removeEventListener('touchend', up);
          el.classList.remove('dragging');
          persistPos(el);
        };

        document.addEventListener('pointermove', move);
        document.addEventListener('pointerup', up);
        document.addEventListener('touchmove', move);
        document.addEventListener('touchend', up);
      };
      el.addEventListener('pointerdown', onDown);
      el.addEventListener('touchstart', onDown, {passive:false});
      el._resizeBound = onDown;
    }
    function disableResize(el){
      if(!el._resizeBound) return;
      el.removeEventListener('pointerdown', el._resizeBound);
      el.removeEventListener('touchstart', el._resizeBound);
      delete el._resizeBound;
    }

    function persistPos(el){
      const left = parseFloat(el.style.left)||0;
      const top  = parseFloat(el.style.top)||0;
      const width= parseFloat(el.style.width)||el.getBoundingClientRect().width;

      if(el.classList.contains('prop')){
        const id = el.dataset.pid;
        const idx = state.props.findIndex(p=>p.id===id);
        if(idx>=0){ state.props[idx].left=left; state.props[idx].top=top; state.props[idx].width=width; }
        localStorage.setItem('props-v1', JSON.stringify(state.props));
      }else{
        localStorage.setItem(`pos-${el.id}`, JSON.stringify({left, top, width}));
      }
    }

    layoutResetBtn.addEventListener('click', ()=>{
      const snap = {
        mode: state.mode, isWork: state.isWork, running: state.running,
        workSec: state.workSec, restSec: state.restSec, remainSec: state.remainSec,
        totalCycles: state.totalCycles, completedCycles: state.completedCycles
      };
      sessionStorage.setItem('timer-keep', JSON.stringify(snap));

      DRAG_IDS.forEach(id=> localStorage.removeItem(`pos-${id}`));
      localStorage.removeItem('props-v1');
      localStorage.removeItem('ui-window-visible');
      localStorage.removeItem('ui-character-visible');
      location.reload();
    });

    layoutEditBtn.addEventListener('click', ()=> setEditable(!editOn));
    restorePositionsOnLoad();
  }

  function renderProps(){
    propsLayer.innerHTML = '';
    state.props.forEach(p=>{
      const el = document.createElement('div');
      el.className = 'prop resizable';
      el.dataset.pid = p.id;
      el.style.left = (p.left ?? 40) + 'px';
      el.style.top  = (p.top  ?? 40) + 'px';
      el.style.width= (p.width?? 120) + 'px';
      el.style.zIndex = 80;

      const img = document.createElement('img');
      img.src = p.url; img.alt = 'prop';
      el.appendChild(img);

      const rz = document.createElement('div'); rz.className='resizer'; el.appendChild(rz);
      propsLayer.appendChild(el);
    });
    renderPropList();
  }
  function renderPropList(){
    propList.innerHTML = '';
    state.props.forEach(p=>{
      const row = document.createElement('div'); row.className='todo';
      const tx  = document.createElement('div'); tx.className='txt';
      tx.innerHTML = `<img src="${p.url}" style="width:28px;height:28px;object-fit:contain;vertical-align:middle;margin-right:.5rem"> ${p.id}`;
      const del = document.createElement('button'); del.className='del'; del.textContent='삭제';
      del.addEventListener('click', ()=>{
        const idx = state.props.findIndex(x=>x.id===p.id);
        if(idx>=0) state.props.splice(idx,1);
        localStorage.setItem('props-v1', JSON.stringify(state.props));
        renderProps();
      });
      row.append(tx, del);
      propList.appendChild(row);
    });
  }
  function addProp(url, center=true, opts={}){
    const id = 'prop-' + Date.now().toString(36);
    const MINW = 120;
    let left=40, top=40, width=MINW;
    if(center){
      const appRect = document.getElementById('app').getBoundingClientRect();
      left = Math.max(0, Math.floor((appRect.width - width)/2));
      top  = Math.max(0, Math.floor((appRect.height - width)/2));
    }
    state.props.push({id, url, left, top, width});
    localStorage.setItem('props-v1', JSON.stringify(state.props));
    renderProps();

    if(opts.autoEdit){
      window.__layoutSetEditable?.(true);
      setTimeout(()=> window.__layoutFocus?.(id), 0);
    }
  }

  init();
</script>

<!-- ===== Supabase Presence (실시간) ===== -->
<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

/* 사용자가 제공한 환경변수 (교체 완료) */
const SUPABASE_URL = "https://jvpasqknlkeyshrevqpg.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2cGFzcWtubGtleXNocmV2cXBnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwNDQyOTMsImV4cCI6MjA3NDYyMDI5M30.7zKRGoBFjoWksoRXjUj8n4KzLXdiF86lZwneNdZNF5k";

const presencePanel = document.getElementById("presencePanel");
const meNickEl      = document.getElementById("meNick");
const presenceList  = document.getElementById("presenceList");
const presenceToggle= document.getElementById("presenceToggle");
const nicknameInput = document.getElementById("nickname");
// --- smartphone detector (여기에 추가) ---
function isSmartphone(){
  const ua = navigator.userAgent || navigator.vendor || window.opera || "";
  const looksMobileUA = /iPhone|iPod|Android.+Mobile|Mobi/i.test(ua);
  const smallViewport = Math.min(window.innerWidth, window.innerHeight) <= 820; // 태블릿 제외용 여유값
  return looksMobileUA && smallViewport;
}

  
let supabase = null;
let channel  = null;
let heartbeat= null;

/* 기본 ON: 로드 시 자동 연결 */
window.addEventListener('load', ()=>{ if(cfgReady()) goOnline(); });

function cfgReady(){
  return SUPABASE_URL.startsWith("https://") && !!SUPABASE_ANON_KEY;
}
function getSnapshot(){
  const st = window.state || {};
  let study = null;
  if(st.shareStudy){
    if(st.mode==='timer'){
      study = st.remainSec||0;
    }else if(st.mode==='pomodoro' && st.isWork){
      study = Math.max(0,(st.workSec|0) - (st.remainSec|0));
    }
  }
  const status = (st.mode==='pomodoro') ? (st.isWork ? "work" : "break") : "timer";
  return { status, study };
}
function fmtMin(sec){ return `${Math.floor((sec|0)/60)}분`; }

function renderOnline(presenceState){
  const items = [];
  for(const [nick, metas] of Object.entries(presenceState)){
    const meta = metas[metas.length-1] || {};
    const status = meta?.status || "idle";
    const study  = typeof meta?.study  === "number" ? meta.study  : null;

    let rightTxt = "";
    if(status === "break"){
      rightTxt = "휴식중";
    }else{
      rightTxt = "공부중";
      if(study!=null) rightTxt += ` · ${fmtMin(study)}`;
    }

    items.push(
      `<div class="person">
         <div><span class="${status==="work"?"dot work":status==="break"?"dot break":"dot"}"></span><span class="nick">${nick}</span></div>
         <div style="opacity:.8">${rightTxt}</div>
       </div>`
    );
  }
  presenceList.innerHTML = items.slice(0,5).join("") || `<div style="opacity:.8">아직 아무도 없어요</div>`;
}

window.__presence_broadcastNow = async function(){
  if(!channel) return;
  try{ await channel.track(getSnapshot()); }catch{}
};
window.__presence_goOnline = goOnline;
window.__presence_goOffline = goOffline;

async function goOnline(){
  if(!cfgReady()){ return; }
  if(!supabase) supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const myNick = (nicknameInput.value || "").trim() || "anonymous";
  meNickEl.textContent = myNick;
  presencePanel.style.display = "block";

  channel = supabase.channel("studyroom", { config: { presence: { key: myNick } } });
  channel.on("presence", { event: "sync" }, ()=>{ renderOnline(channel.presenceState()); });

  channel.subscribe(async (status)=>{
    if(status === "SUBSCRIBED"){
      try{ await channel.track(getSnapshot()); }catch{}
      heartbeat = setInterval(async ()=>{ try{ await channel.track(getSnapshot()); }catch{} }, 15000);
    }
  });

  presenceToggle.textContent = "공개: 켜짐";
}
async function goOffline(){
  if(heartbeat){ clearInterval(heartbeat); heartbeat = null; }
  if(channel){ try{ await channel.unsubscribe(); }catch{} }
  channel = null;
  presenceToggle.textContent = "공개: 꺼짐";
  presencePanel.style.display = "none";
  presenceList.innerHTML = "";
}

presenceToggle?.addEventListener("click", async ()=>{
  if(!channel){ await goOnline(); } else { await goOffline(); }
});
</script>
</body>
</html>
