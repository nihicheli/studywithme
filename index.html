<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ê°ê°ì ì¸ ë½€ëª¨ë„ë¡œ</title>
<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand:wght@400&family=Nanum+Pen+Script&display=swap" rel="stylesheet">
<style>
  :root{
    --bg-url: url("https://github.com/nihicheli/studywithme/blob/main/image/background%205.png?raw=true");
    --ink: #FBFFF4; --ink-sub: rgba(0,0,0,.7); --line: transparent;
    --top-gap:12px; --content-top:20vh;
    --maxh-board:80vh; --maxh-timer:35vh; --maxh-window:40vh; --maxh-char:50vh;
    --maxw-board:25vw; --maxw-window:15vw; --maxw-timer:35vw; --maxw-char:70vw;
  }
  :root[data-theme="light"]{ --ink:#202020; --ink-sub:rgba(0,0,0,.7); --line:transparent; }

  *{box-sizing:border-box}
  html,body{ height:100%; margin:0; color:var(--ink);
    font-family:"Patrick Hand","Nanum Pen Script",system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Arial,sans-serif;
    background:#000; font-size:clamp(12px,1.6vw,14px); letter-spacing:.02em; }

  /* 10% ê²€ì • ì˜¤ë²„ë ˆì´ ìœ ì§€ */
  #app{ position:relative; height:100dvh; overflow:hidden;
    background-image: linear-gradient(rgba(0,0,0,.10), rgba(0,0,0,.10)), var(--bg-url);
    background-size:cover; background-position:center; }

  .card{ background:rgba(0,0,0,.02); border:2px solid var(--line); border-radius:16px; }
  .panel{ padding:1rem; }

  button,.pill{ cursor:pointer; user-select:none; background:rgba(255,255,255,.08); color:var(--ink);
    border:1px solid var(--line); border-radius:999px; padding:.6rem .9rem; font-weight:700; font-family:inherit; font-size:1rem; outline:none; }
  button:focus,.pill:focus,button:focus-visible,.pill:focus-visible{ outline:none; box-shadow:inset 0 0 0 1px #7C9AFF; }
  *{-webkit-tap-highlight-color:transparent}
  input,textarea,select{ font-family:inherit; font-size:1rem; color:#fff }

  .row{display:flex; gap:.75rem; align-items:center}
  .hwrap{ display:flex; gap:.5rem; align-items:center; overflow-x:auto; }
  .title{font-weight:900; font-size:1.125rem}

  #topbar{ position:absolute; left:12px; right:12px; top:var(--top-gap);
    display:grid; grid-template-columns:1fr auto 1fr; align-items:start; gap:12px; z-index:10; }
  #hamburger{ justify-self:start; width:3.4rem; height:3.4rem; display:grid; place-items:center; font-size:1.2rem; }

  #timer{ justify-self:center; width:min(var(--maxw-timer),90vw); max-height:var(--maxh-timer);
    display:flex; flex-direction:column; align-items:center; gap:.6rem; text-align:center; overflow:hidden; }
  #state{ font-size:1.25rem; font-weight:900; }
  #time{ font-weight:900; font-size:clamp(2.2rem,6vw,4rem); line-height:1; }

  #board{ justify-self:end; width:min(var(--maxw-board),92vw); max-height:var(--maxh-board);
    display:grid; grid-template-rows:auto 1fr auto; overflow:hidden; }
  #board .title{margin:0 0 .5rem 0}
  #todo-list{ overflow:auto; padding-right:2px; scrollbar-width:thin; }
  .todo{display:flex; align-items:center; gap:.5rem; padding:.45rem 0; border-bottom:1px solid rgba(255,255,255,.15)}
  .todo:last-child{border-bottom:0}
  .todo .txt{flex:1}
  .todo .del{background:transparent; border:0; color:var(--ink-sub); padding:.3rem .5rem; border-radius:.6rem}
  .todo .del:hover{background:rgba(255,255,255,.12); color:#fff}
  #inputRow{ display:flex; gap:.5rem; align-items:center; padding-top:.6rem; }
  #board input[type="text"]{ width:100%; background:transparent; border:2px solid var(--line); border-radius:12px; color:#fff; padding:.5rem .6rem }

  #window{ position:absolute; left:2vw; top:var(--content-top); z-index:5; width:min(var(--maxw-window),90vw) }
  #win-img{ display:block; width:100%; height:auto; max-height:var(--maxh-window); border-radius:16px; border:2px solid var(--line) }

  #character{ position:absolute; left:50%; transform:translateX(-50%);
    top:calc(var(--content-top) + 20vh); z-index:6; width:min(var(--maxw-char),96vw) }
  #char-img{ display:block; width:100%; height:auto; max-height:var(--maxh-char); border-radius:18px; border:2px solid var(--line);
    background:transparent center/contain no-repeat; }

  #bottombar{ position:fixed; left:12px; right:12px; bottom:8px; display:flex; gap:12px; justify-content:center; align-items:flex-end; z-index:12; }
  #bottombar .card{ flex:1 1 0; min-width:260px; }
  #bottombar h4{ margin:0 0 .5rem 0; font-size:1.125rem; font-weight:900 }

  #overlay{ position:fixed; inset:0; background:rgba(0,0,0,.35); opacity:0; pointer-events:none; transition:opacity .2s ease; z-index:50; }
  #overlay.show{ opacity:1; pointer-events:auto; }

  #drawer{ position:fixed; top:0; left:0; bottom:0; width:min(380px,86vw); background:#111; color:#eee; border-right:2px solid var(--line);
    transform:translateX(-100%); transition:transform .24s ease; z-index:60; display:flex; flex-direction:column; gap:0; overflow-y:auto; }
  :root[data-theme="light"] #drawer{ background:#fafafa; color:#222; }
  #drawer.open{ transform:translateX(0) }
  .drawer-head{ display:flex; align-items:center; justify-content:space-between; padding:1rem; border-bottom:2px solid var(--line); }
  .drawer-sec{ padding:1rem; border-bottom:2px dashed rgba(255,255,255,.12); }
  :root[data-theme="light"] .drawer-sec{ border-bottom-color: rgba(0,0,0,.12); }
  .drawer-sec h4{ margin:.2rem 0 .8rem; font-weight:900; }

  .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:.5rem; }
  .drawer-sec input[type="number"], .drawer-sec input[type="text"]{
    width:100%; padding:.55rem .7rem; border:2px solid var(--line); border-radius:12px; background:transparent; color:#fff;
  }
  :root[data-theme="light"] .drawer-sec input[type="number"], :root[data-theme="light"] .drawer-sec input[type="text"]{ color:#222; }
  .fill{ flex:1 }

  .chips{ display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
  .chips .pill{ border:1px solid var(--line); border-radius:14px; padding:.5rem .75rem; background:rgba(255,255,255,.06); transition:background .15s ease; }
  .chips .pill:hover{ background:rgba(255,255,255,.12); }
  .list-scroll{ max-height:40vh; overflow:auto; padding-bottom:.25rem; }
  .list-scroll::-webkit-scrollbar{ width:10px; height:10px; }
  .list-scroll::-webkit-scrollbar-thumb{ background:rgba(255,255,255,.22); border-radius:999px; }

  a#creditLink{ color:#9db7ff; text-decoration:none; border-bottom:1px dashed #9db7ff; }
  a#creditLink:hover{ opacity:.85; }

  .pill-input{ width:100%; padding:.6rem .9rem; border:1px solid var(--line); border-radius:999px; background:rgba(255,255,255,.08);
    color:#fff; line-height:1; outline:none; transition:background .15s ease, box-shadow .15s ease; -webkit-appearance:none; }
  .pill-input::placeholder{ color:rgba(255,255,255,.6) }
  :root[data-theme="light"] .pill-input{ background:rgba(0,0,0,.06); color:#222 }
  :root[data-theme="light"] .pill-input::placeholder{ color:rgba(0,0,0,.5) }
  .pill-input:focus{ box-shadow: inset 0 0 0 3px #7C9AFF; background:rgba(124,154,255,.15) }
  .drawer-sec .row .pill-input{ flex:1; min-width:0 }

  @media (max-width:720px){
    :root{ --content-top:14vh; --maxw-char:90vw; }
    #bottombar{ flex-direction:column; }
    #bottombar .card{ width:100%; }
  }
</style>
</head>
<body>
<div id="app">

  <!-- ì˜¤ë²„ë ˆì´ + ë“œë¡œì–´(ì„¤ì •) -->
  <div id="overlay"></div>
  <aside id="drawer" aria-label="ì„¤ì •">
    <header class="drawer-head">
      <h3 style="margin:0">ì„¤ì •</h3>
      <div class="row">
        <button id="themeToggle" class="pill" title="ë‹¤í¬/ë¼ì´íŠ¸ ì „í™˜">ğŸŒ™</button>
        <button id="closeDrawer" class="pill">ë‹«ê¸°</button>
      </div>
    </header>

    <section class="drawer-sec">
      <h4>ë½€ëª¨ë„ë¡œ</h4>
      <div class="grid2">
        <label>ì§‘ì¤‘(ë¶„)<input id="workMin" type="number" min="1" value="25"></label>
        <label>íœ´ì‹(ë¶„)<input id="restMin" type="number" min="1" value="5"></label>
      </div>
      <label style="display:block; margin-top:.5rem">ì‚¬ì´í´ ìˆ˜(NíšŒ)
        <input id="totalCycles" type="number" min="1" value="4">
      </label>
      <div class="row" style="margin-top:.6rem">
        <button id="applyPom" class="pill">ì ìš©</button>
      </div>
    </section>

    <section class="drawer-sec">
      <h4>ìŒì•… ìŠ¤íƒ€ì¼</h4>
      <div id="moods" class="chips list-scroll"></div>
    </section>

    <section class="drawer-sec">
      <h4>ê³¡ ì„ íƒ</h4>
      <div id="tracks" class="chips list-scroll"></div>
    </section>

    <!-- âœ… ì¶”ê°€: í™”ë©´ í‘œì‹œ ì„¹ì…˜ (ì°½ë¬¸ í† ê¸€) -->
    <section class="drawer-sec">
      <h4>í™”ë©´ í‘œì‹œ</h4>
      <button id="toggleWindow" class="pill">ì°½ë¬¸: ë³´ì„</button>
    </section>

    <section class="drawer-sec">
      <h4>ë°°ê²½ ì„ íƒ (ì–´ë‘ìš´ ê³„ì—´)</h4>
      <div id="bgChips" class="chips"></div>
      <div class="row" style="margin-top:.5rem">
        <input id="customBgUrl" placeholder="ë°°ê²½ ì´ë¯¸ì§€ URL ë¶™ì—¬ë„£ê¸°" class="fill pill-input">
        <button id="applyBg" class="pill">ì ìš©</button>
      </div>
    </section>

    <section class="drawer-sec">
      <h4>Credits</h4>
      <a id="creditLink" href="#" target="_blank" rel="noopener">Made by do</a>
    </section>
  </aside>

  <!-- ìƒë‹¨ -->
  <div id="topbar">
    <button id="hamburger" class="card panel" aria-label="ë©”ë‰´ ì—´ê¸°">â‹¯</button>

    <section id="timer" class="card panel" aria-label="íƒ€ì´ë¨¸">
      <div id="state">ì§‘ì¤‘ì¤‘</div>
      <div id="time">25:00</div>
      <div class="row">
        <button class="pill" id="startPause">ì‹œì‘</button>
        <button class="pill" id="reset">ë¦¬ì…‹</button>
        <button class="pill" id="cyclesBtn" title="ì‚¬ì´í´ ì§„í–‰ ìƒí™©">0/4íšŒ</button>
      </div>
    </section>

    <section id="board" class="card panel" aria-label="Todo list">
      <div class="title">Todo list</div>
      <div id="todo-list"></div>
      <div id="inputRow">
        <input id="todo-input" type="text" placeholder="í•  ì¼ì„ ì ê³  Enter" />
        <button id="todo-add" class="pill" title="ì¶”ê°€">ï¼‹</button>
      </div>
    </section>
  </div>

  <!-- ë©”ì¸: ì°½ë¬¸(ì¢Œ) + ìºë¦­í„°(ì¤‘ì•™) -->
  <div id="window"><img id="win-img" alt="ì°½ë¬¸" /></div>
  <div id="character"><img id="char-img" alt="ìºë¦­í„°" /></div>

  <!-- í•˜ë‹¨: ìŒì•… ì¬ìƒ -->
  <div id="bottombar">
    <section id="music-controls" class="card panel" aria-label="ìŒì•… ì¬ìƒ">
      <h4>ìŒì•… ì¬ìƒ</h4>
      <div class="hwrap">
        <button class="pill" id="playPause">ì¬ìƒ</button>
        <button class="pill" id="shuffle">ëœë¤ OFF</button>
        <button class="pill" id="repeat">ë°˜ë³µ: êº¼ì§</button>
      </div>
      <audio id="player" preload="metadata"></audio>
    </section>
  </div>
</div>

<script>
  const TRACKS = [
    { title:"Bass Meant Jazz", mood:"Jazz", url:"https://freepd.com/music/Bass%20Meant%20Jazz.mp3" },
    { title:"Stompin at Midnight", mood:"Jazz", url:"https://freepd.com/music/Stompin%20at%20Midnight.mp3" },
    { title:"Abstract Anxiety", mood:"Loud", url:"https://freepd.com/music/Abstract%20Anxiety.mp3" },
    { title:"Adding the Sun", mood:"Lo-Fi", url:"https://freepd.com/music/Adding%20the%20Sun.mp3" },
    { title:"Bleu", mood:"Lo-Fi", url:"https://freepd.com/music/Bleu.mp3" },
    { title:"Study and Relax", mood:"Lo-Fi", url:"https://freepd.com/music/Study%20and%20Relax.mp3" },
    { title:"Deep Focus", mood:"Lo-Fi", url:"https://freepd.com/music/Deep%20Focus.mp3" },
    { title:"White Noise", mood:"Noise", url:"https://archive.org/download/TenMinutesOfWhiteNoisePinkNoiseAndBrownianNoise/WhiteNoise_64kb.mp3" },
    { title:"Pink Noise",  mood:"Noise", url:"https://archive.org/download/TenMinutesOfWhiteNoisePinkNoiseAndBrownianNoise/PinkNoise_64kb.mp3" },
    { title:"Brown Noise", mood:"Noise", url:"https://archive.org/download/TenMinutesOfWhiteNoisePinkNoiseAndBrownianNoise/BrownianNoise_64kb.mp3" }
  ];

  let charA="https://github.com/nihicheli/studywithme/blob/main/image/Group%209213.png?raw=true";
  let charB="https://github.com/nihicheli/studywithme/blob/main/image/Group%209214.png?raw=true";
  let winA ="https://github.com/nihicheli/studywithme/blob/main/image/Group%209215.png?raw=true";
  let winB ="https://github.com/nihicheli/studywithme/blob/main/image/Group%209216.png?raw=true";
  let showA=true, showWinA=true, blinkTimer=null;

  const state = {
    isWork:true, running:false, workSec:25*60, restSec:5*60, remainSec:25*60,
    interval:null, shuffle:false, playing:false, mood:"Lo-Fi", trackIdx:0,
    repeatMode:"off", totalCycles:4, completedCycles:0,
    todos: JSON.parse(localStorage.getItem("todos-v1")||"[]"),
    theme: localStorage.getItem("theme") || "dark",
    windowVisible: true   // âœ… ì°½ë¬¸ í‘œì‹œ ìƒíƒœ ì¶”ê°€
  };

  const boardList=document.getElementById("todo-list");
  const todoInput=document.getElementById("todo-input");
  const todoAdd=document.getElementById("todo-add");
  const charImg=document.getElementById("char-img");
  const winImg=document.getElementById("win-img");
  const timeEl=document.getElementById("time");
  const stateEl=document.getElementById("state");
  const startPause=document.getElementById("startPause");
  const resetBtn=document.getElementById("reset");
  const cyclesBtn=document.getElementById("cyclesBtn");
  const playPause=document.getElementById("playPause");
  const shuffleBtn=document.getElementById("shuffle");
  const repeatBtn=document.getElementById("repeat");
  const player=document.getElementById("player");

  const overlay=document.getElementById("overlay");
  const drawer=document.getElementById("drawer");
  const hamburgerBtn=document.getElementById("hamburger");
  const closeDrawer=document.getElementById("closeDrawer");
  const themeToggle=document.getElementById("themeToggle");
  const moodsWrap=document.getElementById("moods");
  const tracksWrap=document.getElementById("tracks");
  const workMin=document.getElementById("workMin");
  const restMin=document.getElementById("restMin");
  const totalCyclesInput=document.getElementById("totalCycles");
  const applyPom=document.getElementById("applyPom");
  const bgChips=document.getElementById("bgChips");
  const customBgUrl=document.getElementById("customBgUrl");
  const applyBg=document.getElementById("applyBg");
  const creditLink=document.getElementById("creditLink");

  // âœ… ìƒˆ ìš”ì†Œ: ì°½ë¬¸ í† ê¸€ ë²„íŠ¼
  const toggleWindowBtn = document.getElementById("toggleWindow");
  const windowBox = document.getElementById("window");

  function applyTheme(t){
    document.documentElement.setAttribute("data-theme", t);
    themeToggle.textContent = (t==="dark" ? "ğŸŒ™" : "â˜€ï¸");
    localStorage.setItem("theme", t);
  }

  function init(){
    applyTheme(state.theme);

    hamburgerBtn.addEventListener("click", ()=>{ drawer.classList.add("open"); overlay.classList.add("show"); });
    closeDrawer.addEventListener("click", ()=>{ drawer.classList.remove("open"); overlay.classList.remove("show"); });
    overlay.addEventListener("click", ()=>{ drawer.classList.remove("open"); overlay.classList.remove("show"); });

    themeToggle.addEventListener("click", ()=>{ state.theme = (state.theme==="dark")?"light":"dark"; applyTheme(state.theme); });

    workMin.value=Math.round(state.workSec/60);
    restMin.value=Math.round(state.restSec/60);
    totalCyclesInput.value=state.totalCycles;
    updateCyclesBtn();

    const BG_PRESETS=[
      "https://github.com/nihicheli/studywithme/blob/main/image/background%205.png?raw=true",
      "https://github.com/nihicheli/studywithme/blob/main/image/background%206.png?raw=true",
      "https://github.com/nihicheli/studywithme/blob/main/image/background%202.png?raw=true",
      "https://github.com/nihicheli/studywithme/blob/main/image/background%204.png?raw=true",
      "https://github.com/nihicheli/studywithme/blob/main/image/background%203.png?raw=true"
    ];
    BG_PRESETS.forEach((url,i)=>{
      const btn=document.createElement("button");
      btn.className="pill";
      btn.innerHTML=`<img src="${url}" alt="bg${i}" style="width:42px;height:28px;object-fit:cover;border-radius:8px;vertical-align:middle;margin-right:.4rem;border:1px solid var(--line)"> ë°°ê²½ ${i+1}`;
      btn.addEventListener("click", ()=> setBackground(url));
      bgChips.appendChild(btn);
    });
    applyBg.addEventListener("click", ()=>{ const url=(customBgUrl.value||"").trim(); if(url) setBackground(url); });
    function setBackground(url){ document.documentElement.style.setProperty("--bg-url", `url("${url}")`); }

    // ì´ë¯¸ì§€ êµì°¨(0.5s)
    charImg.src = charA; winImg.src = winA;
    blinkTimer = setInterval(()=>{ showA=!showA; charImg.src=showA?charA:charB; showWinA=!showWinA; winImg.src=showWinA?winA:winB; },500);

    // To-Do
    renderTodos();

    // ìŒì•… â€” ë¬´ë“œ/íŠ¸ë™
    ["Lo-Fi","Jazz","Loud","Piano","Noise"].forEach(m=>{
      const b=document.createElement("button");
      b.className="pill"; b.textContent=m; b.dataset.mood=m;
      b.addEventListener("click", ()=>{ state.mood=m; highlightMood(); });
      moodsWrap.appendChild(b);
    });
    TRACKS.forEach((t,idx)=>{
      const b=document.createElement("button");
      b.className="pill"; b.textContent=t.title; b.dataset.idx=idx;
      b.addEventListener("click", ()=> selectTrack(idx, state.playing));
      tracksWrap.appendChild(b);
    });
    selectTrack(0,false); highlightMood(); highlightTrack();

    player.addEventListener("ended", onEnded);
    player.addEventListener("error", ()=>{ const n=(state.trackIdx+1)%TRACKS.length; selectTrack(n,true); });

    repeatBtn.addEventListener("click", toggleRepeat);

    applyPom.addEventListener("click", ()=>{
      const wm=Math.max(1,parseInt(workMin.value||"25",10));
      const rm=Math.max(1,parseInt(restMin.value||"5",10));
      const tc=Math.max(1,parseInt(totalCyclesInput.value||"4",10));
      state.workSec=wm*60; state.restSec=rm*60; state.totalCycles=tc;
      resetTimer(); state.completedCycles=0; updateCyclesBtn();
    });

    cyclesBtn.addEventListener("click", ()=>{ state.completedCycles=0; updateCyclesBtn(); });

    // âœ… ì°½ë¬¸ í† ê¸€ ì´ˆê¸°í™”
    updateWindowToggleUI();
    toggleWindowBtn.addEventListener("click", ()=>{
      state.windowVisible = !state.windowVisible;
      windowBox.style.display = state.windowVisible ? "" : "none";
      updateWindowToggleUI();
    });

    // âœ… ì´ˆê¸° íƒ­ ì œëª© ë™ê¸°í™”
    updateTimerUI();
  }

  /* To-Do */
  function renderTodos(){
    boardList.innerHTML=""; if(state.todos.length===0) return;
    state.todos.forEach((t,idx)=>{
      const row=document.createElement("div"); row.className="todo";
      const cb=document.createElement("input"); cb.type="checkbox"; cb.checked=!!t.done;
      cb.addEventListener("change",()=>{ t.done=cb.checked; persistTodos(); renderTodos(); });
      const tx=document.createElement("div"); tx.className="txt"; tx.textContent=t.text;
      tx.style.textDecoration=t.done?"line-through":"none"; tx.style.opacity=t.done?".6":"1";
      const del=document.createElement("button"); del.className="del"; del.textContent="ì‚­ì œ";
      del.addEventListener("click",()=>{ state.todos.splice(idx,1); persistTodos(); renderTodos(); });
      row.append(cb,tx,del); boardList.appendChild(row);
    });
  }
  function persistTodos(){ localStorage.setItem("todos-v1", JSON.stringify(state.todos)); }
  function addTodo(){ const v=todoInput.value.trim(); if(!v) return; state.todos.push({text:v,done:false}); todoInput.value=""; persistTodos(); renderTodos(); }

  /* ìŒì•… */
  function selectTrack(idx, autoplay=false){ state.trackIdx=idx; player.src=TRACKS[idx].url; highlightTrack(); if(autoplay) tryPlay(); }
  function tryPlay(){ player.play().then(()=>{ state.playing=true; playPause.textContent="ì¼ì‹œì •ì§€"; }).catch(()=>{}); }
  function highlightMood(){ [...moodsWrap.children].forEach(b=>{ b.style.boxShadow = (b.dataset.mood===state.mood) ? "inset 0 0 0 1px #7C9AFF" : "none"; }); }
  function highlightTrack(){ [...tracksWrap.children].forEach(b=>{ b.style.boxShadow = (+b.dataset.idx===state.trackIdx) ? "inset 0 0 0 1px #7C9AFF" : "none"; }); }
  playPause.addEventListener("click", ()=>{
    if(!player.src) selectTrack(state.trackIdx,false);
    if(!state.playing){ tryPlay(); } else { player.pause(); state.playing=false; playPause.textContent="ì¬ìƒ"; }
  });
  shuffleBtn.addEventListener("click", ()=>{ state.shuffle=!state.shuffle; shuffleBtn.textContent=state.shuffle?"ëœë¤ ON":"ëœë¤ OFF"; });
  function toggleRepeat(){ const order=["off","one","all"]; const i=order.indexOf(state.repeatMode); state.repeatMode=order[(i+1)%order.length]; updateRepeatUI(); }
  function updateRepeatUI(){ repeatBtn.textContent="ë°˜ë³µ: "+(state.repeatMode==="off"?"êº¼ì§":state.repeatMode==="one"?"í•œê³¡":"ì „ì²´"); player.loop=(state.repeatMode==="one"); }
  updateRepeatUI();
  function onEnded(){
    if(state.repeatMode==="one") return;
    if(state.shuffle){ let n=state.trackIdx; if(TRACKS.length>1){ while(n===state.trackIdx) n=Math.floor(Math.random()*TRACKS.length); } selectTrack(n,true); return; }
    if(state.repeatMode==="all"){ const n=(state.trackIdx+1)%TRACKS.length; selectTrack(n,true); return; }
    state.playing=false; playPause.textContent="ì¬ìƒ";
  }

  /* íƒ€ì´ë¨¸ */
  function fmt(sec){ const s=Math.max(0,sec|0), h=Math.floor(s/3600), m=Math.floor((s%3600)/60), ss=s%60;
    const mm=m.toString().padStart(2,'0'), s2=ss.toString().padStart(2,'0'); return h>0?`${h}:${mm}:${s2}`:`${mm}:${s2}`; }

  function updateTimerUI(){
    timeEl.textContent=fmt(state.remainSec);
    stateEl.textContent=state.isWork?"ì§‘ì¤‘ì¤‘":"íœ´ì‹ì¤‘";
    startPause.textContent=state.running?"ì¼ì‹œì •ì§€":"ì‹œì‘";
    // âœ… íƒ­ ì œëª©ì— íƒ€ì´ë¨¸ + Studywithme
    document.title = `${fmt(state.remainSec)} â€¢ Studywithme`;
  }

  function beep(){ try{ const ctx=new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(); const g=ctx.createGain(); o.connect(g); g.connect(ctx.destination);
    o.type="sine"; o.frequency.value=880; g.gain.setValueAtTime(.0001,ctx.currentTime); g.gain.exponentialRampToValueAtTime(.3,ctx.currentTime+.01); o.start(); g.gain.exponentialRampToValueAtTime(.0001,ctx.currentTime+.25); o.stop(ctx.currentTime+.3);}catch{} }

  function startTimer(){ if(state.running) return; state.running=true; updateTimerUI();
    state.interval=setInterval(()=>{ if(state.remainSec<=0){ beep(); const wasWork=state.isWork; state.isWork=!state.isWork; state.remainSec=state.isWork?state.workSec:state.restSec;
        if(state.isWork && !wasWork){ state.completedCycles=Math.min(state.totalCycles, state.completedCycles+1); updateCyclesBtn(); if(state.completedCycles>=state.totalCycles){ stopTimer(); } }
      } else { state.remainSec-=1; } updateTimerUI(); },1000);
  }
  function stopTimer(){ state.running=false; if(state.interval){ clearInterval(state.interval); state.interval=null; } updateTimerUI(); }
  function resetTimer(){ stopTimer(); state.isWork=true; state.remainSec=state.workSec; updateTimerUI(); }
  document.getElementById("startPause").addEventListener("click", ()=> state.running?stopTimer():startTimer());
  document.getElementById("reset").addEventListener("click", resetTimer);
  function updateCyclesBtn(){ cyclesBtn.textContent=`${state.completedCycles}/${state.totalCycles}íšŒ`; }

  // âœ… ì°½ë¬¸ í† ê¸€ ë²„íŠ¼ ë¼ë²¨/ìƒíƒœ ë™ê¸°í™”
  function updateWindowToggleUI(){
    toggleWindowBtn.textContent = `ì°½ë¬¸: ${state.windowVisible ? "ë³´ì„" : "ìˆ¨ê¹€"}`;
  }

  // ì‹œì‘
  init();
</script>
</body>
</html>
