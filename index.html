<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Studywithme</title>

<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand:wght@400&family=Nanum+Pen+Script&display=swap" rel="stylesheet">

<style>
  :root{
    --bg-url: url("https://github.com/nihicheli/studywithme/blob/main/image/background%205.png?raw=true");
    --ink: #FBFFF4;
    --ink-sub: rgba(0,0,0,.7);
    --line: transparent;
    --top-gap: 12px;
    --content-top: 20vh;

    --maxh-board: 80vh;
    --maxh-timer: 35vh;
    --maxh-window: 40vh;
    --maxh-char: 50vh;

    --maxw-board: 25vw;
    --maxw-window: 15vw;
    --maxw-timer: 35vw;
    --maxw-char: 70vw;
  }
  :root[data-theme="light"]{
    --ink:#202020;
    --ink-sub:rgba(0,0,0,.7);
    --line:transparent;
  }

  *{box-sizing:border-box}
  html,body{
    height:100%; margin:0; color:var(--ink);
    font-family:"Patrick Hand","Nanum Pen Script",system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Arial,sans-serif;
    background:#000; font-size:clamp(12px,1.6vw,14px); letter-spacing:.02em;
  }

  /* ë°°ê²½ + 10% ê²€ì • ì˜¤ë²„ë ˆì´ */
  #app{
    position:relative; height:100dvh; overflow:hidden;
    background-image:
      linear-gradient(rgba(0,0,0,.10), rgba(0,0,0,.10)),
      var(--bg-url);
    background-size:cover; background-position:center;
  }

  .card{ background: rgba(0,0,0,.02); border: 2px solid var(--line); border-radius: 16px; }
  .panel{ padding: 1rem; }

  button, .pill{
    cursor:pointer; user-select:none; outline:0;
    background: rgba(255,255,255,.08); color:var(--ink);
    border: 1px solid var(--line);
    border-radius: 999px;
    padding: .6rem .9rem;
    font-weight: 700;
    font-family: inherit;
    font-size: 1rem;
  }
  /* ì•ˆìª½ í¬ì»¤ìŠ¤ ë§ */
  button:focus, .pill:focus, button:focus-visible, .pill:focus-visible{
    outline: none; box-shadow: inset 0 0 0 1px #7C9AFF;
  }
  *{ -webkit-tap-highlight-color: transparent; }
  input, textarea, select{ font-family: inherit; font-size: 1rem; color:#fff }

  .row{display:flex; gap:.75rem; align-items:center; flex-wrap:wrap}
  .hwrap{ display:flex; gap:.5rem; align-items:center; overflow-x:auto; }
  .title{font-weight:900; font-size: 1.125rem}

  /* ìƒë‹¨ ë ˆì´ì•„ì›ƒ â€” ìµœìƒë‹¨ ìœ ì§€ */
  #topbar{
    position:absolute; left:12px; right:12px; top: var(--top-gap);
    display:grid; grid-template-columns: 1fr auto 1fr; align-items:start; gap:12px;
    z-index: 9000;
  }
  #hamburger{ justify-self:start; width:3.4rem; height:3.4rem; display:grid; place-items:center; font-size:1.2rem; position:relative; z-index:9001; }

  /* íƒ€ì´ë¨¸(ê°€ìš´ë°) */
  #timer{
    justify-self:center; width: min(var(--maxw-timer), 90vw); max-height: var(--maxh-timer);
    display:flex; flex-direction:column; align-items:center; gap:.6rem; text-align:center; overflow:hidden;
  }
  #state{ font-size: 1.25rem; font-weight:900; }
  #time{ font-weight:900; font-size: clamp(2.2rem, 6vw, 4rem); line-height:1; }

  /* Todo list(ì˜¤ë¥¸ìª½) */
  #board{
    justify-self:end; width: min(var(--maxw-board), 92vw); max-height: var(--maxh-board);
    display:grid; grid-template-rows: auto 1fr auto; overflow:hidden;
  }
  #board .title{margin:0 0 .5rem 0}
  #todo-list{ overflow:auto; padding-right:2px; scrollbar-width: thin; }
  .todo{display:flex; align-items:center; gap:.5rem; padding:.45rem 0; border-bottom:1px solid rgba(255,255,255,.15)}
  .todo:last-child{border-bottom:0}
  .todo .txt{flex:1}
  .todo .del{background:transparent; border:0; color:var(--ink-sub); padding:.3rem .5rem; border-radius:.6rem}
  .todo .del:hover{background:rgba(255,255,255,.12); color:#fff}
  #inputRow{ display:flex; gap:.5rem; align-items:center; padding-top:.6rem; }
  #board input[type="text"]{ width:100%; background:transparent; border: 2px solid var(--line); border-radius: 12px; color:#fff; padding:.5rem .6rem; }

  /* ì¢Œ: ì°½ë¬¸, ê°€ìš´ë°: ìºë¦­í„° */
  #window{ position:absolute; left:2vw; top: var(--content-top); z-index:5; width: min(var(--maxw-window), 90vw); }
  #win-img{ display:block; width:100%; height:auto; max-height: var(--maxh-window); border-radius:16px; border:2px solid var(--line); }

  #character{ position:absolute; left:50%; transform:translateX(-50%); top: calc(var(--content-top) + 20vh); z-index:6; width: min(var(--maxw-char), 96vw); }
  #char-img{ display:block; width:100%; height:auto; max-height: var(--maxh-char); border-radius:18px; border:2px solid var(--line); background:transparent center/contain no-repeat; }

  /* í•˜ë‹¨: ìŒì•…íŒ¨ë„ */
  #bottombar{
    position:fixed; left:12px; right:12px; bottom: 8px;
    display:flex; gap:12px; justify-content:center; align-items:flex-end; z-index:12;
  }
  #bottombar .card{ flex:1 1 0; min-width:260px; }
  #bottombar h4{ margin:0 0 .5rem 0; font-size: 1.125rem; font-weight:900 }

  /* === (ì¶”ê°€) ì†Œí’ˆ ë ˆì´ì–´/ì†Œí’ˆ ìŠ¤íƒ€ì¼ ê³ ì • === */
  #propsLayer{
    position:absolute; inset:0; z-index:7; /* ìŒì•…(12)ë³´ë‹¤ ë‚®ê³  ì°½ë¬¸/ìºë¦­í„°(5/6)ë³´ë‹¤ ë†’ìŒ */
    pointer-events:none; /* ë‚´ë¶€ .propë§Œ ì´ë²¤íŠ¸ */
  }
  .prop{
    position:absolute; left:40px; top:40px; width:120px; z-index:80;
    pointer-events:auto; /* ë“œë˜ê·¸ ê°€ëŠ¥ */
  }
  .prop img{ width:100%; height:auto; display:block; }
  .draggable { cursor: move; }
  .dragging  { opacity:.92; }
  .resizer{
    position:absolute; right:-8px; bottom:-8px; width:16px; height:16px;
    border-radius:4px; background:rgba(255,255,255,.75);
    border:1px solid rgba(0,0,0,.3);
    display:none; z-index:3;
  }
  .edit-on .resizable .resizer{ display:block; }

  /* ë“œë¡œì–´/ì˜¤ë²„ë ˆì´ â€” ì ˆëŒ€ ìµœìƒë‹¨ */
  #overlay{ position:fixed; inset:0; background:rgba(0,0,0,.35); opacity:0; pointer-events:none; transition:opacity .2s ease; z-index: 10000; }
  #overlay.show{ opacity:1; pointer-events:auto; }

  #drawer{
    position:fixed; top:0; left:0; bottom:0; width:min(380px, 86vw);
    background:#111; color:#eee; border-right:2px solid var(--line);
    transform:translateX(-100%); transition:transform .24s ease; z-index: 10001;
    display:flex; flex-direction:column; gap:0; overflow-y:auto;
  }
  :root[data-theme="light"] #drawer{ background:#fafafa; color:#222; }
  #drawer.open{ transform:translateX(0) }
  .drawer-head{ display:flex; align-items:center; justify-content:space-between; padding:1rem; border-bottom:2px solid var(--line); }
  .drawer-sec{ padding:1rem; border-bottom:2px dashed rgba(255,255,255,.12); }
  :root[data-theme="light"] .drawer-sec{ border-bottom-color: rgba(0,0,0,.12); }
  .drawer-sec h4{ margin:.2rem 0 .8rem; font-weight:900; }

  .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:.5rem; }
  .drawer-sec input[type="number"], .drawer-sec input[type="text"]{
    width:100%; padding:.55rem .7rem; border:2px solid var(--line); border-radius:12px; background:transparent; color:#fff;
  }
  :root[data-theme="light"] .drawer-sec input[type="number"], :root[data-theme="light"] .drawer-sec input[type="text"]{ color:#222; }
  .fill{ flex:1 }

  .chips{ display:flex; gap:.5rem; align-items:center; flex-wrap: wrap; }
  .chips .pill{ border:1px solid var(--line); border-radius:14px; padding:.5rem .75rem; background:rgba(255,255,255,.06); transition: background .15s ease; }
  .chips .pill:hover{ background:rgba(255,255,255,.12); }
  .list-scroll{ max-height: 40vh; overflow: auto; padding-bottom: .25rem; }
  .list-scroll::-webkit-scrollbar{ width:10px; height:10px; }
  .list-scroll::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.22); border-radius:999px; }

  a#creditLink{ color:#9db7ff; text-decoration:none; border-bottom:1px dashed #9db7ff; }
  a#creditLink:hover{ opacity:.85; }

  .pill-input{
    width:100%; padding:.6rem .9rem; border:1px solid var(--line); border-radius:999px;
    background: rgba(255,255,255,.08); color:#fff; line-height:1; outline:none;
    transition: background .15s ease, box-shadow .15s ease; -webkit-appearance:none;
  }
  .pill-input::placeholder{ color: rgba(255,255,255,.6); }
  :root[data-theme="light"] .pill-input{ background: rgba(0,0,0,.06); color:#222; }
  :root[data-theme="light"] .pill-input::placeholder{ color: rgba(0,0,0,.5); }
  .pill-input:focus{ box-shadow: inset 0 0 0 3px #7C9AFF; background: rgba(124,154,255,.15); }
  .drawer-sec .row .pill-input{ flex:1; min-width:0; }

  /* íŒŒì¼ ì„ íƒì„ pillì²˜ëŸ¼ */
  .input-file-hidden{
    position:absolute; width:0.1px; height:0.1px;
    opacity:0; overflow:hidden; z-index:-1;
  }
  .file-row{ display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
  .file-pill{ display:inline-flex; align-items:center; gap:.5rem; }
  .file-pill .icon{ font-size:1.1rem; line-height:1; }
  #bgFileName, #propFileName{
    max-width: 10rem;
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    opacity:.8;
  }
  .bg-thumb{
    width:42px; height:28px; border-radius:8px;
    border:1px solid var(--line); background:#000 center/cover no-repeat;
  }

  /* ê°•ì œ ê°€ë¡œ ë³´ê¸°(ì„¸ë¡œì—ì„œ) */
  html.portrait-force, body.portrait-force{
    height:100%;
    overflow-x:auto;           /* ê°€ë¡œ ìŠ¤í¬ë¡¤ í—ˆìš© â†’ 1100px ê¸°ì¤€ í™•ëŒ€í•´ë„ ë³¼ ìˆ˜ ìˆê²Œ */
    overflow-y:auto;
  }
  .portrait-force #app{
    width: 100vh;              /* íšŒì „ ì „ ì¹˜ìˆ˜ â†’ íšŒì „ í›„ ê°€ë¡œí­=100vh */
    height: 100vw;
    transform: rotate(90deg) translateY(-100%); /* scaleì€ JSë¡œ ì£¼ì… */
    transform-origin: top left;
  }

  /* ì˜¤ë¥¸ìª½ ì•„ë˜: ì‹¤ì‹œê°„ íŒ¨ë„ */
  #presencePanel{
    position: fixed;
    right: 0;                                /* í™”ë©´ ìš°ì¸¡ì— ë”± ë¶™ì„ */
    bottom: calc(8px + 112px);
    width: 25vw;                              /* í™”ë©´ ê°€ë¡œì˜ 25% */
    max-width: 25vw;                          /* ì •í™•íˆ 25%ë§Œ ì“°ë„ë¡ */
    z-index: 8000;
  }
  #presencePanel .dot{ display:inline-block; width:8px; height:8px; border-radius:999px; margin-right:.4rem; background:#9cccff; }
  #presencePanel .dot.work{ background:#7CFF7C; }
  #presencePanel .dot.break{ background:#FFC66D; }
  #presenceList .person{ display:flex; justify-content:space-between; gap:.5rem; padding:.25rem 0; }
  #presenceList .nick{ font-weight:700; }

  /* (ì¶”ê°€) í•˜ë‹¨ ì¤‘ì•™ íˆ¬ëª… ë°°ë„ˆ */
  #adBanner{
    position:fixed; left:50%; bottom:0; transform:translateX(-50%);
    width:min(90vw, 970px); height:90px; z-index:1; pointer-events:none;
  }
  #adBanner img{ width:100%; height:100%; opacity:0; display:block; }
  
  @media (max-width: 720px){
    :root{ --content-top: 14vh; --maxw-char: 90vw; }
    #bottombar{ flex-direction:column; }
    #bottombar .card{ width:100%; }
    #presencePanel{
      width: 25vw;               /* ëª¨ë°”ì¼ë„ 25% ìœ ì§€ */
      right: 0;
      bottom: calc(8px + 160px); /* ê¸°ì¡´ í•˜ë‹¨ ì—¬ë°± ìœ ì§€ */
    }
</style>
</head>
<body>
<div id="app" class="">
  <!-- ì˜¤ë¥¸ìª½ ì•„ë˜: ì‹¤ì‹œê°„ íŒ¨ë„ -->
  <aside id="presencePanel" class="card panel" style="display:none">
    <div class="row" style="justify-content:space-between">
      <div class="title">ì§€ê¸ˆ ê³µë¶€ì¤‘</div>
      <div id="meNick" style="opacity:.8"></div>
    </div>
    <div id="presenceList"></div>
  </aside>

  <!-- ì†Œí’ˆ ë ˆì´ì–´ -->
  <div id="propsLayer"></div>

  <!-- ì˜¤ë²„ë ˆì´ + ë“œë¡œì–´ -->
  <div id="overlay"></div>
  <aside id="drawer" aria-label="ì„¤ì •">
    <header class="drawer-head">
      <h3 style="margin:0">ì„¤ì •</h3>
      <div class="row">
        <button id="themeToggle" class="pill" title="ë‹¤í¬/ë¼ì´íŠ¸ ì „í™˜">ğŸŒ™</button>
        <button id="closeDrawer" class="pill">ë‹«ê¸°</button>
      </div>
    </header>

    <!-- 1) ë½€ëª¨ë„ë¡œ / íƒ€ì´ë¨¸ -->
    <section class="drawer-sec">
      <h4>ë½€ëª¨ë„ë¡œ / íƒ€ì´ë¨¸</h4>
      <div class="row" id="modeRow">
        <label><input type="radio" name="mode" value="pomodoro" checked> ë½€ëª¨ë„ë¡œ</label>
        <label><input type="radio" name="mode" value="timer"> íƒ€ì´ë¨¸(ì¹´ìš´íŠ¸ì—…)</label>
      </div>
      <div class="grid2" id="pomodoroFields" style="margin-top:.5rem">
        <label>ì§‘ì¤‘(ë¶„)
          <input id="workMin" type="number" min="1" value="25">
        </label>
        <label>íœ´ì‹(ë¶„)
          <input id="restMin" type="number" min="1" value="5">
        </label>
      </div>
      <label style="display:block; margin-top:.5rem" id="cyclesWrap">ì‚¬ì´í´ ìˆ˜(NíšŒ)
        <input id="totalCycles" type="number" min="1" value="4">
      </label>
      <div class="row" style="margin-top:.6rem">
        <button id="applyPom" class="pill">ì ìš©</button>
      </div>
    </section>

    <!-- 2) ì‹¤ì‹œê°„ ë³´ê¸° -->
    <section class="drawer-sec">
      <h4>ì‹¤ì‹œê°„ ë³´ê¸°</h4>
      <div class="row">
        <input id="nickname" class="fill pill-input" placeholder="ë‹‰ë„¤ì„(ì˜ˆ: do)">
        <button id="presenceToggle" class="pill">ê³µê°œ: ì¼œì§</button>
      </div>
      <div class="row" style="margin-top:.5rem">
        <button id="shareStudyBtn" class="pill">ë‚´ ê³µë¶€ì‹œê°„ ê³µê°œ: ì¼œì§</button>
      </div>
      <div style="opacity:.8; margin-top:.4rem">â€» ëª©ë¡ì—” ìµœëŒ€ 5ëª… í‘œì‹œ.</div>
    </section>

    <!-- 3) ìŒì•… -->
    <section class="drawer-sec">
      <h4>ìŒì•… ìŠ¤íƒ€ì¼</h4>
      <div id="moods" class="chips list-scroll"></div>
    </section>

    <section class="drawer-sec">
      <h4>ê³¡ ì„ íƒ</h4>
      <div id="tracks" class="chips list-scroll"></div>
    </section>

    <!-- í™”ë©´ í‘œì‹œ / ë ˆì´ì•„ì›ƒ / ë°°ê²½ / ì†Œí’ˆ / í¬ë ˆë”§ -->
    <section class="drawer-sec">
      <h4>ì°½ë¬¸/ìºë¦­í„° í‘œì‹œ</h4>
      <div class="row">
        <button id="toggleWindow" class="pill">ì°½ë¬¸: ë³´ì„</button>
        <button id="toggleCharacter" class="pill">ìºë¦­í„°: ë³´ì„</button>
      </div>
    </section>

    <section class="drawer-sec">
      <h4>í™”ë©´ ì„¤ì •</h4>
      <div class="row">
        <button id="layoutEdit" class="pill">ë°°ì¹˜ í¸ì§‘: êº¼ì§</button>
        <button id="layoutReset" class="pill" title="ì›ìƒë³µêµ¬">ì›ìƒë³µêµ¬</button>
        <button id="rotateToggle" class="pill" title="ì„¸ë¡œì—ì„œ ê°€ë¡œë¡œ í‘œì‹œ">íšŒì „: ì¼œì§</button>
      </div>
    </section>

    <section class="drawer-sec">
      <h4>ë°°ê²½ ì„ íƒ</h4>
      <div id="bgChips" class="chips"></div>

      <!-- íŒŒì¼ë¡œ ë°°ê²½ ì„ íƒ(ì„ íƒ ì¦‰ì‹œ ì ìš©, ì ìš© ë²„íŠ¼ ì—†ìŒ) -->
      <div class="file-row" style="margin-top:.5rem">
        <input id="customBgFile" type="file" accept="image/*" class="input-file-hidden">
        <label for="customBgFile" class="pill file-pill" title="ë°°ê²½ ì´ë¯¸ì§€ ì„ íƒ">
          <span class="icon">ğŸ“</span> ë°°ê²½ íŒŒì¼ ì„ íƒ
        </label>
        <span id="bgFileName">ì„ íƒ ì•ˆ ë¨</span>
        <span id="bgPreview" class="bg-thumb" aria-hidden="true"></span>
      </div>

      <div class="row" style="margin-top:.5rem">
        <input id="customBgUrl" placeholder="ë°°ê²½ ì´ë¯¸ì§€ URL ë¶™ì—¬ë„£ê¸°" class="fill pill-input">
        <button id="applyBg" class="pill">ì ìš©</button>
      </div>
    </section>

    <section class="drawer-sec">
      <h4>ì†Œí’ˆ</h4>
      <!-- íŒŒì¼ ì„ íƒì„ URLë³´ë‹¤ ìœ„ë¡œ -->
      <div class="file-row" style="margin-top:.5rem">
        <input id="propFile" type="file" accept="image/*" class="input-file-hidden" />
        <label for="propFile" class="pill file-pill" title="ì†Œí’ˆ ì´ë¯¸ì§€ ì„ íƒ">
          <span class="icon">ğŸ“</span> ì†Œí’ˆ íŒŒì¼ ì„ íƒ
        </label>
        <span id="propFileName">ì„ íƒ ì•ˆ ë¨</span>
        <button id="propFileAdd" class="pill">íŒŒì¼ ì¶”ê°€</button>
      </div>
      <div class="row" style="margin-top:.5rem">
        <input id="propUrl" class="fill pill-input" placeholder="ì†Œí’ˆ ì´ë¯¸ì§€ URL">
        <button id="propAdd" class="pill">ì¶”ê°€</button>
      </div>

      <div class="chips" style="margin-top:.5rem">
        <button class="pill propPreset" data-url="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f331.svg">ğŸŒ±</button>
        <button class="pill propPreset" data-url="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/2615.svg">â˜•</button>
        <button class="pill propPreset" data-url="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f4a1.svg">ğŸ’¡</button>
        <button class="pill propPreset" data-url="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f4da.svg">ğŸ“š</button>
      </div>
      <div id="propList" class="list-scroll" style="margin-top:.6rem"></div>
      <div style="opacity:.8; margin-top:.4rem">â€» ì†Œí’ˆì€ ì¶”ê°€ ì¦‰ì‹œ í¸ì§‘ ê°€ëŠ¥(ì¤‘ì•™ ìµœì†Œí¬ê¸° ë°°ì¹˜)</div>
    </section>

    <section class="drawer-sec">
      <h4>Credits</h4>
      <a id="creditLink" href="#" target="_blank" rel="noopener">Made by do</a>
    </section>
  </aside>

  <!-- ìƒë‹¨: í–„ë²„ê±° / íƒ€ì´ë¨¸ / Todo -->
  <div id="topbar">
    <button id="hamburger" class="card panel" aria-label="ë©”ë‰´ ì—´ê¸°">â‹¯</button>

    <section id="timer" class="card panel resizable" aria-label="íƒ€ì´ë¨¸">
      <div id="state">ì§‘ì¤‘ì¤‘</div>
      <div id="time">25:00</div>
      <div class="row">
        <button class="pill" id="startPause">ì‹œì‘</button>
        <button class="pill" id="reset">ë¦¬ì…‹</button>
        <button class="pill" id="cyclesBtn" title="ì‚¬ì´í´ ì§„í–‰ ìƒí™©">0/4íšŒ</button>
      </div>
    </section>

    <section id="board" class="card panel" aria-label="Todo list">
      <div class="title">Todo list</div>
      <div id="todo-list"></div>
      <div id="inputRow">
        <input id="todo-input" type="text" placeholder="í•  ì¼ì„ ì ê³  Enter" />
        <button id="todo-add" class="pill" title="ì¶”ê°€">ï¼‹</button>
      </div>
    </section>
  </div>

  <!-- ë©”ì¸: ì°½ë¬¸ + ìºë¦­í„° -->
  <div id="window" class="resizable"><img id="win-img" alt="ì°½ë¬¸" /></div>
  <div id="character" class="resizable"><img id="char-img" alt="ìºë¦­í„°" /></div>

  <!-- í•˜ë‹¨: ìŒì•… -->
  <div id="bottombar">
    <section id="music-controls" class="card panel" aria-label="ìŒì•… ì¬ìƒ">
      <h4>ìŒì•… ì¬ìƒ</h4>
      <div class="hwrap">
        <button class="pill" id="playPause">ì¬ìƒ</button>
        <button class="pill" id="shuffle">ëœë¤ OFF</button>
        <button class="pill" id="repeat">ë°˜ë³µ: êº¼ì§</button>
      </div>
      <audio id="player" preload="metadata"></audio>
    </section>
  </div>

  <!-- (ì¶”ê°€) í•˜ë‹¨ ì¤‘ì•™ íˆ¬ëª… ë°°ë„ˆ ìë¦¬ -->
  <div id="adBanner" aria-hidden="true">
    <!-- ì™„ì „ íˆ¬ëª… 1x1 PNG (ëŠ˜ë ¤ì„œ ì‚¬ìš©) -->
    <img alt="ad-placeholder"
      src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGNgYAAAAAMAASsJTYQAAAAASUVORK5CYII="/>
  </div>
</div>

<script>
  /* ===== íŠ¸ë™ ë°ì´í„° ===== */
  const TRACKS = [
    { title: "Bass Meant Jazz",     mood: "Jazz",  url: "https://freepd.com/music/Bass%20Meant%20Jazz.mp3" },
    { title: "Stompin at Midnight", mood: "Jazz",  url: "https://freepd.com/music/Stompin%20at%20Midnight.mp3" },
    { title: "Abstract Anxiety",    mood: "Loud",  url: "https://freepd.com/music/Abstract%20Anxiety.mp3" },
    { title: "Adding the Sun",      mood: "Lo-Fi", url: "https://freepd.com/music/Adding%20the%20Sun.mp3" },
    { title: "Bleu",                mood: "Lo-Fi", url: "https://freepd.com/music/Bleu.mp3" },
    { title: "Study and Relax",     mood: "Lo-Fi", url: "https://freepd.com/music/Study%20and%20Relax.mp3" },
    { title: "Deep Focus",          mood: "Lo-Fi", url: "https://freepd.com/music/Deep%20Focus.mp3" },
    /* White/Pink/Brown Noise (Public Domain) */
    { title: "White Noise",  mood: "Noise", url: "https://archive.org/download/TenMinutesOfWhiteNoisePinkNoiseAndBrownianNoise/WhiteNoise_64kb.mp3" },
    { title: "Pink Noise",   mood: "Noise", url: "https://archive.org/download/TenMinutesOfWhiteNoisePinkNoiseAndBrownianNoise/PinkNoise_64kb.mp3" },
    { title: "Brown Noise",  mood: "Noise", url: "https://archive.org/download/TenMinutesOfWhiteNoisePinkNoiseAndBrownianNoise/BrownianNoise_64kb.mp3" }
  ];

  /* ì°½ë¬¸/ìºë¦­í„° 0.5s êµì°¨ */
  let charA = "https://github.com/nihicheli/studywithme/blob/main/image/Group%209213.png?raw=true";
  let charB = "https://github.com/nihicheli/studywithme/blob/main/image/Group%209214.png?raw=true";
  let winA  = "https://github.com/nihicheli/studywithme/blob/main/image/Group%209215.png?raw=true";
  let winB  = "https://github.com/nihicheli/studywithme/blob/main/image/Group%209216.png?raw=true";
  let showA = true, showWinA = true, blinkTimer = null;

  const ROTATE_BASE_WIDTH = 1100; /* ì„¸ë¡œì—ì„œ ê°€ë¡œì²˜ëŸ¼ ë³´ì—¬ì¤„ ë•Œ ëª©í‘œ ê°€ë¡œí­(px) */

  /* ===== ì „ì—­ ìƒíƒœ ===== */
  const lsShare = localStorage.getItem("shareStudy");
  const state = {
    mode: localStorage.getItem("mode") || "pomodoro",
    shareStudy: (lsShare === null) ? true : (lsShare === "1"),   // ê¸°ë³¸ ON
    isWork: true, running: false,
    workSec: 25*60, restSec: 5*60, remainSec: 25*60,
    interval: null, shuffle: false, playing: false,
    mood: "ì „ì²´", trackIdx: 0, repeatMode: "off",   // ê¸°ë³¸ 'ì „ì²´'ë¡œ
    totalCycles: 4, completedCycles: 0,
    todos: JSON.parse(localStorage.getItem("todos-v1")||"[]"),
    theme: localStorage.getItem("theme") || "dark",
    windowVisible: (localStorage.getItem("ui-window-visible") ?? "1") === "1",
    characterVisible: (localStorage.getItem("ui-character-visible") ?? "1") === "1",
    props: JSON.parse(localStorage.getItem("props-v1")||"[]"),
    rotateOn: (localStorage.getItem("rotateOn") ?? "") === "" ? true : (localStorage.getItem("rotateOn") === "1") // ê¸°ë³¸ ì¼œì§
  };
  window.state = state;

  /* ë ˆì´ì•„ì›ƒ ì´ˆê¸°í™” í›„ì—ë„ íƒ€ì´ë¨¸ ìœ ì§€(ì„¸ì…˜ ë³µêµ¬) */
  let __resumeAfterReload = false;
  (function restoreTimerFromSession(){
    const saved = sessionStorage.getItem('timer-keep');
    if(!saved) return;
    try{
      const s = JSON.parse(saved);
      state.mode = s.mode || state.mode;
      state.isWork = !!s.isWork;
      state.workSec = +s.workSec || state.workSec;
      state.restSec = +s.restSec || state.restSec;
      state.remainSec = +s.remainSec || state.remainSec;
      state.totalCycles = +s.totalCycles || state.totalCycles;
      state.completedCycles = +s.completedCycles || 0;
      __resumeAfterReload = !!s.running;
      localStorage.setItem("mode", state.mode);
    }catch(e){}
    sessionStorage.removeItem('timer-keep');
  })();

  /* ===== ì—˜ë¦¬ë¨¼íŠ¸ ===== */
  const boardList = document.getElementById("todo-list");
  const todoInput = document.getElementById("todo-input");
  const todoAdd   = document.getElementById("todo-add");
  const charImg   = document.getElementById("char-img");
  const winImg    = document.getElementById("win-img");
  const timeEl    = document.getElementById("time");
  const stateEl   = document.getElementById("state");
  const startPause= document.getElementById("startPause");
  const resetBtn  = document.getElementById("reset");
  const cyclesBtn = document.getElementById("cyclesBtn");
  const playPause = document.getElementById("playPause");
  const shuffleBtn= document.getElementById("shuffle");
  const repeatBtn = document.getElementById("repeat");
  const player    = document.getElementById("player");

  const overlay   = document.getElementById("overlay");
  const drawer    = document.getElementById("drawer");
  const hamburgerBtn = document.getElementById("hamburger");
  const closeDrawer  = document.getElementById("closeDrawer");
  const themeToggle  = document.getElementById("themeToggle");
  const moodsWrap    = document.getElementById("moods");
  const tracksWrap   = document.getElementById("tracks");

  const workMin      = document.getElementById("workMin");
  const restMin      = document.getElementById("restMin");
  const totalCyclesInput = document.getElementById("totalCycles");
  const applyPom     = document.getElementById("applyPom");

  const modeRadios   = document.querySelectorAll('input[name="mode"]');
  const pomodoroFields = document.getElementById("pomodoroFields");
  const cyclesWrap   = document.getElementById("cyclesWrap");

  const bgChips      = document.getElementById("bgChips");
  const customBgUrl  = document.getElementById("customBgUrl");
  const applyBg      = document.getElementById("applyBg");
  const customBgFile = document.getElementById("customBgFile");
  const bgFileName   = document.getElementById("bgFileName");
  const bgPreview    = document.getElementById("bgPreview");

  const toggleWindowBtn    = document.getElementById("toggleWindow");
  const toggleCharacterBtn = document.getElementById("toggleCharacter");
  const windowBox          = document.getElementById("window");
  const characterBox       = document.getElementById("character");

  const layoutEditBtn  = document.getElementById("layoutEdit");
  const layoutResetBtn = document.getElementById("layoutReset");
  const rotateToggle   = document.getElementById("rotateToggle");

  const propsLayer   = document.getElementById("propsLayer");
  const propUrl      = document.getElementById("propUrl");
  const propAdd      = document.getElementById("propAdd");
  const propFile     = document.getElementById("propFile");
  const propFileAdd  = document.getElementById("propFileAdd");
  const propFileName = document.getElementById("propFileName");
  const propList     = document.getElementById("propList");
  const propPresets  = document.querySelectorAll(".propPreset");

  const presencePanel = document.getElementById("presencePanel");
  const meNickEl      = document.getElementById("meNick");
  const presenceList  = document.getElementById("presenceList");
  const presenceToggle= document.getElementById("presenceToggle");
  const nicknameInput = document.getElementById("nickname");
  const shareStudyBtn = document.getElementById("shareStudyBtn");

  function applyTheme(t){
    document.documentElement.setAttribute("data-theme", t);
    themeToggle.textContent = (t==="dark" ? "ğŸŒ™" : "â˜€ï¸");
    localStorage.setItem("theme", t);
  }

  function init(){
    applyTheme(state.theme);

    // ë“œë¡œì–´
    hamburgerBtn.addEventListener("click", ()=>{ drawer.classList.add("open"); overlay.classList.add("show"); });
    closeDrawer  .addEventListener("click", ()=>{ drawer.classList.remove("open"); overlay.classList.remove("show"); });
    overlay      .addEventListener("click", ()=>{ drawer.classList.remove("open"); overlay.classList.remove("show"); });
    themeToggle  .addEventListener("click", ()=>{ state.theme = (state.theme==="dark")?"light":"dark"; applyTheme(state.theme); });

    // ëª¨ë“œ ë¼ë””ì˜¤
    modeRadios.forEach(r=>{
      r.checked = (r.value === state.mode);
      r.addEventListener('change', ()=>{
        state.mode = r.value;
        localStorage.setItem("mode", state.mode);
        if(state.mode==='timer'){ // ì¹´ìš´íŠ¸ì—… ì´ˆê¸°í™”
          state.isWork = true;
          state.remainSec = 0;
          state.completedCycles = 0;
        }else{ // ë½€ëª¨ë„ë¡œ
          state.isWork = true;
          state.remainSec = state.workSec;
          state.completedCycles = 0;
        }
        stopTimer(); updateCyclesBtn(); updateTimerUI(); refreshModeFields();
      });
    });
    refreshModeFields();

    // ì…ë ¥ê°’ ì´ˆê¸°í™”
    workMin.value = Math.round(state.workSec/60);
    restMin.value = Math.round(state.restSec/60);
    totalCyclesInput.value = state.totalCycles;
    updateCyclesBtn();

    // ë°°ê²½ í”„ë¦¬ì…‹
    const BG_PRESETS = [
      "https://github.com/nihicheli/studywithme/blob/main/image/background%205.png?raw=true",
      "https://github.com/nihicheli/studywithme/blob/main/image/background%206.png?raw=true",
      "https://github.com/nihicheli/studywithme/blob/main/image/background%202.png?raw=true",
      "https://github.com/nihicheli/studywithme/blob/main/image/background%204.png?raw=true",
      "https://github.com/nihicheli/studywithme/blob/main/image/background%203.png?raw=true"
    ];
    BG_PRESETS.forEach((url,i)=>{
      const btn=document.createElement("button");
      btn.className="pill";
      btn.innerHTML=`<img src="${url}" alt="bg${i}" style="width:42px;height:28px;object-fit:cover;border-radius:8px;vertical-align:middle;margin-right:.4rem;border:1px solid var(--line)"> ë°°ê²½ ${i+1}`;
      btn.addEventListener("click", ()=> setBackground(url));
      bgChips.appendChild(btn);
    });
    applyBg.addEventListener("click", ()=>{ const url=(customBgUrl.value||"").trim(); if(url) setBackground(url); });
    function setBackground(url){ document.documentElement.style.setProperty("--bg-url", `url("${url}")`); }

    // ë°°ê²½: íŒŒì¼ ì„ íƒ ì¦‰ì‹œ ì ìš©
    customBgFile?.addEventListener("change", ()=>{
      const file = customBgFile.files && customBgFile.files[0];
      if(!file) return;
      bgFileName.textContent = file.name;
      const reader = new FileReader();
      reader.onload = (e)=>{
        const dataUrl = e.target.result;
        bgPreview.style.backgroundImage = `url("${dataUrl}")`;
        setBackground(dataUrl);
      };
      reader.readAsDataURL(file);
    });

    // êµì°¨ ì´ë¯¸ì§€
    charImg.src = charA; winImg.src = winA;
    blinkTimer = setInterval(()=>{
      showA = !showA; charImg.src = showA ? charA : charB;
      showWinA = !showWinA; winImg.src = showWinA ? winA : winB;
    }, 500);

    // To-Do
    renderTodos();
    todoAdd.addEventListener("click", addTodo);
    todoInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") addTodo(); });

    // ìŒì•… â€” ìŠ¤íƒ€ì¼/íŠ¸ë™ í•„í„°ë§
    initMoodsAndTracks();

    player.addEventListener("ended", onEnded);
    player.addEventListener("error", ()=>{
      // ì˜¤ë¥˜ ì‹œ: í˜„ì¬ í•„í„° ëª©ë¡ì—ì„œ ë‹¤ìŒ ê³¡
      const list = filteredTrackIdxs();
      if(list.length){
        const curPos = list.indexOf(state.trackIdx);
        const n = list[(curPos+1) % list.length];
        selectTrack(n,true);
      }
    });
    repeatBtn.addEventListener("click", toggleRepeat);

    // ì„¤ì • ì ìš©
    applyPom.addEventListener("click", ()=>{
      if(state.mode === 'pomodoro'){
        const wm=Math.max(1,parseInt(workMin.value||"25",10));
        const rm=Math.max(1,parseInt(restMin.value||"5",10));
        const tc=Math.max(1,parseInt(totalCyclesInput.value||"4",10));
        state.workSec=wm*60; state.restSec=rm*60; state.totalCycles=tc;
        state.isWork=true; state.remainSec=state.workSec; state.completedCycles=0;
      }else{
        state.isWork=true; state.remainSec=0; state.totalCycles=1; state.completedCycles=0;
      }
      stopTimer(); updateCyclesBtn(); updateTimerUI();
    });
    cyclesBtn.addEventListener("click", ()=>{ state.completedCycles=0; updateCyclesBtn(); });

    // í™”ë©´ í‘œì‹œ
    updateWindowToggleUI();
    updateCharacterToggleUI();
    toggleWindowBtn.addEventListener("click", ()=>{
      state.windowVisible = !state.windowVisible;
      windowBox.style.display = state.windowVisible ? "" : "none";
      localStorage.setItem("ui-window-visible", state.windowVisible ? "1" : "0");
      updateWindowToggleUI();
    });
    toggleCharacterBtn.addEventListener("click", ()=>{
      state.characterVisible = !state.characterVisible;
      characterBox.style.display = state.characterVisible ? "" : "none";
      localStorage.setItem("ui-character-visible", state.characterVisible ? "1" : "0");
      updateCharacterToggleUI();
    });

    // ë ˆì´ì•„ì›ƒ í¸ì§‘/ì›ë³µ(íƒ€ì´ë¨¸ ìœ ì§€)
    setupLayoutDrag();

    // íšŒì „ í† ê¸€ â€” ê¸°ë³¸ ì¼œì§
    function setRotate(on){
      state.rotateOn = !!on;
      localStorage.setItem('rotateOn', state.rotateOn ? "1" : "0");
      rotateToggle.textContent = `íšŒì „: ${state.rotateOn ? "ì¼œì§" : "êº¼ì§"}`;
      applyRotateState();
    }
    function applyRotateState(){
      const portrait = window.innerHeight > window.innerWidth;
      document.documentElement.classList.toggle('portrait-force', state.rotateOn && portrait);
      if (state.rotateOn && portrait) applyScaleToTarget();  // â† ì—¬ê¸°!
      else clearScale();
    }

    function applyScaleTo1100(){ // <- ì´ë¦„ ìœ ì§€
      // íšŒì „ í›„ ì¹˜ìˆ˜: width = 100vh, height = 100vw
      const vh = Math.max(1, window.innerHeight);
      const vw = Math.max(1, window.innerWidth);
      const targetW = ROTATE_BASE_WIDTH;   // 1000
      const targetH = ROTATE_BASE_HEIGHT;  // 2200
      // ê°€ë¡œ/ì„¸ë¡œ ëª¨ë‘ target ì•ˆì— ë“¤ì–´ê°€ë„ë¡ ìŠ¤ì¼€ì¼
      const s = Math.min(targetW / vh, targetH / vw);

      const MOBILE_ZOOM = 1.05; // í•„ìš”ì‹œ 1.1~1.5 ì‚¬ì´ë¡œ ì¡°ì ˆ
      function isSmallPhone(){
        return Math.min(window.innerWidth, window.innerHeight) < 820;
      }
      
      const app = document.getElementById('app');
      app.style.transform = `rotate(90deg) translateY(-100%) scale(${s})`;
    }

    function clearScale(){ document.getElementById('app').style.transform = ''; }
    rotateToggle.addEventListener('click', ()=> setRotate(!state.rotateOn));
    window.addEventListener('resize', applyRotateState);
    window.addEventListener('orientationchange', ()=> setTimeout(applyRotateState, 50));
    if(localStorage.getItem('rotateOn') === null){ setRotate(false); } else { setRotate(state.rotateOn); }

    // ì†Œí’ˆ í”„ë¦¬ì…‹
    document.querySelectorAll('.propPreset').forEach(btn=> btn.addEventListener('click', ()=> addProp(btn.dataset.url, true, {autoEdit:true})));
    // íŒŒì¼ ì„ íƒ(ë¼ë²¨ íŒŒì¼ëª… í‘œì‹œ) + ì¶”ê°€ ì‹œ ì¤‘ì•™ ìµœì†Œë°°ì¹˜ + ì¦‰ì‹œ í¸ì§‘
    propFile.addEventListener('change', ()=>{
      const f = propFile.files && propFile.files[0];
      propFileName.textContent = f ? f.name : 'ì„ íƒ ì•ˆ ë¨';
    });
    propFileAdd.addEventListener('click', ()=>{
      const f = propFile.files && propFile.files[0];
      if(!f) return;
      const url = URL.createObjectURL(f);
      addProp(url, true, {autoEdit:true});  // ì¤‘ì•™+ìµœì†Œí¬ê¸°+ì¦‰ì‹œí¸ì§‘
      propFile.value = ""; propFileName.textContent = "ì„ íƒ ì•ˆ ë¨";
      closeDrawer.click();
    });
    // URL ì¶”ê°€ë„ ì¤‘ì•™ ìµœì†Œ ë°°ì¹˜ + ì¦‰ì‹œ í¸ì§‘
    propAdd.addEventListener('click', ()=>{
      const u=(propUrl.value||"").trim(); if(!u) return;
      addProp(u, true, {autoEdit:true});
      propUrl.value=""; closeDrawer.click();
    });
    renderProps();

    // ë‚´ ê³µë¶€ì‹œê°„ ê³µê°œ í† ê¸€ (ê¸°ë³¸ ON)
    function refreshShareStudyUI(){
      shareStudyBtn.textContent = `ë‚´ ê³µë¶€ì‹œê°„ ê³µê°œ: ${state.shareStudy ? "ì¼œì§" : "êº¼ì§"}`;
    }
    shareStudyBtn.addEventListener('click', ()=>{
      state.shareStudy = !state.shareStudy;
      localStorage.setItem('shareStudy', state.shareStudy ? "1" : "0");
      refreshShareStudyUI();
      window.__presence_broadcastNow?.();
    });
    refreshShareStudyUI();

    // íƒ­ ì œëª© + ì„¸ì…˜ ë³µì› í›„ ìë™ ì¬ê°œ
    updateTimerUI();
    if(__resumeAfterReload){ startTimer(); }
  }

  function refreshModeFields(){
    const isPom = (state.mode === 'pomodoro');
    pomodoroFields.style.display = isPom ? '' : 'none';
    cyclesWrap.style.display     = isPom ? '' : 'none';
    stateEl.textContent = isPom ? (state.isWork?"ì§‘ì¤‘ì¤‘":"íœ´ì‹ì¤‘") : "íƒ€ì´ë¨¸";
  }

  /* To-Do */
  function renderTodos(){
    boardList.innerHTML = "";
    if(state.todos.length === 0) return;
    state.todos.forEach((t,idx)=>{
      const row=document.createElement("div"); row.className="todo";
      const cb=document.createElement("input"); cb.type="checkbox"; cb.checked=!!t.done;
      cb.addEventListener("change",()=>{ t.done=cb.checked; persistTodos(); renderTodos(); });
      const tx=document.createElement("div"); tx.className="txt"; tx.textContent=t.text;
      tx.style.textDecoration=t.done?"line-through":"none"; tx.style.opacity=t.done?".6":"1";
      const del=document.createElement("button"); del.className="del"; del.textContent="ì‚­ì œ";
      del.addEventListener("click",()=>{ state.todos.splice(idx,1); persistTodos(); renderTodos(); });
      row.append(cb,tx,del); boardList.appendChild(row);
    });
  }
  function persistTodos(){ localStorage.setItem("todos-v1", JSON.stringify(state.todos)); }
  function addTodo(){ const v=todoInput.value.trim(); if(!v) return; state.todos.push({text:v,done:false}); todoInput.value=""; persistTodos(); renderTodos(); }

  /* ìŒì•…: ìŠ¤íƒ€ì¼/íŠ¸ë™ í•„í„°ë§ */
  function MOODS(){ return ["ì „ì²´","Lo-Fi","Jazz","Loud","Piano","Noise"]; }
  function filteredTrackIdxs(){
    if(state.mood==="ì „ì²´") return TRACKS.map((_,i)=>i);
    return TRACKS.map((t,i)=> t.mood===state.mood ? i : -1).filter(i=>i>=0);
  }
  function initMoodsAndTracks(){
    moodsWrap.innerHTML = "";
    MOODS().forEach(m=>{
      const b=document.createElement("button");
      b.className="pill"; b.textContent=m; b.dataset.mood=m;
      b.addEventListener("click", ()=>{ state.mood=m; highlightMood(); renderTracks(); });
      moodsWrap.appendChild(b);
    });
    highlightMood();
    renderTracks(true);
  }
  function renderTracks(initial=false){
    tracksWrap.innerHTML = "";
    const idxs = filteredTrackIdxs();
    idxs.forEach(idx=>{
      const t = TRACKS[idx];
      const b=document.createElement("button");
      b.className="pill"; b.textContent=t.title; b.dataset.idx=idx;
      b.addEventListener("click", ()=> selectTrack(idx, state.playing));
      tracksWrap.appendChild(b);
    });
    // í˜„ì¬ ì„ íƒê³¡ì´ í•„í„°ì—ì„œ ë¹ ì¡Œë‹¤ë©´ ì²« ê³¡ìœ¼ë¡œ
    if(!idxs.includes(state.trackIdx) && idxs.length){
      selectTrack(idxs[0], false);
    }
    highlightTrack();
    if(initial){ selectTrack(idxs[0] ?? 0, false); }
  }
  function selectTrack(idx, autoplay=false){ state.trackIdx=idx; player.src=TRACKS[idx].url; highlightTrack(); if(autoplay) tryPlay(); }
  function tryPlay(){ player.play().then(()=>{ state.playing=true; playPause.textContent="ì¼ì‹œì •ì§€"; }).catch(()=>{}); }
  function highlightMood(){ [...moodsWrap.children].forEach(b=>{ b.style.boxShadow = (b.dataset.mood===state.mood) ? "inset 0 0 0 1px #7C9AFF" : "none"; }); }
  function highlightTrack(){ [...tracksWrap.children].forEach(b=>{ b.style.boxShadow = (+b.dataset.idx===state.trackIdx) ? "inset 0 0 0 1px #7C9AFF" : "none"; }); }
  document.getElementById("playPause").addEventListener("click", ()=>{
    if(!player.src) selectTrack(state.trackIdx,false);
    if(!state.playing){ tryPlay(); } else { player.pause(); state.playing=false; playPause.textContent="ì¬ìƒ"; }
  });
  document.getElementById("shuffle").addEventListener("click", ()=>{ state.shuffle=!state.shuffle; shuffleBtn.textContent=state.shuffle?"ëœë¤ ON":"ëœë¤ OFF"; });
  function toggleRepeat(){ const order=["off","one","all"]; const i=order.indexOf(state.repeatMode); state.repeatMode=order[(i+1)%order.length]; updateRepeatUI(); }
  function updateRepeatUI(){ repeatBtn.textContent="ë°˜ë³µ: "+(state.repeatMode==="off"?"êº¼ì§":state.repeatMode==="one"?"í•œê³¡":"ì „ì²´"); player.loop=(state.repeatMode==="one"); }
  updateRepeatUI();
  function onEnded(){
    if(state.repeatMode==="one") return;
    const list = filteredTrackIdxs();
    if(state.shuffle){
      let n = state.trackIdx;
      if(list.length>1){
        while(n===state.trackIdx) n = list[Math.floor(Math.random()*list.length)];
      }
      selectTrack(n,true); return;
    }
    if(state.repeatMode==="all" && list.length){
      const cur = list.indexOf(state.trackIdx);
      const n = list[(cur+1)%cur.length];
      selectTrack(n,true); return;
    }
    state.playing=false; playPause.textContent="ì¬ìƒ";
  }

  /* íƒ€ì´ë¨¸ / ë½€ëª¨ë„ë¡œ */
  function fmt(sec){
    const s=Math.max(0,sec|0);
    const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), ss=s%60;
    const mm=m.toString().padStart(2,'0'); const s2=ss.toString().padStart(2,'0');
    return h>0?`${h}:${mm}:${s2}`:`${mm}:${s2}`;
  }
  function updateTimerUI(){
    timeEl.textContent=fmt(state.remainSec);
    stateEl.textContent=(state.mode==='pomodoro') ? (state.isWork?"ì§‘ì¤‘ì¤‘":"íœ´ì‹ì¤‘") : "íƒ€ì´ë¨¸";
    startPause.textContent=state.running?"ì¼ì‹œì •ì§€":"ì‹œì‘";
    document.title = `${fmt(state.remainSec)} â€¢ Studywithme`;
    window.__presence_broadcastNow?.();
  }
  function beep(){ try{ const ctx=new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(); const g=ctx.createGain(); o.connect(g); g.connect(ctx.destination);
    o.type="sine"; o.frequency.value=880; g.gain.setValueAtTime(.0001,ctx.currentTime); g.gain.exponentialRampToValueAtTime(.3,ctx.currentTime+.01); o.start(); g.gain.exponentialRampToValueAtTime(.0001,ctx.currentTime+.25); o.stop(ctx.currentTime+.3);}catch{} }
  function startTimer(){
    if(state.running) return;
    state.running=true; updateTimerUI();
    state.interval=setInterval(()=>{ 
      if(state.mode==='pomodoro'){
        if(state.remainSec<=0){
          beep();
          const wasWork=state.isWork;
          state.isWork=!state.isWork;
          state.remainSec=state.isWork?state.workSec:state.restSec;
          if(state.isWork && !wasWork){
            state.completedCycles=Math.min(state.totalCycles, state.completedCycles+1);
            updateCyclesBtn();
            if(state.completedCycles>=state.totalCycles){ stopTimer(); }
          }
        } else {
          state.remainSec-=1;
        }
      }else{
        state.remainSec+=1;
      }
      updateTimerUI();
    },1000);
  }
  function stopTimer(){ state.running=false; if(state.interval){ clearInterval(state.interval); state.interval=null; } updateTimerUI(); }
  function resetTimer(){
    stopTimer();
    state.isWork=true;
    state.remainSec = (state.mode==='pomodoro') ? state.workSec : 0;
    updateTimerUI();
  }
  document.getElementById("startPause").addEventListener("click", ()=> state.running?stopTimer():startTimer());
  document.getElementById("reset").addEventListener("click", resetTimer);
  function updateCyclesBtn(){ cyclesBtn.textContent = `${state.completedCycles}/${state.totalCycles}íšŒ`; }

  function updateWindowToggleUI(){ toggleWindowBtn.textContent = `ì°½ë¬¸: ${state.windowVisible ? "ë³´ì„" : "ìˆ¨ê¹€"}`; windowBox.style.display = state.windowVisible ? "" : "none"; }
  function updateCharacterToggleUI(){ toggleCharacterBtn.textContent = `ìºë¦­í„°: ${state.characterVisible ? "ë³´ì„" : "ìˆ¨ê¹€"}`; characterBox.style.display = state.characterVisible ? "" : "none"; }

  /* ===== ë ˆì´ì•„ì›ƒ í¸ì§‘/ì›ë³µ(íƒ€ì´ë¨¸ ìœ ì§€) ===== */
  function setupLayoutDrag(){
    const APP = document.getElementById('app');
    const DRAG_IDS = ['timer','board','window','character','music-controls'];
    const RESIZE_IDS = ['window','character'];
    const Z_TOP_CAP = 8999;

    const registry = new Map();
    let editOn = false;
    let zTop = 100;

    const posKey = id => `pos-${id}`;

    function restorePositionsOnLoad(){
      DRAG_IDS.forEach(id=>{
        const el = document.getElementById(id);
        if(!el) return;
        const saved = localStorage.getItem(posKey(id));
        if(saved){
          const {left, top, width} = JSON.parse(saved);
          absolutize(el);
          place(el, left, top, width);
        }
      });
    }

    function absolutize(el){
      if(registry.has(el.id)) return;
      const rect = el.getBoundingClientRect();
      const appRect = APP.getBoundingClientRect();

      const ph = document.createElement('div');
      ph.style.width  = rect.width + 'px';
      ph.style.height = rect.height + 'px';
      ph.style.visibility = 'hidden';
      el.parentNode.insertBefore(ph, el);

      el.style.position = 'absolute';
      el.style.width    = rect.width + 'px';
      el.style.left     = (rect.left - appRect.left + window.scrollX) + 'px';
      el.style.top      = (rect.top  - appRect.top  + window.scrollY) + 'px';
      el.style.zIndex   = (parseInt(el.style.zIndex||'10',10));
      APP.appendChild(el);

      if(el.classList.contains('resizable') && !el.querySelector('.resizer')){
        const rz = document.createElement('div');
        rz.className = 'resizer';
        el.appendChild(rz);
      }

      registry.set(el.id, {el, placeholder: ph});
    }

    function place(el, left, top, width){
      if(width) el.style.width = width + 'px';
      el.style.left = left + 'px';
      el.style.top  = top  + 'px';
    }

    function setEditable(on){
      editOn = on;
      document.getElementById('app').classList.toggle('edit-on', on);
      layoutEditBtn.textContent = `ë°°ì¹˜ í¸ì§‘: ${on ? 'ì¼œì§' : 'êº¼ì§'}`;

      DRAG_IDS.forEach(id=>{
        const el = document.getElementById(id);
        if(!el) return;

        if(on){
          if(!registry.has(id)) absolutize(el);
          el.classList.add('draggable');
          enableDrag(el);
          if(RESIZE_IDS.includes(id)) enableResize(el);
        }else{
          el.classList.remove('draggable');
          disableDrag(el);
          if(RESIZE_IDS.includes(id)) disableResize(el);
        }
      });

      document.querySelectorAll('.prop').forEach(el=>{
        if(on){ enableDrag(el); enableResize(el); }
        else  { disableDrag(el); disableResize(el); }
      });
    }

    window.__layoutSetEditable = setEditable;
    window.__layoutFocus = (pid)=>{
      const el = document.querySelector(`.prop[data-pid="${pid}"]`);
      if(!el) return;
      el.style.zIndex = Math.min(++zTop, Z_TOP_CAP);
      el.classList.add('selected');
      setTimeout(()=> el.classList.remove('selected'), 1500);
      el.scrollIntoView?.({behavior:'smooth', block:'center', inline:'center'});
    };

    function enableDrag(el){
      if(el._dragBound) return;
      const onDown = (e)=>{
        if(!editOn) return;
        if(e.target.classList && e.target.classList.contains('resizer')) return;

        e.preventDefault();
        el.classList.add('dragging');
        el.style.zIndex = Math.min(++zTop, Z_TOP_CAP);

        const startX = (e.touches? e.touches[0].clientX : e.clientX);
        const startY = (e.touches? e.touches[0].clientY : e.clientY);
        const startLeft = parseFloat(el.style.left)||0;
        const startTop  = parseFloat(el.style.top)||0;

        const move = (ev)=>{
          const cx = (ev.touches? ev.touches[0].clientX : ev.clientX);
          const cy = (ev.touches? ev.touches[0].clientY : ev.clientY);
          const dx = cx - startX;
          const dy = cy - startY;
          place(el, startLeft + dx, startTop + dy);
        };
        const up = ()=>{
          document.removeEventListener('pointermove', move);
          document.removeEventListener('pointerup', up);
          document.removeEventListener('touchmove', move);
          document.removeEventListener('touchend', up);
          el.classList.remove('dragging');
          persistPos(el);
        };

        document.addEventListener('pointermove', move);
        document.addEventListener('pointerup', up);
        document.addEventListener('touchmove', move, {passive:false});
        document.addEventListener('touchend', up);
      };
      el.addEventListener('pointerdown', onDown);
      el.addEventListener('touchstart', onDown, {passive:false});
      el._dragBound = onDown;
    }
    function disableDrag(el){
      if(!el._dragBound) return;
      el.removeEventListener('pointerdown', el._dragBound);
      el.removeEventListener('touchstart', el._dragBound);
      delete el._dragBound;
    }

    function enableResize(el){
      if(el._resizeBound) return;
      const onDown = (e)=>{
        if(!editOn) return;
        if(!e.target.classList || !e.target.classList.contains('resizer')) return;
        e.preventDefault();
        el.classList.add('dragging');
        el.style.zIndex = Math.min(++zTop, Z_TOP_CAP);

        const startX = (e.touches? e.touches[0].clientX : e.clientX);
        const startWidth = parseFloat(el.style.width) || el.getBoundingClientRect().width;

        const move = (ev)=>{
          const cx = (ev.touches? ev.touches[0].clientX : ev.clientX);
          const dx = cx - startX;
          const newW = Math.max(120, startWidth + dx);  // ìµœì†Œí¬ê¸° ìœ ì§€
          el.style.width = newW + 'px';
        };
        const up = ()=>{
          document.removeEventListener('pointermove', move);
          document.removeEventListener('pointerup', up);
          document.removeEventListener('touchmove', move);
          document.removeEventListener('touchend', up);
          el.classList.remove('dragging');
          persistPos(el);
        };

        document.addEventListener('pointermove', move);
        document.addEventListener('pointerup', up);
        document.addEventListener('touchmove', move);
        document.addEventListener('touchend', up);
      };
      el.addEventListener('pointerdown', onDown);
      el.addEventListener('touchstart', onDown, {passive:false});
      el._resizeBound = onDown;
    }
    function disableResize(el){
      if(!el._resizeBound) return;
      el.removeEventListener('pointerdown', el._resizeBound);
      el.removeEventListener('touchstart', el._resizeBound);
      delete el._resizeBound;
    }

    function persistPos(el){
      const left = parseFloat(el.style.left)||0;
      const top  = parseFloat(el.style.top)||0;
      const width= parseFloat(el.style.width)||el.getBoundingClientRect().width;

      if(el.classList.contains('prop')){
        const id = el.dataset.pid;
        const idx = state.props.findIndex(p=>p.id===id);
        if(idx>=0){ state.props[idx].left=left; state.props[idx].top=top; state.props[idx].width=width; }
        localStorage.setItem('props-v1', JSON.stringify(state.props));
      }else{
        localStorage.setItem(`pos-${el.id}`, JSON.stringify({left, top, width}));
      }
    }

    // í™”ë©´ì„¤ì • ì›ìƒë³µêµ¬(íƒ€ì´ë¨¸ ìœ ì§€)
    layoutResetBtn.addEventListener('click', ()=>{
      const snap = {
        mode: state.mode, isWork: state.isWork, running: state.running,
        workSec: state.workSec, restSec: state.restSec, remainSec: state.remainSec,
        totalCycles: state.totalCycles, completedCycles: state.completedCycles
      };
      sessionStorage.setItem('timer-keep', JSON.stringify(snap));

      DRAG_IDS.forEach(id=> localStorage.removeItem(`pos-${id}`));
      localStorage.removeItem('props-v1');
      localStorage.removeItem('ui-window-visible');
      localStorage.removeItem('ui-character-visible');
      location.reload();
    });

    layoutEditBtn.addEventListener('click', ()=> setEditable(!editOn));
    restorePositionsOnLoad();
  }

  /* ì†Œí’ˆ(ì¤‘ì•™ "ìµœì†Œí¬ê¸°" ë°°ì¹˜ + ì¦‰ì‹œ í¸ì§‘) */
  function renderProps(){
    propsLayer.innerHTML = '';
    state.props.forEach(p=>{
      const el = document.createElement('div');
      el.className = 'prop resizable';
      el.dataset.pid = p.id;
      el.style.left = (p.left ?? 40) + 'px';
      el.style.top  = (p.top  ?? 40) + 'px';
      el.style.width= (p.width?? 120) + 'px';
      el.style.zIndex = 80;

      const img = document.createElement('img');
      img.src = p.url; img.alt = 'prop';
      el.appendChild(img);

      const rz = document.createElement('div'); rz.className='resizer'; el.appendChild(rz);
      propsLayer.appendChild(el);
    });
    renderPropList();
    // í¸ì§‘ ëª¨ë“œì—ì„œ ì¶”ê°€ëœ ì†Œí’ˆë„ ì¦‰ì‹œ ë“œë˜ê·¸/ë¦¬ì‚¬ì´ì¦ˆ ê°€ëŠ¥í•˜ê²Œ
    if(document.getElementById('app').classList.contains('edit-on')){
      document.querySelectorAll('.prop').forEach(el=>{
        // ì•„ë˜ ë‘ í•¨ìˆ˜ëŠ” setupLayoutDrag ë‚´ì—ì„œ ì •ì˜/ë°”ì¸ë”©ë¨
        // ì¬ë°”ì¸ë”© ìœ ë„: í¸ì§‘ëª¨ë“œ í† ê¸€ í•œë²ˆ ê»ë‹¤ ì¼¬
      });
    }
  }
  function renderPropList(){
    propList.innerHTML = '';
    state.props.forEach(p=>{
      const row = document.createElement('div'); row.className='todo';
      const tx  = document.createElement('div'); tx.className='txt';
      tx.innerHTML = `<img src="${p.url}" style="width:28px;height:28px;object-fit:contain;vertical-align:middle;margin-right:.5rem"> ${p.id}`;
      const del = document.createElement('button'); del.className='del'; del.textContent='ì‚­ì œ';
      del.addEventListener('click', ()=>{
        const idx = state.props.findIndex(x=>x.id===p.id);
        if(idx>=0) state.props.splice(idx,1);
        localStorage.setItem('props-v1', JSON.stringify(state.props));
        renderProps();
      });
      row.append(tx, del);
      propList.appendChild(row);
    });
  }
  function addProp(url, center=true, opts={}){
    const id = 'prop-' + Date.now().toString(36);
    const MINW = 120;
    let left=40, top=40, width=MINW;  // ìµœì†Œí¬ê¸°
    if(center){
      const appRect = document.getElementById('app').getBoundingClientRect();
      left = Math.max(0, Math.floor((appRect.width - width)/2));
      top  = Math.max(0, Math.floor((appRect.height - width)/2));
    }
    state.props.push({id, url, left, top, width});
    localStorage.setItem('props-v1', JSON.stringify(state.props));
    renderProps();

    if(opts.autoEdit){
      window.__layoutSetEditable?.(true);  // í¸ì§‘ ëª¨ë“œ ì¼œê¸°
      // ì¡°ê¸ˆ ë’¤ì— í¬ì»¤ìŠ¤(ë Œë” í›„)
      setTimeout(()=> window.__layoutFocus?.(id), 0);
    }
  }

  /* ì‹œì‘ */
  init();
</script>

<!-- ===== Supabase Presence (ì‹¤ì‹œê°„) ===== -->
<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

/* ì‚¬ìš©ìê°€ ì œê³µí•œ í™˜ê²½ë³€ìˆ˜ (êµì²´ ì™„ë£Œ) */
const SUPABASE_URL = "https://jvpasqknlkeyshrevqpg.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2cGFzcWtubGtleXNocmV2cXBnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwNDQyOTMsImV4cCI6MjA3NDYyMDI5M30.7zKRGoBFjoWksoRXjUj8n4KzLXdiF86lZwneNdZNF5k";

const presencePanel = document.getElementById("presencePanel");
const meNickEl      = document.getElementById("meNick");
const presenceList  = document.getElementById("presenceList");
const presenceToggle= document.getElementById("presenceToggle");
const nicknameInput = document.getElementById("nickname");

let supabase = null;
let channel  = null;
let heartbeat= null;

/* ê¸°ë³¸ ON: ë¡œë“œ ì‹œ ìë™ ì—°ê²° */
window.addEventListener('load', ()=>{ if(cfgReady()) goOnline(); });

function cfgReady(){
  return SUPABASE_URL.startsWith("https://") && !!SUPABASE_ANON_KEY;
}
function getSnapshot(){
  const st = window.state || {};
  let study = null;
  if(st.shareStudy){
    if(st.mode==='timer'){
      study = st.remainSec||0;                       // ì¹´ìš´íŠ¸ì—… ì „ì²´ ê²½ê³¼
    }else if(st.mode==='pomodoro' && st.isWork){
      study = Math.max(0,(st.workSec|0) - (st.remainSec|0)); // í˜„ì¬ ì§‘ì¤‘ ê²½ê³¼
    }
  }
  const status = (st.mode==='pomodoro') ? (st.isWork ? "work" : "break") : "timer";
  return { status, study };
}
function fmtMin(sec){ return `${Math.floor((sec|0)/60)}ë¶„`; }

function applyScaleToTarget(){
  // íšŒì „ í›„ ì¹˜ìˆ˜: width = 100vh, height = 100vw â†’ 1000Ã—2200 ì•ˆì— ë§ì¶¤
  const vh = Math.max(1, window.innerHeight);
  const vw = Math.max(1, window.innerWidth);
  let s = Math.min(ROTATE_BASE_WIDTH / vh, ROTATE_BASE_HEIGHT / vw);

  // ì‘ì€ í™”ë©´ì´ë©´ ì‚´ì§ ë” í‚¤ì›Œì„œ ê°€ë…ì„± í™•ë³´
  if (isSmallPhone()) s *= MOBILE_ZOOM;

  // ê³¼ë„ í™•ëŒ€ ë°©ì§€
  s = Math.min(s, 2);

  const app = document.getElementById('app');
  app.style.transform = `rotate(90deg) translateY(-100%) scale(${s})`;
}

// âœ… ì˜ˆì „ ì½”ë“œ í˜¸í™˜ìš© (íŒŒì¼ì— applyScaleTo1100ë§Œ í˜¸ì¶œí•˜ê³  ìˆì–´ë„ ë™ì‘í•˜ê²Œ)
function applyScaleTo1100(){ applyScaleToTarget(); }
  
function renderOnline(presenceState){
  const items = [];
  for(const [nick, metas] of Object.entries(presenceState)){
    const meta = metas[metas.length-1] || {};
    const status = meta?.status || "idle";
    const study  = typeof meta?.study  === "number" ? meta.study  : null;

    let rightTxt = "";
    if(status === "break"){
      rightTxt = "íœ´ì‹ì¤‘";
    }else{
      rightTxt = "ê³µë¶€ì¤‘";
      if(study!=null) rightTxt += ` Â· ${fmtMin(study)}`;
    }

    items.push(
      `<div class="person">
         <div><span class="${status==="work"?"dot work":status==="break"?"dot break":"dot"}"></span><span class="nick">${nick}</span></div>
         <div style="opacity:.8">${rightTxt}</div>
       </div>`
    );
  }
  presenceList.innerHTML = items.slice(0,5).join("") || `<div style="opacity:.8">ì•„ì§ ì•„ë¬´ë„ ì—†ì–´ìš”</div>`;
}

window.__presence_broadcastNow = async function(){
  if(!channel) return;
  try{ await channel.track(getSnapshot()); }catch{}
};
window.__presence_goOnline = goOnline;
window.__presence_goOffline = goOffline;

async function goOnline(){
  if(!cfgReady()){ return; }
  if(!supabase) supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const myNick = (nicknameInput.value || "").trim() || "anonymous";
  meNickEl.textContent = myNick;
  presencePanel.style.display = "block";

  channel = supabase.channel("studyroom", { config: { presence: { key: myNick } } });
  channel.on("presence", { event: "sync" }, ()=>{ renderOnline(channel.presenceState()); });

  channel.subscribe(async (status)=>{
    if(status === "SUBSCRIBED"){
      try{ await channel.track(getSnapshot()); }catch{}
      heartbeat = setInterval(async ()=>{ try{ await channel.track(getSnapshot()); }catch{} }, 15000);
    }
  });

  presenceToggle.textContent = "ê³µê°œ: ì¼œì§";
}
async function goOffline(){
  if(heartbeat){ clearInterval(heartbeat); heartbeat = null; }
  if(channel){ try{ await channel.unsubscribe(); }catch{} }
  channel = null;
  presenceToggle.textContent = "ê³µê°œ: êº¼ì§";
  presencePanel.style.display = "none";
  presenceList.innerHTML = "";
}

presenceToggle?.addEventListener("click", async ()=>{
  if(!channel){ await goOnline(); } else { await goOffline(); }
});
</script>
</body>
</html>
