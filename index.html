<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>감각적인 뽀모도로</title>

<!-- 손글씨 폰트 -->
<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand:wght@400&family=Nanum+Pen+Script&display=swap" rel="stylesheet">

<style>
  :root{
    --bg-url: url("https://png.pngtree.com/thumb_back/fh260/background/20200821/pngtree-pure-black-background-wallpaper-image_396550.jpg");
    --ink: #666;
    --ink-sub: rgba(33,33,33,.8);
    --top-gap: 12px;
    --content-top: 20vh;

    /* 높이/너비 맥스 규칙 */
    --maxh-board: 30vh;
    --maxh-timer: 35vh;
    --maxh-window: 40vh;
    --maxh-char: 50vh;

    --maxw-board: 25vw;
    --maxw-window: 15vw;
    --maxw-timer: 35vw;
    --maxw-char: 70vw;
  }

  *{box-sizing:border-box}
  html,body{
    height:100%; margin:0; color:var(--ink);
    font-family: "Patrick Hand","Nanum Pen Script", system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Arial, sans-serif;
    background:#000;
    /* 화면 축소 시 전체 폰트도 함께 축소 */
    font-size: clamp(12px, 1.6vw, 14px);
    letter-spacing:.02em;
  }

  /* 배경: 유리(블러) 제거 */
  #app{
    position:relative; height:100dvh; overflow:hidden;
    background-image:
      linear-gradient(to bottom, rgba(38,27,31,.2), rgba(38,27,31,.2)),
      var(--bg-url);
    background-size: cover; background-position: center;
  }

  /* 카드/버튼: 그림자 제거, 검정 실선 */
  .card{
    background: rgba(0,0,0,.02);
    border: 2px solid var(--line);
    border-radius: 16px;
  }
  .panel{ padding: 1rem; }

  button, .pill{
    cursor:pointer; user-select:none; outline:0;
    background: rgba(255,255,255,.08); color:var(--ink);
    border: 1px solid var(--line);
    border-radius: 999px;
    padding: .6rem .9rem;
    font-weight: 700;
    font-family: inherit;        /* 버튼 폰트도 손글씨 */
    font-size: 1rem;             /* 루트 폰트와 함께 축소 */
    outline: none;
  }
  
  
  input, textarea, select{ font-family: inherit; font-size: 1rem; }

  .row{display:flex; gap:.75rem; align-items:center}
  .hwrap{ display:flex; gap:.5rem; align-items:center; overflow-x:auto; }
  .title{font-weight:900; font-size: 1.125rem}

  /* ===== 상단 정렬: 햄버거(좌) / 타이머(중앙) / Todo list(우) ===== */
  #topbar{
    position:absolute; left:12px; right:12px; top: var(--top-gap);
    display:grid; grid-template-columns: 1fr auto 1fr; align-items:start; gap:12px; z-index:10;
  }
  #hamburger{
    justify-self:start; width:3.4rem; height:3.4rem; display:grid; place-items:center; font-size:1.2rem;
  }

  /* 타이머(가로 중앙, 상단선 동일, 높이 맥스) */
  #timer{
    justify-self:center;
    width: min(var(--maxw-timer), 90vw);
    max-height: var(--maxh-timer);
    display:flex; flex-direction:column; align-items:center; gap:.6rem; text-align:center;
    overflow:hidden;
  }
  #state{ font-size: 1.25rem; font-weight:900; }
  #time{ font-weight:900; font-size: clamp(2.2rem, 6vw, 4rem); line-height:1; }

  /* Todo list: 우정렬, 입력줄은 항상 하단(3행 그리드) */
  #board{
    justify-self:end;
    width: min(var(--maxw-board), 92vw);
    max-height: var(--maxh-board);
    display:grid; grid-template-rows: auto 1fr auto;
    overflow:hidden;
  }
  #board .title{margin:0 0 .5rem 0}
  #todo-list{ overflow:auto; padding-right:2px; scrollbar-width: thin; }
  .todo{display:flex; align-items:center; gap:.5rem; padding:.45rem 0; border-bottom:1px solid rgba(255,255,255,.15)}
  .todo:last-child{border-bottom:0}
  .todo .txt{flex:1}
  .todo .del{background:transparent; border:0; color:var(--ink-sub); padding:.3rem .5rem; border-radius:.6rem}
  .todo .del:hover{background:rgba(255,255,255,.12); color:#fff}

  /* << 입력은 '항상 맨 아래' >> */
  #inputRow{ display:flex; gap:.5rem; align-items:center; padding-top:.6rem; }
  #board input[type="text"]{
    width:100%; background:transparent; border: 2px solid var(--line); border-radius: 12px;
    color:#fff; padding:.5rem .6rem;
  }

  /* ===== 메인: 창문(좌) + 캐릭터(중앙) — 같은 top, 맥스 규칙, 비율 유지 ===== */
  #window{
    position:absolute; left:2vw; top: var(--content-top); z-index:5;
    width: min(var(--maxw-window), 90vw);
  }
  #win-img{
    display:block; width:100%; height:auto; max-height: var(--maxh-window);
    border-radius:16px; border:2px solid var(--line);
  }

  #character{
    position:absolute; left:50%; transform:translateX(-50%);
    top: calc(var(--content-top) + 15vh); z-index:6;
    width: min(var(--maxw-char), 96vw);
  }
  #char-img{
    display:block; width:100%; height:auto; max-height: var(--maxh-char);
    border-radius:18px; border:2px solid var(--line);
    background:transparent center/contain no-repeat;
  }

  /* ===== 하단 고정: 재생 / 음악스타일 / 곡 선택 — 가로 정렬 ===== */
  #bottombar{
    position:fixed; left:12px; right:12px; bottom: 8px;
    display:flex; gap:12px; justify-content:center; align-items:flex-end; z-index:12;
  }
  #bottombar .card{ flex:1 1 0; min-width:260px; }
  #bottombar h4{ margin:0 0 .5rem 0; font-size: 1.125rem; font-weight:900 }

  /* 반응형(폰트/요소는 이미 clamp·vw로 축소됨) */
  @media (max-width: 720px){
    :root{
      --content-top: 14vh;
      --maxw-char: 90vw;
    }
    #bottombar{ flex-direction:column; }
    #bottombar .card{ width:100%; }
  }
</style>
</head>
<body>
<div id="app">

  <!-- 상단: 햄버거 / 타이머 / Todo list (상단선 동일) -->
  <div id="topbar">
    <button id="hamburger" class="card panel" aria-label="메뉴 열기">⋯</button>

    <section id="timer" class="card panel" aria-label="타이머">
      <div id="state">집중중</div>
      <div id="time">25:00</div>
      <div class="row">
        <button class="pill" id="startPause">시작</button>
        <button class="pill" id="reset">리셋</button>
      </div>
    </section>

    <section id="board" class="card panel" aria-label="Todo list">
      <div class="title">Todo list</div>
      <div id="todo-list"></div>
      <!-- 입력은 항상 카드 맨 아래 (grid 3행) -->
      <div id="inputRow">
        <input id="todo-input" type="text" placeholder="할 일을 적고 Enter" />
        <button id="todo-add" class="pill" title="추가">＋</button>
      </div>
    </section>
  </div>

  <!-- 메인: 창문(좌) + 캐릭터(중앙) -->
  <div id="window"><img id="win-img" alt="창문" /></div>
  <div id="character"><img id="char-img" alt="캐릭터" /></div>

  <!-- 하단: 재생 / 스타일 / 곡선택 (가로 고정) -->
  <div id="bottombar">
    <section id="music-controls" class="card panel" aria-label="음악 재생">
      <h4>음악 재생</h4>
      <div class="hwrap">
        <button class="pill" id="playPause">재생</button>
        <button class="pill" id="shuffle">랜덤 OFF</button>
        <button class="pill" id="repeat">반복: 꺼짐</button>
      </div>
      <audio id="player" preload="metadata"></audio>
    </section>

    <section id="music-styles" class="card panel" aria-label="음악 스타일">
      <h4>음악 스타일</h4>
      <div class="hwrap" id="moods"></div>
    </section>

    <section id="track-list" class="card panel" aria-label="곡 선택">
      <h4>곡 선택</h4>
      <div class="hwrap" id="tracks"></div>
    </section>
  </div>
</div>

<script>
  /* 무료 상업 사용 가능(FreePD) 트랙 */
  const TRACKS = [
    { title: "Bass Meant Jazz",     mood: "Jazz",  url: "https://freepd.com/music/Bass%20Meant%20Jazz.mp3" },
    { title: "Stompin at Midnight", mood: "Jazz",  url: "https://freepd.com/music/Stompin%20at%20Midnight.mp3" },
    { title: "Abstract Anxiety",    mood: "Loud",  url: "https://freepd.com/music/Abstract%20Anxiety.mp3" },
    { title: "Adding the Sun",      mood: "Lo-Fi", url: "https://freepd.com/music/Adding%20the%20Sun.mp3" },
    { title: "Bleu",                mood: "Lo-Fi", url: "https://freepd.com/music/Bleu.mp3" },
    { title: "Study and Relax",     mood: "Lo-Fi", url: "https://freepd.com/music/Study%20and%20Relax.mp3" },
    { title: "Deep Focus",          mood: "Lo-Fi", url: "https://freepd.com/music/Deep%20Focus.mp3" }
  ];

  /* 이미지 A/B (0.5초 교차) */
  let charA = "https://github.com/nihicheli/studywithme/blob/main/image/Group%209213.png?raw=true";
  let charB = "https://github.com/nihicheli/studywithme/blob/main/image/Group%209214.png?raw=true";
  let winA  = "https://github.com/nihicheli/studywithme/blob/main/image/Group%209215.png?raw=true";
  let winB  = "https://github.com/nihicheli/studywithme/blob/main/image/Group%209216.png?raw=true";
  let showA = true, showWinA = true, blinkTimer = null;

  const state = {
    isWork: true, running: false,
    workSec: 25*60, restSec: 5*60, remainSec: 25*60,
    interval: null, shuffle: false, playing: false,
    mood: "Lo-Fi", trackIdx: 0,
    repeatMode: "off", // off | one | all
    todos: JSON.parse(localStorage.getItem("todos-v1")||"[]")
  };

  /* elements */
  const boardList = document.getElementById("todo-list");
  const todoInput = document.getElementById("todo-input");
  const todoAdd = document.getElementById("todo-add");
  const charImg = document.getElementById("char-img");
  const winImg  = document.getElementById("win-img");
  const timeEl = document.getElementById("time");
  const stateEl = document.getElementById("state");
  const startPause = document.getElementById("startPause");
  const resetBtn = document.getElementById("reset");
  const playPause = document.getElementById("playPause");
  const shuffleBtn = document.getElementById("shuffle");
  const repeatBtn = document.getElementById("repeat");
  const moodsWrap = document.getElementById("moods");
  const tracksWrap = document.getElementById("tracks");
  const player = document.getElementById("player");

  function init(){
    // 이미지 교차 (원본 비율은 <img>가 유지)
    charImg.src = charA;
    winImg.src  = winA;
    blinkTimer = setInterval(()=>{
      showA = !showA; charImg.src = showA ? charA : charB;
      showWinA = !showWinA; winImg.src = showWinA ? winA : winB;
    }, 500);

    renderTodos();

    // 음악 UI
    ["Lo-Fi","Jazz","Loud","Piano"].forEach(m=>{
      const b = document.createElement("button");
      b.className = "pill"; b.textContent = m; b.dataset.mood = m;
      b.addEventListener("click", ()=>{ state.mood = m; highlightMood(); });
      moodsWrap.appendChild(b);
    });
    TRACKS.forEach((t, idx)=>{
      const b = document.createElement("button");
      b.className = "pill"; b.textContent = t.title; b.dataset.idx = idx;
      b.addEventListener("click", ()=> selectTrack(idx, state.playing));
      tracksWrap.appendChild(b);
    });
    selectTrack(0, false);
    highlightMood(); highlightTrack();

    updateTimerUI();
    updateRepeatUI();

    // 종료/에러 핸들
    player.addEventListener("ended", onEnded);
    player.addEventListener("error", ()=> {
      const next = (state.trackIdx + 1) % TRACKS.length;
      selectTrack(next, true);
    });

    // 반복 버튼
    repeatBtn.addEventListener("click", toggleRepeat);
  }

  /* To-Do */
  function renderTodos(){
    boardList.innerHTML = "";
    if(state.todos.length === 0){ return; }
    state.todos.forEach((t,idx)=>{
      const row = document.createElement("div");
      row.className = "todo";
      const cb = document.createElement("input"); cb.type = "checkbox"; cb.checked = !!t.done;
      cb.addEventListener("change", ()=>{ t.done = cb.checked; persistTodos(); renderTodos(); });
      const tx = document.createElement("div"); tx.className="txt"; tx.textContent = t.text;
      tx.style.textDecoration = t.done ? "line-through" : "none";
      tx.style.opacity = t.done ? ".6" : "1";
      const del = document.createElement("button"); del.className="del"; del.title="삭제"; del.textContent="삭제";
      del.addEventListener("click", ()=>{ state.todos.splice(idx,1); persistTodos(); renderTodos(); });
      row.append(cb, tx, del); boardList.appendChild(row);
    });
  }
  function persistTodos(){ localStorage.setItem("todos-v1", JSON.stringify(state.todos)); }
  function addTodo(){
    const v = todoInput.value.trim(); if(!v) return;
    state.todos.push({text:v, done:false}); todoInput.value = "";
    persistTodos(); renderTodos();
  }
  todoAdd.addEventListener("click", addTodo);
  todoInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ addTodo() } });

  /* 음악 */
  function selectTrack(idx, autoplay=false){
    state.trackIdx = idx;
    player.src = TRACKS[idx].url;
    highlightTrack();
    if(autoplay){ tryPlay(); }
  }
  function tryPlay(){
    player.play().then(()=>{
      state.playing = true; playPause.textContent = "일시정지";
    }).catch(err=>{ console.warn("재생 실패:", err); });
  }
  function highlightMood(){
    [...moodsWrap.children].forEach(b=>{
      b.style.boxShadow = (b.dataset.mood === state.mood)
        ? "inset 0 0 0 1px #7C9AFF"   // 선택된 버튼 → 안쪽 파란 테두리
        : "none";                     // 선택되지 않은 버튼 → 효과 없음
    });
  }
  function highlightTrack(){
    [...tracksWrap.children].forEach(b=>{
      b.style.boxShadow = (Number(b.dataset.idx) === state.trackIdx)
        ? "inset 0 0 0 1px #7C9AFF"   // 선택된 곡 → 안쪽 파란 테두리
        : "none";                     // 나머지 → 효과 없음
    });
  }

  playPause.addEventListener("click", ()=>{
    if(!player.src) selectTrack(state.trackIdx, false);
    if(!state.playing){ tryPlay(); }
    else { player.pause(); state.playing=false; playPause.textContent="재생"; }
  });
  shuffleBtn.addEventListener("click", ()=>{
    state.shuffle = !state.shuffle;
    shuffleBtn.textContent = state.shuffle ? "랜덤 ON" : "랜덤 OFF";
  });

  // 반복 모드
  function toggleRepeat(){
    const order = ["off","one","all"];
    const i = order.indexOf(state.repeatMode);
    state.repeatMode = order[(i+1)%order.length];
    updateRepeatUI();
  }
  function updateRepeatUI(){
    repeatBtn.textContent =
      "반복: " + (state.repeatMode === "off" ? "꺼짐" : state.repeatMode === "one" ? "한곡" : "전체");
    player.loop = state.repeatMode === "one";
  }
  function onEnded(){
    if (state.repeatMode === "one") return; // loop=true 이므로 자동반복
    if (state.shuffle) {
      let next = state.trackIdx;
      if (TRACKS.length > 1) {
        while (next === state.trackIdx) next = Math.floor(Math.random() * TRACKS.length);
      }
      selectTrack(next, true);
      return;
    }
    if (state.repeatMode === "all") {
      const next = (state.trackIdx + 1) % TRACKS.length;
      selectTrack(next, true);
      return;
    }
    // off: 멈춤
    state.playing = false; playPause.textContent = "재생";
  }

  /* 타이머 */
  function fmt(sec){
    const s = Math.max(0, sec|0);
    const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), ss= s%60;
    const mm = m.toString().padStart(2,'0'); const s2 = ss.toString().padStart(2,'0');
    return h>0 ? `${h}:${mm}:${s2}` : `${mm}:${s2}`;
  }
  function updateTimerUI(){
    timeEl.textContent = fmt(state.remainSec);
    stateEl.textContent = state.isWork ? "집중중" : "휴식중";
    startPause.textContent = state.running ? "일시정지" : "시작";
  }
  function beep(){
    try{
      const ctx = new (window.AudioContext||window.webkitAudioContext)();
      const o = ctx.createOscillator(); const g = ctx.createGain();
      o.connect(g); g.connect(ctx.destination);
      o.type="sine"; o.frequency.value=880; g.gain.setValueAtTime(0.0001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.3, ctx.currentTime+0.01);
      o.start(); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.25);
      o.stop(ctx.currentTime+0.3);
    }catch(e){}
  }
  function startTimer(){
    if(state.running) return;
    state.running = true; updateTimerUI();
    state.interval = setInterval(()=>{
      if(state.remainSec<=0){
        beep();
        state.isWork = !state.isWork;
        state.remainSec = state.isWork? state.workSec : state.restSec;
      }else{
        state.remainSec -= 1;
      }
      updateTimerUI();
    }, 1000);
  }
  function stopTimer(){
    state.running = false; if(state.interval){ clearInterval(state.interval); state.interval=null; }
    updateTimerUI();
  }
  function resetTimer(){
    stopTimer(); state.isWork = true; state.remainSec = state.workSec; updateTimerUI();
  }
  document.getElementById("startPause").addEventListener("click", ()=> state.running ? stopTimer() : startTimer());
  document.getElementById("reset").addEventListener("click", resetTimer);

  /* 시작 */
  init();
</script>
</body>
</html>
