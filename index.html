<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Studywithme</title>

<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand:wght@400&family=Nanum+Pen+Script:wght@400;700&display=swap" rel="stylesheet">

<style>

  /* ë‹¤í¬ëª¨ë“œ ë””í´íŠ¸ ì„¤ì • */
  :root{
    --bg-url: url("https://github.com/nihicheli/studywithme/blob/main/image/background%205.png?raw=true");
    --ink: #FBFFF4;
    --ink-sub: rgba(255,255,255,.7); /* ë‹¤í¬ëª¨ë“œì— ë§ì¶° ì‰í¬ ì„œë¸Œìƒ‰ ë³€ê²½ */
    --line: transparent;
    --top-gap: 12px;
    --content-top: 20vh;

    /* ë°ìŠ¤í¬í†± ê¸°ë³¸ê°’ */
    --maxh-board: 80vh;
    --maxh-timer: 35vh;
    --maxh-window: 40vh;
    --maxh-char: 50vh;

    --maxw-board: 25vw;
    --maxw-window: 15vw;
    --maxw-timer: 35vw;
    --maxw-char: 70vw;
  }
  :root[data-theme="light"]{
    --ink:#202020;
    --ink-sub:rgba(0,0,0,.7);
    --line:transparent;
  }

  *{box-sizing:border-box}
  html,body{
    height:100%; margin:0; color:var(--ink);
    font-family:"Patrick Hand","Nanum Pen Script",system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Arial,sans-serif;
    background:#000;
    /* 4. ëª¨ë°”ì¼ í°íŠ¸ í¬ê¸° ì¡°ì • */
    font-size:clamp(10px, 4vw, 14.4px);
    letter-spacing:.02em;
  }

  /* ë°°ê²½ + 10% ê²€ì • ì˜¤ë²„ë ˆì´ */
  #app{
    position:relative; height:100dvh; overflow:hidden;
    background-image:
      linear-gradient(rgba(0,0,0,.10), rgba(0,0,0,.10)),
      var(--bg-url);
    background-size:cover; background-position:center;
  }

  .card{ background: rgba(0,0,0,.02); border: 2px solid var(--line); border-radius: 16px; }
  .panel{ padding: 1rem; }

  button, .pill{
    cursor:pointer; user-select:none; outline:0; touch-action: manipulation;
    background: rgba(255,255,255,.08); color:var(--ink);
    border: 1px solid var(--line);
    border-radius: 999px;
    padding: .6rem .9rem;
    font-weight: 700;
    font-family: inherit;
    font-size: 1rem;
  }
  /* ì•ˆìª½ í¬ì»¤ìŠ¤ ë§ */
  button:focus, .pill:focus, button:focus-visible, .pill:focus-visible{
    outline: none; box-shadow: inset 0 0 0 1px #7C9AFF;
  }
  *{ -webkit-tap-highlight-color: transparent; }
  input, textarea, select{ font-family: inherit; font-size: 1rem; color:#fff }
  :root[data-theme="light"] input, :root[data-theme="light"] textarea, :root[data-theme="light"] select{ color:#222 }


  .row{display:flex; gap:.75rem; align-items:center; flex-wrap:wrap}
  .hwrap{ display:flex; gap:.5rem; align-items:center; overflow-x:auto; }
  .title{font-weight:900; font-size: 1.125rem}

  /* ìƒë‹¨ ë ˆì´ì•„ì›ƒ â€” ìµœìƒë‹¨ ìœ ì§€ */
  #topbar{
    position:absolute; left:12px; right:12px; top: var(--top-gap);
    display:grid; grid-template-columns: 1fr auto 1fr; align-items:start; gap:12px;
    z-index: 9000;
  }
  #hamburger{ justify-self:start; width:3.4rem; height:3.4rem; display:grid; place-items:center; font-size:1.2rem; position:relative; z-index:9001; }

  /* íƒ€ì´ë¨¸(ê°€ìš´ë°) */
  #timer{
    justify-self:center; width: min(var(--maxw-timer), 90vw); max-height: var(--maxh-timer);
    display:flex; flex-direction:column; align-items:center; gap:.6rem; text-align:center; overflow:hidden;
  }
  #state{ font-size: 1.25rem; font-weight:900; }
  #time{ font-weight:900; font-size: clamp(2.2rem, 6vw, 4rem); line-height:1; }

  /* Todo list(ì˜¤ë¥¸ìª½) */
  #board{
    justify-self:end; width: min(var(--maxw-board), 92vw); max-height: var(--maxh-board);
    display:grid; grid-template-rows: auto 1fr auto; overflow:hidden;
  }
  #board .title{margin:0 0 .5rem 0}
  #todo-list{ overflow:auto; padding-right:2px; scrollbar-width: thin; }
  .todo{display:flex; align-items:center; gap:.5rem; padding:.45rem 0; border-bottom:1px solid rgba(255,255,255,.15)}
  .todo:last-child{border-bottom:0}
  .todo .txt{flex:1}
  .todo .del{background:transparent; border:0; color:var(--ink-sub); padding:.3rem .5rem; border-radius:.6rem}
  .todo .del:hover{background:rgba(255,255,255,.12); color:#fff}
  #inputRow{ display:flex; gap:.5rem; align-items:center; padding-top:.6rem; }
  #board input[type="text"]{ width:100%; background:transparent; border: 2px solid var(--line); border-radius: 12px; color:#fff; padding:.5rem .6rem; }

  /* ì¢Œ: ì°½ë¬¸, ê°€ìš´ë°: ìºë¦­í„° */
  #window{ position:absolute; left:2vw; top: var(--content-top); z-index:5; width: min(var(--maxw-window), 90vw); }
  #win-img{ display:block; width:100%; height:auto; max-height: var(--maxh-window); border-radius:16px; border:2px solid var(--line); }

  #character{ 
    position:absolute; left:50%; 
    /* ë°ìŠ¤í¬í†±: ì¤‘ì•™ ì •ë ¬ */
    transform:translateX(-50%); 
    top: calc(var(--content-top) + 20vh); z-index:6; 
    width: min(var(--maxw-char), 96vw); 
    /* 2. í„°ì¹˜ ì´ë²¤íŠ¸ë¥¼ ìœ„í•´ í¬ì¸í„° ì»¤ì„œ ì¶”ê°€ */
    cursor: pointer;
  }
  #char-img{ 
    /* ë””ìì¸ ë³µì›: srcë¥¼ ì‚¬ìš©í•˜ë©°, ë°°ê²½ì€ íˆ¬ëª…í•˜ê²Œ ìœ ì§€ */
    display:block; width:100%; height:auto; max-height: var(--maxh-char); border-radius:18px; border:2px solid var(--line); 
    background:transparent center/contain no-repeat; 
  }

  /* 2. ë§í’ì„  ìŠ¤íƒ€ì¼ */
  #fortune-bubble {
    /* ìºë¦­í„° ìƒë‹¨ ì¤‘ì•™, íƒ€ì´ë¨¸ ì•„ë˜ì— ìœ„ì¹˜í•˜ë„ë¡ position:absolute ì‚¬ìš© */
    position: absolute;
    /* ë°ìŠ¤í¬í†±/ê¸°ë³¸ ìœ„ì¹˜: ìºë¦­í„° ìƒë‹¨ì—ì„œ 40px ìœ„ */
    top: calc(var(--content-top) + 20vh - 40px); 
    left: 50%;
    transform: translateX(-50%);
    z-index: 9500; /* íƒ€ì´ë¨¸(9000)ë³´ë‹¤ ë†’ê³ , ë“œë¡œì–´(10000)ë³´ë‹¤ ë‚®ê²Œ */
    padding: 0.5rem 1rem;
    background: rgba(255, 255, 255, 0.95);
    color: #202020;
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.5s ease-in-out, visibility 0.5s;
    white-space: nowrap;
    font-weight: 700;
    font-size: 1.1em;
    font-family: 'Nanum Pen Script', cursive; 
    pointer-events: none; /* í´ë¦­ ë°©ì§€ */
  }
  :root[data-theme="dark"] #fortune-bubble {
    background: rgba(30, 30, 30, 0.95);
    color: #FBFFF4;
    box-shadow: 0 4px 12px rgba(255, 255, 255, 0.1);
  }
  #fortune-bubble.show {
    opacity: 1;
    visibility: visible;
  }
  /* ë§í’ì„  ê¼¬ë¦¬ (CSS ì‚¼ê°í˜•) */
  #fortune-bubble::after {
    content: '';
    position: absolute;
    bottom: -10px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 10px solid transparent;
    border-right: 10px solid transparent;
    border-top: 10px solid rgba(255, 255, 255, 0.95);
  }
  :root[data-theme="dark"] #fortune-bubble::after {
    border-top: 10px solid rgba(30, 30, 30, 0.95);
  }


  /* í•˜ë‹¨: ìŒì•…íŒ¨ë„ */
  #bottombar{
    position:fixed; left:12px; right:12px; bottom: 8px;
    display:flex; gap:12px; justify-content:center; align-items:flex-end; z-index:12;
  }
  #bottombar .card{ flex:1 1 0; min-width:260px; }
  #bottombar h4{ margin:0 0 .5rem 0; font-size: 1.125rem; font-weight:900 }

  /* === ì†Œí’ˆ ë ˆì´ì–´ === */
  /* ìš”ì²­: ì†Œí’ˆ ê´€ë ¨ ê¸°ëŠ¥ ìˆ¨ê¹€ (ì£¼ì„ ì²˜ë¦¬) */
  #propsLayer{
    position:absolute; inset:0; z-index:7;
    pointer-events:none; /* ê¸°ë³¸ì€ í´ë¦­ í†µê³¼ */
    display: none; /* ì†Œí’ˆ ë ˆì´ì–´ ìì²´ ìˆ¨ê¹€ */
  }
  .prop{
    position:absolute; left:40px; top:40px; width:120px; z-index:80;
    pointer-events:auto; /* ì†Œí’ˆ ìì²´ëŠ” í´ë¦­ ê°€ëŠ¥ */
  }
  .prop img{ width:100%; height:auto; display:block; }
  .draggable { cursor: move; }
  .dragging  { opacity:.92; }
  .resizer{
    position:absolute; right:-8px; bottom:-8px; width:16px; height:16px;
    border-radius:4px; background:rgba(255,255,255,.75);
    border:1px solid rgba(0,0,0,.3);
    display:none; z-index:3;
  }
  .edit-on .resizable .resizer{ display:block; }

  /* ë“œë¡œì–´/ì˜¤ë²„ë ˆì´ â€” ì ˆëŒ€ ìµœìƒë‹¨ */
  #overlay{ position:fixed; inset:0; background:rgba(0,0,0,.35); opacity:0; pointer-events:none; transition:opacity .2s ease; z-index: 10000; }
  #overlay.show{ opacity:1; pointer-events:auto; }

  #drawer{
    position:fixed; top:0; left:0; bottom:0; width:min(380px, 86vw);
    background:#111; color:#eee; border-right:2px solid var(--line);
    transform:translateX(-100%); transition:transform .24s ease; z-index: 10001;
    display:flex; flex-direction:column; gap:0; overflow-y:auto;
  }
  :root[data-theme="light"] #drawer{ background:#fafafa; color:#222; }
  #drawer.open{ transform:translateX(0) }
  .drawer-head{ display:flex; align-items:center; justify-content:space-between; padding:1rem; border-bottom:2px solid var(--line); }
  .drawer-sec{ padding:1rem; border-bottom:2px dashed rgba(255,255,255,.12); }
  :root[data-theme="light"] .drawer-sec{ border-bottom-color: rgba(0,0,0,.12); }
  .drawer-sec h4{ margin:.2rem 0 .8rem; font-weight:900; }

  .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:.5rem; }
  .drawer-sec input[type="number"], .drawer-sec input[type="text"], .drawer-sec select{
    width:100%; padding:.55rem .7rem; border:2px solid var(--line); border-radius:12px; background:transparent; color:#fff;
  }
  :root[data-theme="light"] .drawer-sec input[type="number"], :root[data-theme="light"] .drawer-sec input[type="text"], :root[data-theme="light"] .drawer-sec select{ color:#222 }
  .fill{ flex:1 }

  .chips{ display:flex; gap:.5rem; align-items:center; flex-wrap: wrap; }
  .chips .pill{ border:1px solid var(--line); border-radius:14px; padding:.5rem .75rem; background:rgba(255,255,255,.06); transition: background .15s ease; }
  .chips .pill:hover{ background:rgba(255,255,255,.12); }
  .list-scroll{ max-height: 40vh; overflow: auto; padding-bottom: .25rem; }
  .list-scroll::-webkit-scrollbar{ width:10px; height:10px; }
  .list-scroll::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.22); border-radius:999px; }
  :root[data-theme="light"] .list-scroll::-webkit-scrollbar-thumb{ background: rgba(0,0,0,.22); }


  a#creditLink{ color:#9db7ff; text-decoration:none; border-bottom:1px dashed #9db7ff; }
  a#creditLink:hover{ opacity:.85; }

  .pill-input{
    width:100%; padding:.6rem .9rem; border:1px solid var(--line); border-radius:999px;
    background: rgba(255,255,255,.08); color:#fff; line-height:1; outline:none;
    transition: background .15s ease, box-shadow .15s ease; -webkit-appearance:none;
  }
  .pill-input::placeholder{ color: rgba(255,255,255,.6); }
  :root[data-theme="light"] .pill-input{ background: rgba(0,0,0,.06); color:#222; }
  :root[data-theme="light"] .pill-input::placeholder{ color: rgba(0,0,0,.5); }
  .pill-input:focus{ box-shadow: inset 0 0 0 3px #7C9AFF; background: rgba(124,154,255,.15); }
  .drawer-sec .row .pill-input{ flex:1; min-width:0; }

  /* íŒŒì¼ ì„ íƒì„ pillì²˜ëŸ¼ */
  .input-file-hidden{
    position:absolute; width:0.1px; height:0.1px;
    opacity:0; overflow:hidden; z-index:-1;
  }
  .file-row{ display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
  .file-pill{ display:inline-flex; align-items:center; gap:.5rem; }
  .file-pill .icon{ font-size:1.1rem; line-height:1; }
  #bgFileName, #propFileName{
    max-width: 10rem;
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    opacity:.8;
  }
  .bg-thumb{
    width:42px; height:28px; border-radius:8px;
    border:1px solid var(--line); background:#000 center/cover no-repeat;
  }

  /* ê°•ì œ ê°€ë¡œ ë³´ê¸°(ì„¸ë¡œì—ì„œ) */
  html.portrait-force, body.portrait-force{
    height:100%;
    overflow-x:auto;
    overflow-y:auto;
  }
  .portrait-force #app{
    width: 100vh;
    height: 100vw;
    transform: rotate(90deg) translateY(-100%);
    transform-origin: top left;
  }

  /* ì˜¤ë¥¸ìª½ ì•„ë˜: ì‹¤ì‹œê°„ íŒ¨ë„ (ë°ìŠ¤í¬í†± ê¸°ë³¸) */
  #presencePanel{
    position: fixed;
    right: 0;
    bottom: calc(8px + 112px);
    width: 25vw;
    max-width: 25vw;
    z-index: 8000;
  }
  #presencePanel .dot{ display:inline-block; width:8px; height:8px; border-radius:999px; margin-right:.4rem; background:#9cccff; }
  #presencePanel .dot.work{ background:#7CFF7C; }
  #presencePanel .dot.break{ background:#FFC66D; }
  /* 1. ì‹¤ì‹œê°„ íŒ¨ë„ ë””ìì¸ ë¡¤ë°±: study timeì´ ë³´ì¼ ë•Œ ê³µê°„ì´ ë¶€ì¡±í•˜ì§€ ì•Šë„ë¡ ì¡°ì • */
  #presenceList .person{ display:flex; justify-content:space-between; gap:.5rem; padding:.25rem 0; }
  #presenceList .nick{ font-weight:700; }

  /* (ì¶”ê°€) í•˜ë‹¨ ì¤‘ì•™ íˆ¬ëª… ë°°ë„ˆ */
  #adBanner{
    position:fixed; left:50%; bottom:0; transform:translateX(-50%);
    width:min(90vw, 970px); height:90px; z-index:1; pointer-events:none;
  }
  /* 3. ë°°ë„ˆ ì´ë¯¸ì§€ íˆ¬ëª…ë„ ë° URL ì—…ë°ì´íŠ¸ */
  #adBanner img{ width:100%; height:100%; opacity:0.2; display:block; } 
  
  /* ë°°ë„ˆ ìœ„ì— í…ìŠ¤íŠ¸ ì¶”ê°€ */
  .ad-inquiry {
    position: absolute;
    top: 5px;
    right: 5px;
    font-size: 0.7rem;
    color: rgba(255, 255, 255, 0.6);
    pointer-events: none;
    font-weight: 500;
  }
  :root[data-theme="light"] .ad-inquiry {
    color: rgba(0, 0, 0, 0.6);
  }

  /* ========== ëª¨ë°”ì¼ ì „ìš© ì˜¤ë²„ë¼ì´ë“œ (í™•ëŒ€) ========== */
  @media (max-width: 720px){
    /* 2. ìºë¦­í„° í¬ê¸° ë° ì •ë ¬ ì¬ì¡°ì • */
    #character{ 
        transform: translateX(-50%); 
        width: min(120vw, 96vw); /* 130vw -> 120vwë¡œ ì¡°ì • (1.2ë°°) */
    } 
    /* 2. ë§í’ì„  ìœ„ì¹˜ ìˆ˜ì •: ì¤‘ì•™ ì •ë ¬ ê°œì„  */
    #fortune-bubble {
        /* ìºë¦­í„°ì˜ ì¤‘ì•™ ìœ„ì¹˜ (top: calc(var(--content-top) + 20vh))ë³´ë‹¤ ìƒë‹¨ì— ìœ„ì¹˜ */
        top: calc(var(--content-top) + 20vh - 80px); /* ë‹¤ì‹œ -80pxë¡œ ë¯¸ì„¸ ì¡°ì • */
    }

    :root{
      --content-top: 12vh;
      --maxh-board: 80vh;
      --maxh-timer: 40vh;
      --maxh-window: 40vh;
      --maxh-char: 70vh; 

      /* 1. ëª¨ë°”ì¼ì—ì„œ Todo List ë° ì‹¤ì‹œê°„ íŒ¨ë„ ë„ˆë¹„ ì¡°ì • */
      --maxw-board: 60vw;
      --maxw-window: 30vw;
      --maxw-timer: 86vw;
      --maxw-char: 120vw; /* 130vw -> 120vwë¡œ ì¡°ì • (í¬ê¸° ì¬ì¡°ì •) */
    }

    #bottombar{ flex-direction:column; }
    #bottombar .card{ width:100%; }

    /* 1. â€œì§€ê¸ˆ ê³µë¶€ì¤‘â€ íŒ¨ë„ ìœ„ì¹˜ ë° ë„ˆë¹„ ì¡°ì • (ì˜¤ë¥¸ìª½ ì•„ë˜ë¡œ ë” ë‚´ë¦¼) */
    #presencePanel{
      right: 12px;
      bottom: 120px; /* í•˜ë‹¨ ìŒì•… ì»¨íŠ¸ë¡¤ íŒ¨ë„ ìœ„ì— ìœ„ì¹˜í•˜ë„ë¡ ì¡°ì • */
      width: min(var(--maxw-board), 92vw); /* 60vw ì ìš© */
      max-width: min(var(--maxw-board), 92vw);
      max-height: 40vh; 
      overflow:auto;
      top: unset;
    }
  }
</style>
</head>
<body>
<div id="app" class="">
  <!-- ì˜¤ë¥¸ìª½ ì•„ë˜: ì‹¤ì‹œê°„ íŒ¨ë„ -->
  <aside id="presencePanel" class="card panel" style="display:none">
    <div class="row" style="justify-content:space-between">
      <!-- 1. "ì˜¤ëŠ˜ ëˆ„ì  ê³µë¶€" íƒ€ì´í‹€ ì‚­ì œ -->
      <div class="title" data-lang-key="presence_title">ì‹¤ì‹œê°„ ë³´ê¸°</div>
      <div id="meNick" style="opacity:.8"></div>
    </div>
    <div id="presenceList"></div>
  </aside>

  <!-- ì†Œí’ˆ ë ˆì´ì–´ -->
  <div id="propsLayer"></div>

  <!-- 2. í¬ì¶˜ ì¿ í‚¤ ë§í’ì„  ì¶”ê°€ -->
  <div id="fortune-bubble" aria-live="polite"></div>

  <!-- ì˜¤ë²„ë ˆì´ + ë“œë¡œì–´ -->
  <div id="overlay"></div>
  <aside id="drawer" aria-label="ì„¤ì •">
    <header class="drawer-head">
      <h3 id="drawerTitle">ì„¤ì •</h3>
      <div class="row">
        <!-- ì–¸ì–´ ì„ íƒ ë“œë¡­ë‹¤ìš´ (ì¤‘êµ­ì–´ ì œê±°, í•œêµ­ì–´/ì˜ì–´ë§Œ) -->
        <select id="languageSelect" class="pill" style="padding:0.6rem 0.7rem; border-radius:12px; flex-shrink:0;">
          <option value="ko">í•œêµ­ì–´</option>
          <option value="en">English</option>
        </select>
        <button id="themeToggle" class="pill" title="ë‹¤í¬/ë¼ì´íŠ¸ ì „í™˜">ğŸŒ™</button>
        <button id="closeDrawer" class="pill" data-lang-key="close">ë‹«ê¸°</button>
      </div>
    </header>

    <!-- 1) ë½€ëª¨ë„ë¡œ / íƒ€ì´ë¨¸ -->
    <section class="drawer-sec">
      <h4 data-lang-key="timer_pomodoro_title">ë½€ëª¨ë„ë¡œ / íƒ€ì´ë¨¸</h4>
      <div class="row" id="modeRow">
        <label><input type="radio" name="mode" value="pomodoro" checked> <span data-lang-key="pomodoro">ë½€ëª¨ë„ë¡œ</span></label>
        <label><input type="radio" name="mode" value="timer"> <span data-lang-key="timer_up">íƒ€ì´ë¨¸(ì¹´ìš´íŠ¸ì—…)</span></label>
      </div>
      <div class="grid2" id="pomodoroFields" style="margin-top:.5rem">
        <label><span data-lang-key="focus_min">ì§‘ì¤‘(ë¶„)</span>
          <input id="workMin" type="number" min="1" value="25">
        </label>
        <label><span data-lang-key="rest_min">íœ´ì‹(ë¶„)</span>
          <input id="restMin" type="number" min="1" value="5">
        </label>
      </div>
      <label style="display:block; margin-top:.5rem" id="cyclesWrap"><span data-lang-key="cycles_count">ì‚¬ì´í´ ìˆ˜(NíšŒ)</span>
        <input id="totalCycles" type="number" min="1" value="4">
      </label>
      <div class="row" style="margin-top:.6rem">
        <button id="applyPom" class="pill" data-lang-key="apply">ì ìš©</button>
      </div>
    </section>

    <!-- 2) ì‹¤ì‹œê°„ ë³´ê¸° -->
    <section class="drawer-sec">
      <h4 data-lang-key="presence_title">ì‹¤ì‹œê°„ ë³´ê¸°</h4>
      <div class="row">
        <input id="nickname" class="fill pill-input" placeholder="ë‹‰ë„¤ì„(ì˜ˆ: do)">
        <button id="applyNick" class="pill" data-lang-key="apply">ì ìš©</button>
      </div>
      <div class="row" style="margin-top:.5rem">
        <button id="presenceToggle" class="pill" data-lang-key="public_on">ê³µê°œ: ì¼œì§</button>
        <button id="shareStudyBtn" class="pill" data-lang-key="share_study_on">ë‚´ ê³µë¶€ì‹œê°„ ê³µê°œ: ì¼œì§</button>
      </div>
      <div id="presenceInfo" style="opacity:.8; margin-top:.4rem">â€» ëª©ë¡ì—” ìµœëŒ€ 5ëª… í‘œì‹œ.</div>
    </section>

    <!-- 3) ìŒì•… -->
    <section class="drawer-sec">
      <h4 data-lang-key="music_style">ìŒì•… ìŠ¤íƒ€ì¼</h4>
      <div id="moods" class="chips list-scroll"></div>
    </section>

    <section class="drawer-sec">
      <h4 data-lang-key="track_select">ê³¡ ì„ íƒ</h4>
      <div id="tracks" class="chips list-scroll"></div>
    </section>

    <!-- í™”ë©´ í‘œì‹œ / ë ˆì´ì•„ì›ƒ / ë°°ê²½ / ì†Œí’ˆ / í¬ë ˆë”§ -->
    <section class="drawer-sec">
      <h4 data-lang-key="ui_visibility">ì°½ë¬¸/ìºë¦­í„° í‘œì‹œ</h4>
      <div class="row">
        <button id="toggleWindow" class="pill" data-lang-key="window_show">ì°½ë¬¸: ë³´ì„</button>
        <button id="toggleCharacter" class="pill" data-lang-key="character_show">ìºë¦­í„°: ë³´ì„</button>
      </div>
    </section>

    <section class="drawer-sec" id="layoutSettings">
      <h4 data-lang-key="screen_settings">í™”ë©´ ì„¤ì •</h4>
      <div class="row">
        <!-- ë°°ì¹˜ í¸ì§‘ ë²„íŠ¼ ìˆ¨ê¹€ ì²˜ë¦¬ -->
        <button id="layoutEdit" class="pill" data-lang-key="layout_edit_off" style="display:none;">ë°°ì¹˜ í¸ì§‘: êº¼ì§</button> 
        <button id="layoutReset" class="pill" title="ì›ìƒë³µêµ¬" data-lang-key="reset_layout">ì›ìƒë³µêµ¬</button>
        <button id="rotateToggle" class="pill" data-lang-key="rotate_on">íšŒì „: ì¼œì§</button>
      </div>
    </section>

    <section class="drawer-sec">
      <h4 data-lang-key="bg_select">ë°°ê²½ ì„ íƒ</h4>
      <div id="bgChips" class="chips"></div>

      <!-- íŒŒì¼ë¡œ ë°°ê²½ ì„ íƒ -->
      <div class="file-row" style="margin-top:.5rem">
        <input id="customBgFile" type="file" accept="image/*" class="input-file-hidden">
        <label for="customBgFile" class="pill file-pill" title="ë°°ê²½ ì´ë¯¸ì§€ ì„ íƒ">
          <span class="icon">ğŸ“</span> <span data-lang-key="bg_file_select">ë°°ê²½ íŒŒì¼ ì„ íƒ</span>
        </label>
        <span id="bgFileName" data-lang-key="not_selected">ì„ íƒ ì•ˆ ë¨</span>
        <span id="bgPreview" class="bg-thumb" aria-hidden="true"></span>
      </div>

      <div class="row" style="margin-top:.5rem">
        <input id="customBgUrl" placeholder="ë°°ê²½ ì´ë¯¸ì§€ URL ë¶™ì—¬ë„£ê¸°" class="fill pill-input">
        <button id="applyBg" class="pill" data-lang-key="apply">ì ìš©</button>
      </div>
    </section>

    <!-- ì†Œí’ˆ ê´€ë ¨ ì„¹ì…˜ ìˆ¨ê¹€ ì²˜ë¦¬ -->
    <section class="drawer-sec" id="propsSection" style="display:none;">
      <h4 data-lang-key="props">ì†Œí’ˆ</h4>
      <!-- íŒŒì¼ ì„ íƒì„ URLë³´ë‹¤ ìœ„ë¡œ -->
      <div class="file-row" style="margin-top:.5rem">
        <input id="propFile" type="file" accept="image/*" class="input-file-hidden" />
        <label for="propFile" class="pill file-pill" title="ì†Œí’ˆ ì´ë¯¸ì§€ ì„ íƒ">
          <span class="icon">ğŸ“</span> <span data-lang-key="prop_file_select">ì†Œí’ˆ íŒŒì¼ ì„ íƒ</span>
        </label>
        <span id="propFileName" data-lang-key="not_selected">ì„ íƒ ì•ˆ ë¨</span>
        <button id="propFileAdd" class="pill" data-lang-key="add_file">íŒŒì¼ ì¶”ê°€</button>
      </div>
      <div class="row" style="margin-top:.5rem">
        <input id="propUrl" class="fill pill-input" placeholder="ì†Œí’ˆ ì´ë¯¸ì§€ URL">
        <button id="propAdd" class="pill" data-lang-key="add">ì¶”ê°€</button>
      </div>

      <div class="chips" style="margin-top:.5rem">
        <button class="pill propPreset" data-url="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f331.svg">ğŸŒ±</button>
        <button class="pill propPreset" data-url="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/2615.svg">â˜•</button>
        <button class="pill propPreset" data-url="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f4a1.svg">ğŸ’¡</button>
        <button class="pill propPreset" data-url="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f4da.svg">ğŸ“š</button>
      </div>
      <div id="propList" class="list-scroll" style="margin-top:.6rem"></div>
      <div id="propInfo" style="opacity:.8; margin-top:.4rem">â€» ì†Œí’ˆì€ ì¶”ê°€ ì¦‰ì‹œ í¸ì§‘ ê°€ëŠ¥(ì¤‘ì•™ ìµœì†Œí¬ê¸° ë°°ì¹˜)</div>
    </section>

    <section class="drawer-sec">
      <h4 data-lang-key="credits">Credits</h4>
      <!-- ë§í¬ ì—…ë°ì´íŠ¸ -->
      <a id="creditLink" href="https://dashing-leek-81d.notion.site/Study-with-me-27c4376fbca680629fe3e6e31281b9e2?pvs=74" target="_blank" rel="noopener">Made by do</a>
    </section>
  </aside>

  <!-- ìƒë‹¨: í–„ë²„ê±° / íƒ€ì´ë¨¸ / Todo -->
  <div id="topbar">
    <button id="hamburger" class="card panel" aria-label="ë©”ë‰´ ì—´ê¸°">â‹¯</button>

    <section id="timer" class="card panel resizable" aria-label="íƒ€ì´ë¨¸">
      <div id="state" data-lang-key="focusing">ì§‘ì¤‘ì¤‘</div>
      <div id="time">25:00</div>
      <div class="row">
        <button class="pill" id="startPause" data-lang-key="start">ì‹œì‘</button>
        <button class="pill" id="reset" data-lang-key="reset">ë¦¬ì…‹</button>
        <button class="pill" id="cyclesBtn" title="ì‚¬ì´í´ ì§„í–‰ ìƒí™©">0/4íšŒ</button>
      </div>
    </section>

    <section id="board" class="card panel" aria-label="Todo list">
      <div id="todoTitle" class="title">Todo list</div>
      <div id="todo-list"></div>
      <div id="inputRow">
        <input id="todo-input" type="text" placeholder="í•  ì¼ì„ ì ê³  Enter" />
        <button id="todo-add" class="pill" title="ì¶”ê°€">ï¼‹</button>
      </div>
    </section>
  </div>

  <!-- ë©”ì¸: ì°½ë¬¸ + ìºë¦­í„° -->
  <!-- 2. í¬ì¶˜ ì¿ í‚¤ ë§í’ì„  ì¶”ê°€ -->
  <div id="window" class="resizable"><img id="win-img" alt="ì°½ë¬¸" /></div>
  <div id="character" class="resizable" role="button" tabindex="0"><img id="char-img" alt="ìºë¦­í„°" /></div>

  <!-- í•˜ë‹¨: ìŒì•… -->
  <div id="bottombar">
    <section id="music-controls" class="card panel" aria-label="ìŒì•… ì¬ìƒ">
      <h4 data-lang-key="music_player">ìŒì•… ì¬ìƒ</h4>
      <div class="hwrap">
        <button class="pill" id="playPause" data-lang-key="play">ì¬ìƒ</button>
        <button class="pill" id="shuffle" data-lang-key="shuffle_off">ëœë¤: êº¼ì§</button>
        <button class="pill" id="repeat" data-lang-key="repeat_off">ë°˜ë³µ: êº¼ì§</button>
      </div>
      <audio id="player" preload="metadata"></audio>
    </section>
  </div>

  <!-- (ì¶”í›„ ê´‘ê³ ) í•˜ë‹¨ ì¤‘ì•™ íˆ¬ëª… ë°°ë„ˆ -->
  <div id="adBanner" aria-hidden="true">
    <img alt="ad-placeholder"
      src="https://github.com/nihicheli/studywithme/blob/main/image/Group%209225.png?raw=true"/>
    <span class="ad-inquiry"></span>
  </div>
</div>

<script>
  /* ===== ì–¸ì–´ ë²ˆì—­ ë°ì´í„° (Translation Data) ===== */
  const TRANSLATIONS = {
    en: {
      settings: "Settings",
      close: "Close",
      theme_toggle: "ğŸŒ™",
      today_study: "Today's Study: ",
      todo_list: "Todo List",
      add_todo_placeholder: "Add a task and Enter",
      delete: "Delete", 
      
      // Timer/Pomodoro
      timer_pomodoro_title: "Timer / Pomodoro",
      pomodoro: "Pomodoro",
      timer_up: "Timer (Count Up)",
      focus_min: "Focus (min)",
      rest_min: "Rest (min)",
      cycles_count: "Cycles (N)",
      apply: "Apply",
      
      // Timer State
      focusing: "Focusing",
      resting: "Resting",
      timer_mode: "Timer Mode",
      start: "Start",
      pause: "Pause",
      reset: "Reset",
      
      // Presence
      presence_title: "Live Presence",
      nickname_placeholder: "Nickname (e.g. do)",
      public_on: "Public: ON",
      public_off: "Public: OFF",
      share_study_on: "Share Time: ON",
      share_study_off: "Share Time: OFF",
      presence_info: "â€» Max 5 people shown in list.",
      
      // Music
      music_player: "Music Player",
      music_style: "Music Style",
      track_select: "Track Select",
      play: "Play",
      pause_music: "Pause",
      shuffle_on: "Shuffle: ON",
      shuffle_off: "Shuffle: OFF",
      repeat_off: "Repeat: OFF",
      repeat_one: "Repeat: One",
      repeat_all: "Repeat: All",
      
      // UI/Layout
      ui_visibility: "Visibility",
      window_show: "Window: Show",
      window_hide: "Window: Hide",
      character_show: "Character: Show",
      character_hide: "Character: Hide",
      screen_settings: "Screen Settings",
      layout_edit_off: "Layout Edit: OFF",
      layout_edit_on: "Layout Edit: ON",
      reset_layout: "Reset Layout",
      rotate_on: "Rotate: ON",
      rotate_off: "Rotate: OFF",

      // Background/Props
      bg_select: "Background Select",
      bg_file_select: "Select BG File",
      not_selected: "Not Selected",
      props: "Props",
      prop_file_select: "Select Prop File",
      add_file: "Add File",
      add: "Add",
      prop_info: "â€» Props are editable immediately after adding (placed center min size)",
      
      // Credits
      credits: "Credits",
      
      // Presence Status
      status_work: "Focusing",
      status_break: "Resting",
      status_idle: "Idle",
      timer_mode: "Timer Mode",
      no_one_online: "No one online yet",
      hour_short: "h",
      min_short: "m"
    },
    ko: {
      settings: "ì„¤ì •",
      close: "ë‹«ê¸°",
      theme_toggle: "ğŸŒ™",
      today_study: "ì˜¤ëŠ˜ ëˆ„ì  ê³µë¶€: ",
      todo_list: "Todo list",
      add_todo_placeholder: "í•  ì¼ì„ ì ê³  Enter",
      delete: "ì‚­ì œ", 
      
      // Timer/Pomodoro
      timer_pomodoro_title: "ë½€ëª¨ë„ë¡œ / íƒ€ì´ë¨¸",
      pomodoro: "ë½€ëª¨ë„ë¡œ",
      timer_up: "íƒ€ì´ë¨¸(ì¹´ìš´íŠ¸ì—…)",
      focus_min: "ì§‘ì¤‘(ë¶„)",
      rest_min: "íœ´ì‹(ë¶„)",
      cycles_count: "ì‚¬ì´í´ ìˆ˜(NíšŒ)",
      apply: "ì ìš©",
      
      // Timer State
      focusing: "ì§‘ì¤‘ì¤‘",
      resting: "íœ´ì‹ì¤‘",
      timer_mode: "íƒ€ì´ë¨¸",
      start: "ì‹œì‘",
      pause: "ì¼ì‹œì •ì§€",
      reset: "ë¦¬ì…‹",
      
      // Presence
      presence_title: "ì‹¤ì‹œê°„ ë³´ê¸°",
      nickname_placeholder: "ë‹‰ë„¤ì„(ì˜ˆ: do)",
      public_on: "ê³µê°œ: ì¼œì§",
      public_off: "ê³µê°œ: êº¼ì§",
      share_study_on: "ë‚´ ê³µë¶€ì‹œê°„ ê³µê°œ: ì¼œì§",
      share_study_off: "ë‚´ ê³µë¶€ì‹œê°„ ê³µê°œ: êº¼ì§",
      presence_info: "â€» ëª©ë¡ì—” ìµœëŒ€ 5ëª… í‘œì‹œ.",
      
      // Music
      music_player: "ìŒì•… ì¬ìƒ",
      music_style: "ìŒì•… ìŠ¤íƒ€ì¼",
      track_select: "ê³¡ ì„ íƒ",
      play: "ì¬ìƒ",
      pause_music: "ì¼ì‹œì •ì§€",
      shuffle_on: "ëœë¤: ì¼œì§",
      shuffle_off: "ëœë¤: êº¼ì§",
      repeat_off: "ë°˜ë³µ: êº¼ì§",
      repeat_one: "ë°˜ë³µ: í•œê³¡",
      repeat_all: "ë°˜ë³µ: ì „ì²´",
      
      // UI/Layout
      ui_visibility: "ì°½ë¬¸/ìºë¦­í„° í‘œì‹œ",
      window_show: "ì°½ë¬¸: ë³´ì„",
      window_hide: "ì°½ë¬¸: ìˆ¨ê¹€",
      character_show: "ìºë¦­í„°: ë³´ì„",
      character_hide: "ìºë¦­í„°: ìˆ¨ê¹€",
      screen_settings: "í™”ë©´ ì„¤ì •",
      layout_edit_off: "ë°°ì¹˜ í¸ì§‘: êº¼ì§",
      layout_edit_on: "ë°°ì¹˜ í¸ì§‘: ì¼œì§",
      reset_layout: "ì›ìƒë³µêµ¬",
      rotate_on: "íšŒì „: ì¼œì§",
      rotate_off: "íšŒì „: êº¼ì§",

      // Background/Props
      bg_select: "ë°°ê²½ ì„ íƒ",
      bg_file_select: "ë°°ê²½ íŒŒì¼ ì„ íƒ",
      not_selected: "ì„ íƒ ì•ˆ ë¨",
      props: "ì†Œí’ˆ",
      prop_file_select: "ì†Œí’ˆ íŒŒì¼ ì„ íƒ",
      add_file: "íŒŒì¼ ì¶”ê°€",
      add: "ì¶”ê°€",
      prop_info: "â€» ì†Œí’ˆì€ ì¶”ê°€ ì¦‰ì‹œ í¸ì§‘ ê°€ëŠ¥(ì¤‘ì•™ ìµœì†Œí¬ê¸° ë°°ì¹˜)",
      
      // Credits
      credits: "Credits",
      
      // Presence Status
      status_work: "ì§‘ì¤‘ì¤‘",
      status_break: "íœ´ì‹ì¤‘",
      status_idle: "ëŒ€ê¸°ì¤‘",
      timer_mode: "íƒ€ì´ë¨¸",
      no_one_online: "ì•„ì§ ì•„ë¬´ë„ ì—†ì–´ìš”",
      hour_short: "ì‹œê°„",
      min_short: "ë¶„"
    }
  };

  function getTranslation(key) {
      const lang = state.lang;
      return TRANSLATIONS[lang][key] || TRANSLATIONS['en'][key] || key;
  }
  
  function updateTextByLanguage() {
      // 1. HTML lang ì†ì„± ì—…ë°ì´íŠ¸
      document.documentElement.lang = state.lang;
      
      // 2. data-lang-key ì†ì„±ì„ ê°€ì§„ ëª¨ë“  ìš”ì†Œ ì—…ë°ì´íŠ¸
      document.querySelectorAll('[data-lang-key]').forEach(el => {
          const key = el.getAttribute('data-lang-key');
          const translation = getTranslation(key);
          // í…ìŠ¤íŠ¸ ë‚´ìš© ì—…ë°ì´íŠ¸
          el.textContent = translation;
          
          // input placeholder ì—…ë°ì´íŠ¸
          if (el.tagName === 'INPUT' && el.id === 'todo-input') {
              el.placeholder = getTranslation('add_todo_placeholder');
          } else if (el.id === 'bgFileName' || el.id === 'propFileName') {
              // 'ì„ íƒ ì•ˆ ë¨' ìƒíƒœ í…ìŠ¤íŠ¸ ì²˜ë¦¬
              if (el.textContent.trim() === getTranslation('not_selected')) {
                   el.textContent = getTranslation('not_selected');
              }
          }
      });
      
      // 3. íŠ¹ìˆ˜ ìš”ì†Œ ì—…ë°ì´íŠ¸ (í•˜ë“œì½”ë”©ëœ ë¶€ë¶„)
      document.getElementById('drawerTitle').textContent = getTranslation('settings');
      document.getElementById('todoTitle').textContent = getTranslation('todo_list');
      
      // 4. ë™ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ëŠ” UI í…ìŠ¤íŠ¸ ì¬í˜¸ì¶œ
      updateTimerUI();         // íƒ€ì´ë¨¸ ìƒíƒœ, ì‹œì‘/ì¼ì‹œì •ì§€/ë¦¬ì…‹
      updateCyclesBtn();       // ì‚¬ì´í´ ë²„íŠ¼
      updateWindowToggleUI();  // ì°½ë¬¸ í‘œì‹œ
      updateCharacterToggleUI(); // ìºë¦­í„° í‘œì‹œ
      updateRepeatUI();        // ë°˜ë³µ ëª¨ë“œ
      
      // 5. ë°°ì¹˜ í¸ì§‘ ìƒíƒœ ì—…ë°ì´íŠ¸ (ë²„íŠ¼ì´ ìˆ¨ê²¨ì ¸ ìˆì§€ë§Œ ë¡œì§ì€ ìœ ì§€)
      layoutEditBtn.textContent = getTranslation(window.editOn ? 'layout_edit_on' : 'layout_edit_off');
      
      // 6. í–„ë²„ê±° ë²„íŠ¼ 'ë‹«ê¸°' í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
      document.getElementById('closeDrawer').textContent = getTranslation('close');
      
      // 7. ì‹¤ì‹œê°„ ë³´ê¸° ì •ë³´ ì—…ë°ì´íŠ¸
      document.getElementById('presenceInfo').textContent = getTranslation('presence_info');
  }

  /* ===== íŠ¸ë™ ë°ì´í„° (Track Data) ===== */
  const TRACKS = [
    { title: "Bass Meant Jazz",     mood: "Jazz",    url: "https://freepd.com/music/Bass%20Meant%20Jazz.mp3" },
    { title: "Stompin at Midnight", mood: "Jazz",    url: "https://freepd.com/music/Stompin%20at%20Midnight.mp3" },
    { title: "Abstract Anxiety",    mood: "Loud",    url: "https://freepd.com/music/Abstract%20Anxiety.mp3" },
    { title: "Adding the Sun",      mood: "Lo-Fi",   url: "https://freepd.com/music/Adding%20the%20Sun.mp3" },
    { title: "Bleu",                mood: "Lo-Fi",   url: "https://freepd.com/music/Bleu.mp3" },
    { title: "Study and Relax",     mood: "Lo-Fi",   url: "https://freepd.com/music/Study%20and%20Relax.mp3" },
    { title: "Deep Focus",          mood: "Lo-Fi",   url: "https://freepd.com/music/Deep%20Focus. Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğ¼" },
    
    /* --- ì¶”ê°€ëœ ê³¡ (Freepd.com / Incompetech - ìƒì—…ì  ë¬´ë£Œ) --- */
    { title: "Adventure",           mood: "Lo-Fi",   url: "https://freepd.com/music/Adventure.mp3" }, 
    { title: "Compy Jazz",    mood: "Jazz",    url: "https://freepd.com/music/Compy%20Jazz.mp3" }, 
    { title: "Overture", mood: "Piano",   url: "https://freepd.com/music/Overture.mp3" },
    { title: "Winter",        mood: "Piano", url: "https://freepd.com/music/Winter.mp3" }, 
    
    /* White/Pink/Brown Noise (Public Domain) */
    { title: "White Noise",  mood: "Noise", url: "https://archive.org/download/TenMinutesOfWhiteNoisePinkNoiseAndBrownianNoise/WhiteNoise_64kb.mp3" },
    { title: "Pink Noise",   mood: "Noise", url: "https://archive.org/download/TenMinutesOfWhiteNoisePinkNoiseAndBrownianNoise/PinkNoise_64kb.mp3" },
    { title: "Brown Noise",  mood: "Noise", url: "https://archive.org/download/TenMinutesOfWhiteNoisePinkNoiseAndBrownianNoise/BrownianNoise_64kb.mp3" }
  ];

  /* ì°½ë¬¸/ìºë¦­í„° 0.5s êµì°¨ */
  let charWorkA = "https://github.com/nihicheli/studywithme/blob/main/image/Group%209213.png?raw=true"; // ì´ë¯¸ì§€ 1 (ì§‘ì¤‘ì¤‘)
  let charWorkB = "https://github.com/nihicheli/studywithme/blob/main/image/Group%209214.png?raw=true"; // ì´ë¯¸ì§€ 2 (ì§‘ì¤‘ì¤‘)
  let winWorkA  = "https://github.com/nihicheli/studywithme/blob/main/image/Group%209215.png?raw=true";
  let winWorkB  = "https://github.com/nihicheli/studywithme/blob/main/image/Group%209216.png?raw=true";
  /* 1. íœ´ì‹ ì¤‘ì¼ ë•Œ ì‚¬ìš©í•  ìƒˆë¡œìš´ ì´ë¯¸ì§€ 3, 4 */
  let charBreakA = "https://github.com/nihicheli/studywithme/blob/main/image/Group%209222.png?raw=true"; // ì´ë¯¸ì§€ 3 (íœ´ì‹ì¤‘: ì„ì‹œ Placeholder)
  let charBreakB = "https://github.com/nihicheli/studywithme/blob/main/image/Group%209224.png?raw=true"; // ì´ë¯¸ì§€ 4 (íœ´ì‹ì¤‘: ì„ì‹œ Placeholder)
  let winBreakA  = "https://github.com/nihicheli/studywithme/blob/main/image/Group%209215.png?raw=true";
  let winBreakB  = "https://github.com/nihicheli/studywithme/blob/main/image/Group%209216.png?raw=true";

  let showA = true, blinkTimer = null;
  let fortuneBubbleTimeout = null;
  
  /* [ì‚­ì œ] ì´ë¯¸ì§€ ê¹œë¹¡ì„ ìµœì í™”ë¥¼ ìœ„í•œ BLINK_CACHE ì œê±° */

  // 2. ë”°ëœ»í•œ ë©”ì‹œì§€ ëª©ë¡
  const FORTUNE_MESSAGES = [
    "ì˜¤ëŠ˜ì˜ ë…¸ë ¥ì€ ë‚´ì¼ì˜ ë¹›ì´ ë  ê±°ì˜ˆìš”!",
    "ì ì‹œ ì‰¬ì–´ê°€ë„ ê´œì°®ì•„ìš”, ë‹¹ì‹ ì€ ì´ë¯¸ ì¶©ë¶„íˆ ì˜í•˜ê³  ìˆì–´ìš”.",
    "í¬ê¸°í•˜ì§€ ì•ŠëŠ” ë§ˆìŒì´ ê°€ì¥ ì†Œì¤‘í•œ ìì‚°ì…ë‹ˆë‹¤.",
    "ì§€ê¸ˆ ì´ ìˆœê°„ì—ë„ ë‹¹ì‹ ì€ ì„±ì¥í•˜ê³  ìˆì–´ìš”.",
    "ì‘ì€ ì„±ì·¨ë¼ë„ ê´œì°®ì•„ìš”. ìŠ¤ìŠ¤ë¡œë¥¼ ì¹­ì°¬í•´ ì£¼ì„¸ìš”!",
    "ë”°ëœ»í•œ ì°¨ í•œ ì”ê³¼ í•¨ê»˜ ì—ë„ˆì§€ë¥¼ ì±„ì›Œë³´ì„¸ìš”.",
    "ë‹¹ì‹ ì˜ ê¿ˆì€ ë°˜ì§ì´ê³  ìˆì–´ìš”. ì¡°ê¸ˆë§Œ ë” í˜ë‚´ìš”!",
    "ê°€ë”ì€ ë¨¼ ê³³ì„ ë°”ë¼ë³´ëŠ” ê²ƒë„ í•„ìš”í•´ìš”.",
    "ìµœê³ ì˜ ê³µë¶€ëŠ” ì¦ê¸°ëŠ” ê³µë¶€ì…ë‹ˆë‹¤. ì˜¤ëŠ˜ë„ í™”ì´íŒ…!",
    "ì²œì²œíˆ ê¾¸ì¤€íˆ í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•´ìš”. ì˜¤ëŠ˜ë„ í™”ì´íŒ…!",
    "ìˆ¨ì„ í¬ê²Œ ì‰¬ê³ , ë‹¤ì‹œ ì§‘ì¤‘í•´ ë´ìš”!",
    "ë‹¹ì‹ ì€ ì´ ëª¨ë“  ê²ƒì„ í•´ë‚¼ ëŠ¥ë ¥ì´ ìˆì–´ìš”.",
    "ë‹¹ì‹ ì˜ ì˜¤ëŠ˜ì€ ëˆ„êµ°ê°€ì—ê²Œ í° í˜ì´ ë˜ê³  ìˆì–´ìš”.",
    "ì‘ì€ ì›ƒìŒ í•˜ë‚˜ê°€ í•˜ë£¨ë¥¼ ë” ë¹›ë‚˜ê²Œ í•´ì¤„ ê±°ì˜ˆìš”.",
    "ë§ˆìŒì´ ì§€ì¹  ë• í•˜ëŠ˜ì„ ì˜¬ë ¤ë‹¤ë³´ì„¸ìš”. ìœ„ë¡œê°€ ë  ê±°ì˜ˆìš”.",
    "ë‹¹ì‹ ì´ ê±¸ì–´ì˜¨ ê¸¸ì€ ë¶„ëª… ì˜ë¯¸ ìˆëŠ” ë°œìì·¨ì˜ˆìš”.",
    "ëˆ„êµ¬ë³´ë‹¤ ì†Œì¤‘í•œ ê±´ ë°”ë¡œ ë‹¹ì‹  ìì‹ ì´ì—ìš”.",
    "ì¡°ê¸ˆ ëŠ¦ë”ë¼ë„ ê´œì°®ì•„ìš”. ì¤‘ìš”í•œ ê±´ ë©ˆì¶”ì§€ ì•ŠëŠ” ê±°ì˜ˆìš”.",
    "ì–´ì œë³´ë‹¤ ë‚˜ì€ ì˜¤ëŠ˜ì„ ë§Œë“¤ê³  ìˆëŠ” ë‹¹ì‹ ì„ ì‘ì›í•©ë‹ˆë‹¤.",
    "ë‹¹ì‹ ì˜ ë”°ëœ»í•œ ë§ˆìŒì€ ì–¸ì œë‚˜ ë¹›ë‚˜ê³  ìˆì–´ìš”."
  ];

  /* ===== ì „ì—­ ìƒíƒœ ===== */
  const lsShare = localStorage.getItem("shareStudy");
  const state = {
    mode: localStorage.getItem("mode") || "pomodoro",
    shareStudy: (lsShare === null) ? true : (lsShare === "1"),   // ê¸°ë³¸ ON
    isWork: true, running: false,
    workSec: 25*60, restSec: 5*60, remainSec: 25*60,
    interval: null, shuffle: false, playing: false,
    mood: "ì „ì²´", trackIdx: 0, repeatMode: "off",
    totalCycles: 4, completedCycles: 0,
    /* [ìœ ì§€] íƒ€ì´ë¨¸ ì§€ì—° ë¬¸ì œ í•´ê²°ì„ ìœ„í•œ íƒ€ì„ìŠ¤íƒ¬í”„ */
    startTimeStamp: 0, // íƒ€ì´ë¨¸ê°€ ì‹œì‘ëœ ì‹¤ì œ ì‹œì  (ms)
    lastUpdateTimestamp: 0, // studyTimeTotal ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ ë§ˆì§€ë§‰ ì‹œì  (ms)
    /* 2. ìƒˆë²½ 4ì‹œ ê¸°ì ìœ¼ë¡œ í•˜ë£¨ ê³µë¶€ì‹œê°„ ëˆ„ì ì„ ìœ„í•´ studyTimeTotal ë° lastStudyTime ì¶”ê°€ */
    studyTimeTotal: parseInt(localStorage.getItem("studyTimeTotal") || "0", 10),
    lastStudyTime: parseInt(localStorage.getItem("lastStudyTime") || "0", 10),
    todos: JSON.parse(localStorage.getItem("todos-v1")||"[]"),
    /* 4. ë‹¤í¬ëª¨ë“œë¥¼ ë””í´íŠ¸ë¡œ */
    theme: localStorage.getItem("theme") || "dark",
    windowVisible: (localStorage.getItem("ui-window-visible") ?? "1") === "1",
    characterVisible: (localStorage.getItem("ui-character-visible") ?? "1") === "1",
    props: JSON.parse(localStorage.getItem("props-v1")||"[]"),
    rotateOn: (localStorage.getItem("rotateOn") ?? "") === "" ? true : (localStorage.getItem("rotateOn") === "1"),
    // ì–¸ì–´ ì„¤ì •: í•œêµ­ì–´ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ë³€ê²½
    lang: localStorage.getItem("lang") || 'ko' 
  };
  window.state = state;

  /* 2. ìƒˆë²½ 4ì‹œë¥¼ ê¸°ì ìœ¼ë¡œ ê³µë¶€ ì‹œê°„ ì´ˆê¸°í™” í™•ì¸ */
  (function checkAndResetDailyStudyTime(){
      const now = new Date();
      const last = new Date(state.lastStudyTime);

      const isNewDay = (now.getFullYear() > last.getFullYear() || now.getMonth() > last.getMonth() || now.getDate() > last.getDate());

      // ì˜¤ëŠ˜ ìƒˆë²½ 4ì‹œ (4:00:00)
      const resetTime = new Date(now);
      resetTime.setHours(4, 0, 0, 0);

      // (1) ë§ˆì§€ë§‰ ê¸°ë¡ ì‹œì  (last)ì´ ì˜¤ëŠ˜ ìƒˆë²½ 4ì‹œ ì´ì „ì´ê³ , í˜„ì¬ ì‹œì (now)ì´ ì˜¤ëŠ˜ ìƒˆë²½ 4ì‹œ ì´í›„ì¼ ê²½ìš°
      const shouldReset = (last.getTime() < resetTime.getTime() && now.getTime() >= resetTime.getTime());

      // (2) ë˜ëŠ” ë‚ ì§œ ìì²´ê°€ ë°”ë€Œì—ˆëŠ”ë°, ì•„ì§ ì˜¤ëŠ˜ 4ì‹œë¥¼ ì§€ë‚˜ì§€ ì•Šì•˜ì„ ê²½ìš° (ì˜ˆ: 3ì¼ 3ì‹œì— ê¸°ë¡í•˜ê³  4ì¼ 1ì‹œì— ì ‘ì†)
      // ì´ ê²½ìš°, ì „ë‚ ì˜ 4ì‹œì™€ ì˜¤ëŠ˜ 4ì‹œ ì‚¬ì´ì— ì ‘ì†í–ˆë‹¤ë©´ ë¦¬ì…‹ì„ ê±´ë„ˆë›¸ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, (1) ì¡°ê±´ìœ¼ë¡œ ì¶©ë¶„í•©ë‹ˆë‹¤.
      // ë¦¬ì…‹ì€ "4ì‹œê°€ ë˜ì—ˆì„ ë•Œ ì²˜ìŒ ì ‘ì†/ì•¡ì…˜ ì‹œ"ì—ë§Œ ì¼ì–´ë‚˜ë„ë¡ ì„¤ê³„í•©ë‹ˆë‹¤.

      if(shouldReset || (isNewDay && now.getHours() >= 4)){
          // 4ì‹œê°€ ì§€ë‚¬ìœ¼ë¯€ë¡œ ë¦¬ì…‹
          state.studyTimeTotal = 0;
          localStorage.setItem("studyTimeTotal", "0");
          // lastStudyTimeì„ í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸ (ë‹¤ì‹œ ë¦¬ì…‹ë˜ì§€ ì•Šë„ë¡ ë°©ì§€)
          state.lastStudyTime = now.getTime();
          localStorage.setItem("lastStudyTime", state.lastStudyTime.toString());
      }
      // lastStudyTimeì´ 0ì´ê±°ë‚˜ (ì²« ì‹¤í–‰), 4ì‹œ ë¦¬ì…‹ ì¡°ê±´ì´ ì•„ë‹ˆë©´ í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë§Œ í•©ë‹ˆë‹¤.
      if (state.lastStudyTime === 0 || shouldReset || isNewDay) {
          state.lastStudyTime = now.getTime();
          localStorage.setItem("lastStudyTime", state.lastStudyTime.toString());
      }
  })();
  
  /* [ìœ ì§€] í˜„ì¬ ì •í™•í•œ ë‚¨ì€ ì‹œê°„ ê³„ì‚° (íƒ­ ì „í™˜ ë¬¸ì œ í•´ê²° í•µì‹¬) */
  function calculateAccurateRemaining() {
    if (!state.running || state.startTimeStamp === 0) return state.remainSec;
    
    const now = Date.now();
    // íƒ€ì´ë¨¸ ì‹œì‘ ì‹œì  ëŒ€ë¹„ ì‹¤ì œ ê²½ê³¼ ì´ˆ
    const elapsedRealSeconds = Math.floor((now - state.startTimeStamp) / 1000);
    
    if (state.mode === 'pomodoro') {
        const originalTotalTime = (state.isWork ? state.workSec : state.restSec);
        return originalTotalTime - elapsedRealSeconds;
    } else { // Timer mode (Count-up)
        return elapsedRealSeconds;
    }
  }


  /* ìƒˆë¡œê³ ì¹¨ì‹œ íƒ€ì´ë¨¸ ìœ ì§€ */
  window.addEventListener('beforeunload', ()=>{
    try{
      // [ìˆ˜ì •] beforeunload ì‹œ ì •í™•í•œ remainSecë¥¼ ê³„ì‚°í•˜ì—¬ ì €ì¥
      const snap = {
        mode: state.mode, isWork: state.isWork, running: state.running,
        workSec: state.workSec, restSec: state.restSec, 
        remainSec: calculateAccurateRemaining(), // ì •í™•íˆ ê³„ì‚°ëœ ë‚¨ì€ ì‹œê°„ ì €ì¥
        totalCycles: state.totalCycles, completedCycles: state.completedCycles
      };
      sessionStorage.setItem('timer-keep', JSON.stringify(snap));
      
      // [ìˆ˜ì •] ë§ˆì§€ë§‰ì— studyTimeTotal ì—…ë°ì´íŠ¸
      if (state.running && (state.mode === 'timer' || state.isWork)) {
        // running ì¤‘ì´ì—ˆë‹¤ë©´, stopTimerì—ì„œ ëˆ„ì ë˜ì—ˆì–´ì•¼ í•¨. 
        // ì—¬ê¸°ì„œ ë‹¤ì‹œ í•œ ë²ˆ ì •í™•í•œ ëˆ„ì  ì‹œê°„ì„ ê³„ì‚°í•˜ì—¬ ì €ì¥
        const now = Date.now();
        const deltaSeconds = Math.floor((now - state.lastUpdateTimestamp) / 1000);
        if(deltaSeconds > 0) state.studyTimeTotal += deltaSeconds;
      }
      
      localStorage.setItem("studyTimeTotal", state.studyTimeTotal.toString());
      localStorage.setItem("lastStudyTime", Date.now().toString());
    }catch(e){}
  });

  let __resumeAfterReload = false;
  (function restoreTimerFromSession(){
    const saved = sessionStorage.getItem('timer-keep');
    if(!saved) return;
    try{
      const s = JSON.parse(saved);
      state.mode = s.mode || state.mode;
      state.isWork = !!s.isWork;
      state.workSec = +s.workSec || state.workSec;
      state.restSec = +s.restSec || state.restSec;
      // [ìœ ì§€] ì €ì¥ëœ remainSecë¥¼ ì‚¬ìš© (ì •í™•í•œ ì‹œê°„ì„)
      state.remainSec = +s.remainSec || state.remainSec; 
      state.totalCycles = +s.totalCycles || state.totalCycles;
      state.completedCycles = +s.completedCycles || 0;
      __resumeAfterReload = !!s.running;
      localStorage.setItem("mode", state.mode);
    }catch(e){}
    sessionStorage.removeItem('timer-keep');
  })();

  const boardList = document.getElementById("todo-list");
  const todoInput = document.getElementById("todo-input");
  const todoAdd   = document.getElementById("todo-add");
  const charImg   = document.getElementById("char-img");
  const winImg    = document.getElementById("win-img");
  const timeEl    = document.getElementById("time");
  const stateEl   = document.getElementById("state");
  const startPause= document.getElementById("startPause");
  const resetBtn  = document.getElementById("reset");
  const cyclesBtn = document.getElementById("cyclesBtn");
  const playPause = document.getElementById("playPause");
  const shuffleBtn= document.getElementById("shuffle");
  const repeatBtn = document.getElementById("repeat");
  const player    = document.getElementById("player");
  const fortuneBubble = document.getElementById("fortune-bubble");
  const characterBox = document.getElementById("character");

  const overlay   = document.getElementById("overlay");
  const drawer    = document.getElementById("drawer");
  const hamburgerBtn = document.getElementById("hamburger");
  const closeDrawer  = document.getElementById("closeDrawer");
  const themeToggle  = document.getElementById("themeToggle");
  const moodsWrap    = document.getElementById("moods");
  const tracksWrap   = document.getElementById("tracks");

  const workMin      = document.getElementById("workMin");
  const restMin      = document.getElementById("restMin");
  const totalCyclesInput = document.getElementById("totalCycles");
  const applyPom     = document.getElementById("applyPom");

  const modeRadios   = document.querySelectorAll('input[name="mode"]');
  const pomodoroFields = document.getElementById("pomodoroFields");
  const cyclesWrap   = document.getElementById("cyclesWrap");

  const bgChips      = document.getElementById("bgChips");
  const customBgUrl  = document.getElementById("customBgUrl");
  const applyBg      = document.getElementById("applyBg");
  const customBgFile = document.getElementById("customBgFile");
  const bgFileName   = document.getElementById("bgFileName");
  const bgPreview    = document.getElementById("bgPreview");

  const toggleWindowBtn    = document.getElementById("toggleWindow");
  const toggleCharacterBtn = document.getElementById("toggleCharacter");
  const windowBox          = document.getElementById("window");
  
  const layoutEditBtn  = document.getElementById("layoutEdit");
  const layoutResetBtn = document.getElementById("layoutReset");
  const rotateToggle   = document.getElementById("rotateToggle");

  const propsLayer   = document.getElementById("propsLayer");
  const propUrl      = document.getElementById("propUrl");
  const propAdd      = document.getElementById("propAdd");
  const propFile     = document.getElementById("propFile");
  const propFileAdd  = document.getElementById("propFileAdd");
  const propFileName = document.getElementById("propFileName");
  const propList     = document.getElementById("propList");
  const propPresets  = document.querySelectorAll(".propPreset");
  const propsSection = document.getElementById("propsSection"); // ì†Œí’ˆ ì„¹ì…˜
  const layoutSettings = document.getElementById("layoutSettings"); // í™”ë©´ ì„¤ì • ì„¹ì…˜

  const presencePanel = document.getElementById("presencePanel");
  const meNickEl      = document.getElementById("meNick");
  const presenceList  = document.getElementById("presenceList");
  const presenceToggle= document.getElementById("presenceToggle");
  const nicknameInput = document.getElementById("nickname");
  const languageSelect= document.getElementById("languageSelect"); // ìƒˆ ì–¸ì–´ ì„ íƒ ìš”ì†Œ
  const applyNick     = document.getElementById("applyNick"); // ë‹‰ë„¤ì„ ì ìš© ë²„íŠ¼

  /* ë“œë¡œì–´ ì—¬ë‹«ê¸° ë³´ì¥ í•¨ìˆ˜ (ì˜¤ë²„ë ˆì´ ì”ì¡´ ë°©ì§€) */
  function openDrawerNow(){
    drawer.classList.add("open");
    overlay.classList.add("show");
    overlay.style.pointerEvents = "auto";
  }
  function closeDrawerNow(){
    drawer.classList.remove("open");
    overlay.classList.remove("show");
    overlay.style.pointerEvents = "none";
  }

  function applyTheme(t){
    document.documentElement.setAttribute("data-theme", t);
    themeToggle.textContent = (t==="dark" ? "ğŸŒ™" : "â˜€ï¸");
    localStorage.setItem("theme", t);
  }

  function getStudyTimeToday(){
    // ëˆ„ì  ê³µë¶€ ì‹œê°„ (ì´ˆ)ì„ í¬ë§·í•˜ì—¬ ë°˜í™˜
    return fmt(state.studyTimeTotal);
  }

  // 2. í¬ì¶˜ ì¿ í‚¤ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
  function showFortuneMessage(){
    clearTimeout(fortuneBubbleTimeout);
    
    // 1. ë©”ì‹œì§€ ì„ íƒ
    const message = FORTUNE_MESSAGES[Math.floor(Math.random() * FORTUNE_MESSAGES.length)];
    
    // 2. ë©”ì‹œì§€ ì„¤ì • ë° í‘œì‹œ (fade-in)
    fortuneBubble.textContent = message;
    fortuneBubble.classList.remove('show');
    // DOM ì—…ë°ì´íŠ¸ë¥¼ ë³´ì¥í•œ í›„ í´ë˜ìŠ¤ ì¶”ê°€
    setTimeout(() => {
        fortuneBubble.classList.add('show');
    }, 50);

    // 3. 3ì´ˆ í›„ ì‚¬ë¼ì§ (fade-out)
    fortuneBubbleTimeout = setTimeout(() => {
        fortuneBubble.classList.remove('show');
    }, 3000);
  }


  /* [ë³µì›] ì´ë¯¸ì§€ ê¹œë¹¡ì„ ë¡œì§ ë¶„ë¦¬ ë° ì—…ë°ì´íŠ¸ - src ë³€ê²½ ë°©ì‹ ì‚¬ìš© */
  function updateCharacterAndWindowImages() {
    // running ìƒíƒœ ë˜ëŠ” isWork ìƒíƒœì— ë”°ë¼ ì‚¬ìš©í•  ì´ë¯¸ì§€ ìŒì„ ê²°ì •
    let charA, charB, winA, winB;

    if (state.running && state.isWork) {
        // íƒ€ì´ë¨¸ê°€ ëŒì•„ê°€ê³  ì§‘ì¤‘ì¤‘ì¼ ë•Œ: Work ì´ë¯¸ì§€ 1, 2 ì‚¬ìš©
        charA = charWorkA; charB = charWorkB;
        winA  = winWorkA;  winB  = winWorkB;
    } else {
        // íƒ€ì´ë¨¸ê°€ ëŒì•„ê°€ì§€ ì•Šê±°ë‚˜, íœ´ì‹ ì¤‘ì¼ ë•Œ
        charA = charBreakA; charB = charBreakB;
        winA  = winBreakA;  winB  = winBreakB;
    }

    // [ë³µì›] src ì†ì„±ì„ ì§ì ‘ ë³€ê²½í•˜ëŠ” ë°©ì‹ ì‚¬ìš©
    showA = !showA;
    charImg.src = showA ? charA : charB;
    winImg.src  = showA ? winA  : winB;
  }


  function init(){
    /* 4. ë‹¤í¬ëª¨ë“œë¥¼ ë””í´íŠ¸ë¡œ - ì´ë¯¸ state.theme='dark'ë¡œ ê¸°ë³¸ ì„¤ì •ë˜ì–´ìˆìŒ */
    applyTheme(state.theme);
    
    // ì–¸ì–´ ì„ íƒ ê¸°ëŠ¥ ì´ˆê¸°í™”
    languageSelect.value = state.lang;
    languageSelect.addEventListener('change', (e) => {
        state.lang = e.target.value;
        localStorage.setItem('lang', state.lang);
        updateTextByLanguage();
    });

    hamburgerBtn.addEventListener("click", openDrawerNow);
    closeDrawer  .addEventListener("click", closeDrawerNow);
    overlay      .addEventListener("click", closeDrawerNow);
    themeToggle  .addEventListener("click", ()=>{ state.theme = (state.theme==="dark")?"light":"light"===state.theme?"dark":"dark"; applyTheme(state.theme); });

    modeRadios.forEach(r=>{
      r.checked = (r.value === state.mode);
      r.addEventListener('change', ()=>{
        state.mode = r.value;
        localStorage.setItem("mode", state.mode);
        if(state.mode==='timer'){
          state.isWork = true; state.remainSec = 0; state.completedCycles = 0;
        }else{
          state.isWork = true; state.remainSec = state.workSec; state.completedCycles = 0;
        }
        stopTimer(); updateCyclesBtn(); updateTimerUI(); refreshModeFields();
      });
    });
    refreshModeFields();

    workMin.value = Math.round(state.workSec/60);
    restMin.value = Math.round(state.restSec/60);
    totalCyclesInput.value = state.totalCycles;
    updateCyclesBtn();

    const BG_PRESETS = [
      "https://github.com/nihicheli/studywithme/blob/main/image/background%205.png?raw=true",
      "https://github.com/nihicheli/studywithme/blob/main/image/background%206.png?raw=true",
      "https://github.com/nihicheli/studywithme/blob/main/image/background%202.png?raw=true",
      "https://github.com/nihicheli/studywithme/blob/main/image/background%204.png?raw=true",
      "https://github.com/nihicheli/studywithme/blob/main/image/background%203.png?raw=true"
    ];
    BG_PRESETS.forEach((url,i)=>{
      const btn=document.createElement("button");
      btn.className="pill";
      btn.innerHTML=`<img src="${url}" alt="bg${i}" style="width:42px;height:28px;object-fit:cover;border-radius:8px;vertical-align:middle;margin-right:.4rem;border:1px solid var(--line)"> ë°°ê²½ ${i+1}`;
      btn.addEventListener("click", ()=> setBackground(url));
      bgChips.appendChild(btn);
    });
    applyBg.addEventListener("click", ()=>{ const url=(customBgUrl.value||"").trim(); if(url) setBackground(url); });
    function setBackground(url){ document.documentElement.style.setProperty("--bg-url", `url("${url}")`); }

    customBgFile?.addEventListener("change", ()=>{
      // [ì˜¤ë¥˜ ìˆ˜ì •] customBgBgFile.files[0] -> customBgFile.files[0]
      const file = customBgFile.files && customBgFile.files[0]; 
      if(!file) return;
      bgFileName.textContent = file.name;
      const reader = new FileReader();
      reader.onload = (e)=>{
        const dataUrl = e.target.result;
        bgPreview.style.backgroundImage = `url("${dataUrl}")`;
        setBackground(dataUrl);
      };
      reader.readAsDataURL(file);
    });

    /* [ì¬ìˆ˜ì •] ì´ë¯¸ì§€ ê¹œë¹¡ì„ ë¡œì§: 500ms setInterval ë³µì› (íƒ€ì´ë¨¸ ë¡œì§ê³¼ ë…ë¦½) */
    updateCharacterAndWindowImages(); // ì´ˆê¸° ì´ë¯¸ì§€ ì„¤ì • (src ì„¤ì •)
    if (blinkTimer) clearInterval(blinkTimer); // í˜¹ì‹œ ëª¨ë¥¼ ì¤‘ë³µ ë°©ì§€
    blinkTimer = setInterval(updateCharacterAndWindowImages, 500);


    renderTodos();
    todoAdd.addEventListener("click", addTodo);
    todoInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") addTodo(); });

    initMoodsAndTracks();

    player.addEventListener("ended", onEnded);
    player.addEventListener("error", ()=>{
      const list = filteredTrackIdxs();
      if(list.length){
        const curPos = list.indexOf(state.trackIdx);
        const n = list[(curPos+1) % list.length];
        selectTrack(n,true);
      }
    });
    repeatBtn.addEventListener("click", toggleRepeat);

    applyPom.addEventListener("click", ()=>{
      if(state.mode === 'pomodoro'){
        const wm=Math.max(1,parseInt(workMin.value||"25",10));
        const rm=Math.max(1,parseInt(restMin.value||"5",10));
        const tc=Math.max(1,parseInt(totalCyclesInput.value||"4",10));
        state.workSec=wm*60; state.restSec=rm*60; state.totalCycles=tc;
        state.isWork=true; state.remainSec=state.workSec; state.completedCycles=0;
      }else{
        state.isWork=true; state.remainSec=0; state.totalCycles=1; state.completedCycles=0;
      }
      stopTimer(); updateCyclesBtn(); updateTimerUI();
    });
    cyclesBtn.addEventListener("click", ()=>{ state.completedCycles=0; updateCyclesBtn(); });

    updateWindowToggleUI();
    updateCharacterToggleUI();
    toggleWindowBtn.addEventListener("click", ()=>{
      state.windowVisible = !state.windowVisible;
      windowBox.style.display = state.windowVisible ? "" : "none";
      localStorage.setItem("ui-window-visible", state.windowVisible ? "1" : "0");
      updateWindowToggleUI();
    });
    toggleCharacterBtn.addEventListener("click", ()=>{
      state.characterVisible = !state.characterVisible;
      characterBox.style.display = state.characterVisible ? "" : "none";
      localStorage.setItem("ui-character-visible", state.characterVisible ? "1" : "0");
      updateCharacterToggleUI();
    });

    // 2. ìºë¦­í„° í„°ì¹˜ ì‹œ ë§í’ì„  í‘œì‹œ ì´ë²¤íŠ¸ ì¶”ê°€
    characterBox.addEventListener('click', showFortuneMessage);
    characterBox.addEventListener('touchstart', showFortuneMessage);

    setupLayoutDrag();

    /* íšŒì „(ê°„ì†Œí™”: ìŠ¤ì¼€ì¼ í˜¸ì¶œ ì œê±°) */
    function setRotate(on){
      state.rotateOn = !!on;
      localStorage.setItem('rotateOn', state.rotateOn ? "1" : "0");
      rotateToggle.textContent = getTranslation(state.rotateOn ? 'rotate_on' : 'rotate_off');
      applyRotateState();
    }
    function isSmartphone(){
      const ua = navigator.userAgent || navigator.vendor || window.opera || "";
      const looksMobileUA = /iPhone|iPod|Android.+Mobile|Mobi/i.test(ua);
      const smallViewport = Math.min(window.innerWidth, window.innerHeight) <= 820; 
      return looksMobileUA && smallViewport;
    }
    function applyRotateState(){
      const portrait = window.innerHeight > window.innerWidth;
      document.documentElement.classList.toggle('portrait-force', state.rotateOn && portrait);
    }
    rotateToggle.addEventListener('click', ()=> setRotate(!state.rotateOn));
    window.addEventListener('resize', applyRotateState);
    window.addEventListener('orientationchange', ()=> setTimeout(applyRotateState, 50));
    // ì €ì¥ëœ ê°’ì´ ì—†ìœ¼ë©´: ìŠ¤ë§ˆíŠ¸í° = ê¸°ë³¸ ON, ê·¸ ì™¸ = ê¸°ë³¸ OFF
    const savedRotate = localStorage.getItem('rotateOn');
    if (savedRotate === null) {
      setRotate(isSmartphone());        // ìŠ¤ë§ˆíŠ¸í°ì´ë©´ true, ì•„ë‹ˆë©´ false
    } else {
      setRotate(savedRotate === '1');   // ì‚¬ìš©ìê°€ ì´ì „ì— ì„ íƒí•œ ê°’ ìœ ì§€
    }

    /* ì†Œí’ˆ í”„ë¦¬ì…‹ */
    document.querySelectorAll('.propPreset').forEach(btn=>
      btn.addEventListener('click', ()=>{
        addProp(btn.dataset.url, true, {autoEdit:true});
        closeDrawerNow();           /* ì˜¤ë²„ë ˆì´ ì”ì¡´ ë°©ì§€ */
      })
    );

    /* (ê°œì„ ) ì†Œí’ˆ íŒŒì¼ ì„ íƒ: ëª¨ë°”ì¼ì—ì„œë„ 'ì„ íƒ ì¦‰ì‹œ ì¶”ê°€' */
    propFile.addEventListener('change', ()=>{
      const f = propFile.files && propFile.files[0];
      propFileName.textContent = f ? f.name : getTranslation('not_selected');
      if(f){
        const url = URL.createObjectURL(f);
        addProp(url, true, {autoEdit:true});
        // iOSì—ì„œ í¬ì»¤ìŠ¤/ë²„íŠ¼ ë¬¸ì œ ë°©ì§€: ë“œë¡œì–´ì™€ ì˜¤ë²„ë ˆì´ë¥¼ í™•ì‹¤íˆ ë‹«ê¸°
        closeDrawerNow();
        // íŒŒì¼ ì…ë ¥ ë¦¬ì…‹ (ê°™ì€ íŒŒì¼ ì¬ì²¨ë¶€ ê°€ëŠ¥)
        setTimeout(()=>{ propFile.value=""; propFileName.textContent=getTranslation('not_selected'); }, 0);
      }
    });

    /* (ìœ ì§€) ë³„ë„ì˜ 'íŒŒì¼ ì¶”ê°€' ë²„íŠ¼ë„ ì œê³µ */
    propFileAdd.addEventListener('click', ()=>{
      const f = propFile.files && propFile.files[0];
      if(!f) return;
      const url = URL.createObjectURL(f);
      addProp(url, true, {autoEdit:true});
      propFile.value = ""; propFileName.textContent = getTranslation('not_selected');
      closeDrawerNow();
    });

    propAdd.addEventListener('click', ()=>{
      const u=(propUrl.value||"").trim(); if(!u) return;
      addProp(u, true, {autoEdit:true});
      propUrl.value="";
      closeDrawerNow();
    });

    renderProps();

    function refreshShareStudyUI(){
      shareStudyBtn.textContent = getTranslation(state.shareStudy ? 'share_study_on' : 'share_study_off');
    }
    shareStudyBtn.addEventListener("click", ()=>{
      state.shareStudy = !state.shareStudy;
      localStorage.setItem('shareStudy', state.shareStudy ? "1" : "0");
      refreshShareStudyUI();
      window.__presence_broadcastNow?.();
    });
    refreshShareStudyUI();
    
    // ë‹‰ë„¤ì„ ì ìš© ë²„íŠ¼ ì´ë²¤íŠ¸
    applyNick.addEventListener('click', goOnline);


    // ì–¸ì–´ ì„¤ì • í›„ ë§ˆì§€ë§‰ì— UI í…ìŠ¤íŠ¸ ì¼ê´„ ì—…ë°ì´íŠ¸
    updateTextByLanguage();
    updateTimerUI();
    if(__resumeAfterReload){ startTimer(); }
  }

  function refreshModeFields(){
    const isPom = (state.mode === 'pomodoro');
    pomodoroFields.style.display = isPom ? '' : 'none';
    cyclesWrap.style.display     = isPom ? '' : 'none';
    stateEl.textContent = isPom ? (state.isWork?getTranslation('focusing'):getTranslation('resting')) : getTranslation('timer_mode');
  }

  /* [ìœ ì§€] Todo List ë Œë”ë§ ìµœì í™”: DocumentFragment ì‚¬ìš© */
  function renderTodos(){
    boardList.innerHTML = "";
    if(state.todos.length === 0) return;
    
    const fragment = document.createDocumentFragment();

    state.todos.forEach((t,idx)=>{
      const row=document.createElement("div"); row.className="todo";
      const cb=document.createElement("input"); cb.type="checkbox"; cb.checked=!!t.done;
      cb.addEventListener("change",()=>{ t.done=cb.checked; persistTodos(); renderTodos(); });
      const tx=document.createElement("div"); tx.className="txt"; tx.textContent=t.text;
      tx.style.textDecoration=t.done?"line-through":"none"; tx.style.opacity=t.done?".6":"1";
      const del=document.createElement("button"); del.className="del"; del.textContent=getTranslation('delete'); 
      del.addEventListener("click",()=>{ state.todos.splice(idx,1); persistTodos(); renderTodos(); });
      row.append(cb,tx,del); 
      fragment.appendChild(row);
    });
    
    boardList.appendChild(fragment);
  }
  function persistTodos(){ localStorage.setItem("todos-v1", JSON.stringify(state.todos)); }
  function addTodo(){ const v=todoInput.value.trim(); if(!v) return; state.todos.push({text:v,done:false}); todoInput.value=""; persistTodos(); renderTodos(); }

  function MOODS(){ return ["ì „ì²´","Lo-Fi","Jazz","Loud","Piano","Ambient","Noise"]; } /* Ambient ì¶”ê°€ */
  function filteredTrackIdxs(){
    if(state.mood==="ì „ì²´") return TRACKS.map((_,i)=>i);
    return TRACKS.map((t,i)=> t.mood===state.mood ? i : -1).filter(i=>i>=0);
  }
  function initMoodsAndTracks(){
    moodsWrap.innerHTML = "";
    const moodFragment = document.createDocumentFragment();
    MOODS().forEach(m=>{
      const b=document.createElement("button");
      b.className="pill"; b.textContent=m; b.dataset.mood=m;
      b.addEventListener("click", ()=>{ state.mood=m; highlightMood(); renderTracks(); });
      moodFragment.appendChild(b);
    });
    moodsWrap.appendChild(moodFragment);
    highlightMood();
    renderTracks(true);
  }
  /* [ìœ ì§€] ìŒì•… íŠ¸ë™ ë Œë”ë§ ìµœì í™”: DocumentFragment ì‚¬ìš© */
  function renderTracks(initial=false){
    tracksWrap.innerHTML = "";
    const idxs = filteredTrackIdxs();
    
    const fragment = document.createDocumentFragment();
    idxs.forEach(idx=>{
      const t = TRACKS[idx];
      const b=document.createElement("button");
      b.className="pill"; b.textContent=t.title; b.dataset.idx=idx;
      b.addEventListener("click", ()=> selectTrack(idx, state.playing));
      fragment.appendChild(b);
    });
    tracksWrap.appendChild(fragment);

    if(!idxs.includes(state.trackIdx) && idxs.length){
      selectTrack(idxs[0], false);
    }
    highlightTrack();
    if(initial){ selectTrack(idxs[0] ?? 0, false); }
  }
  function selectTrack(idx, autoplay=false){ state.trackIdx=idx; player.src=TRACKS[idx].url; highlightTrack(); if(autoplay) tryPlay(); }
  function tryPlay(){ player.play().then(()=>{ state.playing=true; playPause.textContent=getTranslation('pause_music'); }).catch(()=>{}); }
  function highlightMood(){ [...moodsWrap.children].forEach(b=>{ b.style.boxShadow = (b.dataset.mood===state.mood) ? "inset 0 0 0 1px #7C9AFF" : "none"; }); }
  function highlightTrack(){ [...tracksWrap.children].forEach(b=>{ b.style.boxShadow = (+b.dataset.idx===state.trackIdx) ? "inset 0 0 0 1px #7C9AFF" : "none"; }); }
  document.getElementById("playPause").addEventListener("click", ()=>{
    if(!player.src) selectTrack(state.trackIdx,false);
    if(!state.playing){ tryPlay(); } else { player.pause(); state.playing=false; playPause.textContent=getTranslation('play'); }
  });
  document.getElementById("shuffle").addEventListener("click", ()=>{ state.shuffle=!state.shuffle; shuffleBtn.textContent=getTranslation(state.shuffle?'shuffle_on':'shuffle_off'); });
  function toggleRepeat(){ 
      const order=["off","one","all"]; 
      const i=order.indexOf(state.repeatMode); 
      state.repeatMode=order[(i+1)%order.length]; 
      updateRepeatUI(); 
  }
  function getRepeatKey(mode) {
      if (mode === 'one') return 'repeat_one';
      if (mode === 'all') return 'repeat_all';
      return 'repeat_off';
  }
  function updateRepeatUI(){ 
      repeatBtn.textContent=getTranslation(getRepeatKey(state.repeatMode)); 
      player.loop=(state.repeatMode==="one"); 
  }
  updateRepeatUI();
  function onEnded(){
    if(state.repeatMode==="one") return;
    const list = filteredTrackIdxs();
    if(state.shuffle){
      let n = state.trackIdx;
      if(list.length>1){
        while(n===state.trackIdx) n = list[Math.floor(Math.random()*list.length)];
      }
      selectTrack(n,true); return;
    }
    if(state.repeatMode==="all" && list.length){
      const cur = list.indexOf(state.trackIdx);
      const n = list[(cur+1)%list.length];
      selectTrack(n,true); return;
    }
    state.playing=false; playPause.textContent=getTranslation('play');
  }

  function fmt(sec){
    const s=Math.max(0,sec|0);
    const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), ss=s%60;
    const mm=m.toString().padStart(2,'0'); const s2=ss.toString().padStart(2,'0');
    return h>0?`${h}:${mm}:${s2}`:`${mm}:${s2}`;
  }
  function updateTimerUI(){
    // [ìœ ì§€] UI ì—…ë°ì´íŠ¸ ì‹œ calculateAccurateRemainingì„ ì‚¬ìš©í•˜ì—¬ ì •í™•í•œ ë‚¨ì€ ì‹œê°„ ë°˜ì˜
    state.remainSec = calculateAccurateRemaining(); 
    timeEl.textContent=fmt(state.remainSec);
    
    let statusKey = 'timer_mode';
    if(state.mode === 'pomodoro') {
        statusKey = state.isWork ? 'focusing' : 'resting';
    }
    stateEl.textContent=getTranslation(statusKey);
    
    startPause.textContent=getTranslation(state.running?'pause':'start');
    
    window.__presence_broadcastNow?.();
  }
  function beep(){ try{ const ctx=new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(); const g=ctx.createGain(); o.connect(g); g.connect(ctx.destination);
    o.type="sine"; o.frequency.value=880; g.gain.setValueAtTime(.0001,ctx.currentTime); g.gain.exponentialRampToValueAtTime(.3,ctx.currentTime+.01); o.start(); g.gain.exponentialRampToValueAtTime(.0001,ctx.currentTime+.25); o.stop(ctx.currentTime+.3);}catch{} }
  
  /* [ìœ ì§€] ì‹¤ì‹œê°„ íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ë°˜ì˜ Timer Tick í•¨ìˆ˜ (SetTimeout ì¬ê·€) */
  function timerTick() {
    if (!state.running) {
      return;
    }

    const now = Date.now();
    // íƒ€ì´ë¨¸ ì‹œì‘ ì‹œì  ëŒ€ë¹„ ì‹¤ì œ ê²½ê³¼ ì´ˆ
    const elapsedRealSeconds = Math.floor((now - state.startTimeStamp) / 1000);
    let shouldAccumulate = false;
    let nextRemainSec = 0;

    if (state.mode === 'pomodoro') {
      const originalTotalTime = (state.isWork ? state.workSec : state.restSec);
      nextRemainSec = originalTotalTime - elapsedRealSeconds;
      
      if (nextRemainSec <= 0) {
        // ì‚¬ì´í´ ì „í™˜ ì²˜ë¦¬
        beep();
        const wasWork = state.isWork;
        state.isWork = !state.isWork;

        // ì´ˆê³¼ëœ ì‹œê°„ì„ ë³´ì •í•˜ì—¬ ìƒˆë¡œìš´ phaseì˜ startTimeStamp ì„¤ì •
        state.startTimeStamp = now + nextRemainSec * 1000; 
        
        state.remainSec = state.isWork ? state.workSec : state.restSec; // ë‹¤ìŒ phaseì˜ ì´ˆê¸°ê°’
        
        if (state.isWork && !wasWork){
          state.completedCycles = Math.min(state.totalCycles, state.completedCycles + 1);
          updateCyclesBtn();
          if (state.completedCycles >= state.totalCycles) { stopTimer(); return; }
        }
        // updateCharacterAndWindowImages(); // [ì‚­ì œ] ê·¸ë¦¼ ì• ë‹ˆë©”ì´ì…˜ì€ ë³„ë„ì˜ 500ms íƒ€ì´ë¨¸ê°€ ë‹´ë‹¹
        shouldAccumulate = true; // ìƒˆë¡œìš´ í˜ì´ì¦ˆ ì‹œì‘ ì‹œë„
      } else {
        state.remainSec = nextRemainSec;
        if(state.isWork) shouldAccumulate = true;
      }
    } else { // Timer mode (Count-up)
      state.remainSec = elapsedRealSeconds;
      shouldAccumulate = true;
    }

    // ëˆ„ì  ê³µë¶€ ì‹œê°„ ì—…ë°ì´íŠ¸ (ì‹¤ì œ ê²½ê³¼ ì‹œê°„ ê¸°ë°˜)
    if(shouldAccumulate && state.lastUpdateTimestamp > 0) {
        const deltaSeconds = Math.floor((now - state.lastUpdateTimestamp) / 1000);
        if (deltaSeconds > 0) state.studyTimeTotal += deltaSeconds;
    }
    state.lastUpdateTimestamp = now;

    updateTimerUI();
    // updateCharacterAndWindowImages(); // [ì‚­ì œ] ê·¸ë¦¼ ì• ë‹ˆë©”ì´ì…˜ì€ ë³„ë„ì˜ 500ms íƒ€ì´ë¨¸ê°€ ë‹´ë‹¹
    
    // [ìœ ì§€] 1ì´ˆë§ˆë‹¤ í˜ì´ì§€ ì œëª© ì—…ë°ì´íŠ¸ (ì§€ì—° ê°ì†Œ)
    document.title = `${fmt(state.remainSec)} â€¢ Studywithme`;

    // ë‹¤ìŒ í‹±ì„ ì •í™•íˆ 1ì´ˆ í›„ì— ì‹¤í–‰ë˜ë„ë¡ ìŠ¤ì¼€ì¤„ë§
    const timeSinceLastSecond = (now - state.startTimeStamp) % 1000;
    const nextTick = 1000 - timeSinceLastSecond;
    
    if(state.interval) clearTimeout(state.interval);
    state.interval = setTimeout(timerTick, nextTick);
  }

  /* [ìœ ì§€] íƒ€ì´ë¨¸ ì‹œì‘ (setInterval ëŒ€ì‹  setTimeout ì¬ê·€ ì‹œì‘) */
  function startTimer(){
    if(state.running) return;
    
    // ë‚¨ì€ ì‹œê°„(remainSec)ì„ ê¸°ì¤€ìœ¼ë¡œ startTimeStamp ì—­ê³„ì‚°
    const totalTimeInSeconds = (state.mode === 'pomodoro' && state.isWork) 
                                ? state.workSec : state.remainSec; // count-upì€ remainSecì´ ê²½ê³¼ ì‹œê°„
    
    state.startTimeStamp = Date.now() - (totalTimeInSeconds - state.remainSec) * 1000;
    state.lastUpdateTimestamp = Date.now(); // Accumulation ì‹œì‘ ì‹œì 

    state.running=true;
    updateTimerUI();
    // updateCharacterAndWindowImages(); // [ì‚­ì œ] ê·¸ë¦¼ ì• ë‹ˆë©”ì´ì…˜ì€ ë³„ë„ì˜ 500ms íƒ€ì´ë¨¸ê°€ ë‹´ë‹¹

    // ì²« ë²ˆì§¸ í‹±ì„ ë°”ë¡œ ì‹œì‘
    if(state.interval) clearTimeout(state.interval);
    state.interval = setTimeout(timerTick, 0); 
    
    window.__presence_broadcastNow?.();
  }
  
  /* [ìœ ì§€] íƒ€ì´ë¨¸ ì¤‘ì§€ (ì •í™•í•œ ìµœì¢… ì‹œê°„ ë°˜ì˜) */
  function stopTimer(){
    if(!state.running) return;
    state.running=false;
    
    if(state.interval){ 
        clearTimeout(state.interval); 
        state.interval=null; 
    }
    
    // ë©ˆì¶”ëŠ” ì‹œì ì˜ ì •í™•í•œ remainSec ë° studyTimeTotal ë°˜ì˜
    const now = Date.now();
    const elapsedRealSeconds = Math.floor((now - state.startTimeStamp) / 1000);
    const deltaSeconds = Math.floor((now - state.lastUpdateTimestamp) / 1000);
    
    if (state.mode === 'pomodoro') {
      const originalTotalTime = (state.isWork ? state.workSec : state.restSec);
      state.remainSec = originalTotalTime - elapsedRealSeconds;
      if(state.isWork && deltaSeconds > 0) state.studyTimeTotal += deltaSeconds;
    } else { // Timer mode (Count-up)
      state.remainSec = elapsedRealSeconds;
      if(deltaSeconds > 0) state.studyTimeTotal += deltaSeconds;
    }
    
    state.startTimeStamp = 0; 
    state.lastUpdateTimestamp = 0; 

    updateTimerUI();
    // updateCharacterAndWindowImages(); // [ì‚­ì œ] ê·¸ë¦¼ ì• ë‹ˆë©”ì´ì…˜ì€ ë³„ë„ì˜ 500ms íƒ€ì´ë¨¸ê°€ ë‹´ë‹¹
    window.__presence_broadcastNow?.();
    
    // [ìœ ì§€] ì •ì§€ ì‹œ ì œëª©ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µêµ¬
    document.title = `Studywithme`;
  }
  
  /* [ìœ ì§€] íƒ€ì´ë¨¸ ë¦¬ì…‹ */
  function resetTimer(){
    stopTimer();
    state.isWork=true;
    state.remainSec = (state.mode==='pomodoro') ? state.workSec : 0;
    state.startTimeStamp = 0;
    state.lastUpdateTimestamp = 0;
    updateTimerUI();
    // updateCharacterAndWindowImages(); // [ì‚­ì œ] ê·¸ë¦¼ ì• ë‹ˆë©”ì´ì…˜ì€ ë³„ë„ì˜ 500ms íƒ€ì´ë¨¸ê°€ ë‹´ë‹¹
    
    // [ìœ ì§€] ë¦¬ì…‹ ì‹œ ì œëª©ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µêµ¬
    document.title = `Studywithme`;
  }
  
  document.getElementById("startPause").addEventListener("click", ()=> state.running?stopTimer():startTimer());
  document.getElementById("reset").addEventListener("click", resetTimer);
  function updateCyclesBtn(){ 
      const text = `${state.completedCycles}/${state.totalCycles}íšŒ`;
      cyclesBtn.textContent = text;
      cyclesBtn.title = text;
  }

  function updateWindowToggleUI(){ 
      const show = state.windowVisible;
      toggleWindowBtn.textContent = getTranslation(show ? 'window_show' : 'window_hide');
      windowBox.style.display = show ? "" : "none"; 
  }
  function updateCharacterToggleUI(){ 
      const show = state.characterVisible;
      toggleCharacterBtn.textContent = getTranslation(show ? 'character_show' : 'character_hide');
      characterBox.style.display = show ? "" : "none"; 
  }

  function setupLayoutDrag(){
    const APP = document.getElementById('app');
    const DRAG_IDS = ['timer','board','window','character','music-controls'];
    const RESIZE_IDS = ['window','character'];
    const Z_TOP_CAP = 8999;

    const registry = new Map();
    // window.editOn ì „ì—­ ë³€ìˆ˜í™” (layoutEditBtn í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´)
    window.editOn = false; 
    let zTop = 100;

    const posKey = id => `pos-${id}`;

    function restorePositionsOnLoad(){
      DRAG_IDS.forEach(id=>{
        const el = document.getElementById(id);
        if(!el) return;
        const saved = localStorage.getItem(posKey(id));
        if(saved){
          const {left, top, width} = JSON.parse(saved);
          absolutize(el);
          place(el, left, top, width);
        }
      });
    }

    function absolutize(el){
      if(registry.has(el.id)) return;
      const rect = el.getBoundingClientRect();
      const appRect = APP.getBoundingClientRect();

      const ph = document.createElement('div');
      ph.style.width  = rect.width + 'px';
      ph.style.height = rect.height + 'px';
      ph.style.visibility = 'hidden';
      el.parentNode.insertBefore(ph, el);

      el.style.position = 'absolute';
      el.style.width    = rect.width + 'px';
      el.style.left     = (rect.left - appRect.left + window.scrollX) + 'px';
      el.style.top      = (rect.top  - appRect.top  + window.scrollY) + 'px';
      el.style.zIndex   = (parseInt(el.style.zIndex||'10',10));
      APP.appendChild(el);

      if(el.classList.contains('resizable') && !el.querySelector('.resizer')){
        const rz = document.createElement('div');
        rz.className = 'resizer';
        el.appendChild(rz);
      }

      registry.set(el.id, {el, placeholder: ph});
    }

    function place(el, left, top, width){
      if(width) el.style.width = width + 'px';
      el.style.left = left + 'px';
      el.style.top  = top  + 'px';
    }

    function setEditable(on){
      window.editOn = on;
      document.getElementById('app').classList.toggle('edit-on', on);
      layoutEditBtn.textContent = getTranslation(on ? 'layout_edit_on' : 'layout_edit_off');

      DRAG_IDS.forEach(id=>{
        const el = document.getElementById(id);
        if(!el) return;

        if(on){
          if(!registry.has(id)) absolutize(el);
          el.classList.add('draggable');
          enableDrag(el);
          if(RESIZE_IDS.includes(id)) enableResize(el);
        }else{
          el.classList.remove('draggable');
          disableDrag(el);
          if(RESIZE_IDS.includes(id)) disableResize(el);
        }
      });

      document.querySelectorAll('.prop').forEach(el=>{
        if(on){ enableDrag(el); enableResize(el); }
        else  { disableDrag(el); disableResize(el); }
      });
    }

    window.__layoutSetEditable = setEditable;
    window.__layoutFocus = (pid)=>{
      const el = document.querySelector(`.prop[data-pid="${pid}"]`);
      if(!el) return;
      el.style.zIndex = Math.min(++zTop, Z_TOP_CAP);
      el.classList.add('selected');
      setTimeout(()=> el.classList.remove('selected'), 1500);
      el.scrollIntoView?.({behavior:'smooth', block:'center', inline:'center'});
    };

    function enableDrag(el){
      if(el._dragBound) return;
      const onDown = (e)=>{
        if(!window.editOn) return;
        if(e.target.classList && e.target.classList.contains('resizer')) return;

        e.preventDefault();
        el.classList.add('dragging');
        el.style.zIndex = Math.min(++zTop, Z_TOP_CAP);

        const startX = (e.touches? e.touches[0].clientX : e.clientX);
        const startY = (e.touches? e.touches[0].clientY : e.clientY);
        const startLeft = parseFloat(el.style.left)||0;
        const startTop  = parseFloat(el.style.top)||0;

        const move = (ev)=>{
          const cx = (ev.touches? ev.touches[0].clientX : ev.clientX);
          const cy = (ev.touches? ev.touches[0].clientY : ev.clientY);
          const dx = cx - startX;
          const dy = cy - startY;
          place(el, startLeft + dx, startTop + dy);
        };
        const up = ()=>{
          document.removeEventListener('pointermove', move);
          document.removeEventListener('pointerup', up);
          document.removeEventListener('touchmove', move);
          document.removeEventListener('touchend', up);
          el.classList.remove('dragging');
          persistPos(el);
        };

        document.addEventListener('pointermove', move);
        document.addEventListener('pointerup', up);
        document.addEventListener('touchmove', move, {passive:false});
        document.addEventListener('touchend', up);
      };
      el.addEventListener('pointerdown', onDown);
      el.addEventListener('touchstart', onDown, {passive:false});
      el._dragBound = onDown;
    }
    function disableDrag(el){
      if(!el._dragBound) return;
      el.removeEventListener('pointerdown', el._dragBound);
      el.removeEventListener('touchstart', el._dragBound);
      delete el._dragBound;
    }

    function enableResize(el){
      if(el._resizeBound) return;
      const onDown = (e)=>{
        if(!window.editOn) return;
        if(!e.target.classList || !e.target.classList.contains('resizer')) return;
        e.preventDefault();
        el.classList.add('dragging');
        el.style.zIndex = Math.min(++zTop, Z_TOP_CAP);

        const startX = (e.touches? e.touches[0].clientX : e.clientX);
        const startWidth = parseFloat(el.style.width) || el.getBoundingClientRect().width;

        const move = (ev)=>{
          const cx = (ev.touches? ev.touches[0].clientX : ev.clientX);
          const dx = cx - startX;
          const newW = Math.max(120, startWidth + dx);
          el.style.width = newW + 'px';
        };
        const up = ()=>{
          document.removeEventListener('pointermove', move);
          document.removeEventListener('pointerup', up);
          document.removeEventListener('touchmove', move);
          document.removeEventListener('touchend', up);
          el.classList.remove('dragging');
          persistPos(el);
        };

        document.addEventListener('pointermove', move);
        document.addEventListener('pointerup', up);
        document.addEventListener('touchmove', move);
        document.addEventListener('touchend', up);
      };
      el.addEventListener('pointerdown', onDown);
      el.addEventListener('touchstart', onDown, {passive:false});
      el._resizeBound = onDown;
    }
    function disableResize(el){
      if(!el._resizeBound) return;
      el.removeEventListener('pointerdown', el._resizeBound);
      el.removeEventListener('touchstart', el._resizeBound);
      delete el._resizeBound;
    }

    function persistPos(el){
      const left = parseFloat(el.style.left)||0;
      const top  = parseFloat(el.style.top)||0;
      const width= parseFloat(el.style.width)||el.getBoundingClientRect().width;

      if(el.classList.contains('prop')){
        const id = el.dataset.pid;
        const idx = state.props.findIndex(p=>p.id===id);
        if(idx>=0){ state.props[idx].left=left; state.props[idx].top=top; state.props[idx].width=width; }
        localStorage.setItem('props-v1', JSON.stringify(state.props));
      }else{
        localStorage.setItem(`pos-${el.id}`, JSON.stringify({left, top, width}));
      }
    }

    layoutResetBtn.addEventListener('click', ()=>{
      // [ìœ ì§€] ë¦¬ì…‹ ì „ ì •í™•í•œ remainSecì„ ê³„ì‚°í•˜ì—¬ ì €ì¥
      const snap = {
        mode: state.mode, isWork: state.isWork, running: state.running,
        workSec: state.workSec, restSec: state.restSec, 
        remainSec: calculateAccurateRemaining(),
        totalCycles: state.totalCycles, completedCycles: state.completedCycles
      };
      sessionStorage.setItem('timer-keep', JSON.stringify(snap));

      DRAG_IDS.forEach(id=> localStorage.removeItem(`pos-${id}`));
      localStorage.removeItem('props-v1');
      localStorage.removeItem('ui-window-visible');
      localStorage.removeItem('ui-character-visible');
      location.reload();
    });

    layoutEditBtn.addEventListener('click', ()=> setEditable(!window.editOn));
    restorePositionsOnLoad();
  }

  function renderProps(){
    propsLayer.innerHTML = '';
    state.props.forEach(p=>{
      const el = document.createElement('div');
      el.className = 'prop resizable';
      el.dataset.pid = p.id;
      el.style.left = (p.left ?? 40) + 'px';
      el.style.top  = (p.top  ?? 40) + 'px';
      el.style.width= (p.width?? 120) + 'px';
      el.style.zIndex = 80;

      const img = document.createElement('img');
      img.src = p.url; img.alt = 'prop';
      el.appendChild(img);

      const rz = document.createElement('div'); rz.className='resizer'; el.appendChild(rz);
      propsLayer.appendChild(el);
    });
    renderPropList();
  }
  function renderPropList(){
    propList.innerHTML = '';
    const fragment = document.createDocumentFragment();
    state.props.forEach(p=>{
      const row = document.createElement('div'); row.className='todo';
      const tx  = document.createElement('div'); tx.className='txt';
      tx.innerHTML = `<img src="${p.url}" style="width:28px;height:28px;object-fit:contain;vertical-align:middle;margin-right:.5rem"> ${p.id}`;
      const del = document.createElement('button'); del.className='del'; del.textContent=getTranslation('delete');
      del.addEventListener('click', ()=>{
        const idx = state.props.findIndex(x=>x.id===p.id);
        if(idx>=0) state.props.splice(idx,1);
        localStorage.setItem('props-v1', JSON.stringify(state.props));
        renderProps();
      });
      row.append(tx, del);
      fragment.appendChild(row);
    });
    propList.appendChild(fragment);
  }
  function addProp(url, center=true, opts={}){
    const id = 'prop-' + Date.now().toString(36);
    const MINW = 120;
    let left=40, top=40, width=MINW;
    if(center){
      const appRect = document.getElementById('app').getBoundingClientRect();
      left = Math.max(0, Math.floor((appRect.width - width)/2));
      top  = Math.max(0, Math.floor((appRect.height - width)/2));
    }
    state.props.push({id, url, left, top, width});
    localStorage.setItem('props-v1', JSON.stringify(state.props));
    renderProps();

    if(opts.autoEdit){
      window.__layoutSetEditable?.(true);
      setTimeout(()=> window.__layoutFocus?.(id), 0);
    }
  }

  init();
</script>

<!-- ===== Supabase Presence (ì‹¤ì‹œê°„) ===== -->
<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL = "https://jvpasqknlkeyshrevqpg.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2cGFzcWtubGtleXNocmV2cXBnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwNDQyOTMsImV4cCI6MjA3NDYyMDI5M30.7zKRGoBFjoWksoRXjUj8n4KzLXdiF86lZwneNdZNF5k";

const presencePanel = document.getElementById("presencePanel");
const meNickEl      = document.getElementById("meNick");
const presenceList  = document.getElementById("presenceList");
const presenceToggle= document.getElementById("presenceToggle");
const nicknameInput = document.getElementById("nickname");
const applyNick     = document.getElementById("applyNick"); // ì¶”ê°€ëœ ë‹‰ë„¤ì„ ì ìš© ë²„íŠ¼

// --- smartphone detector (ì—¬ê¸°ì— ì¶”ê°€) ---
function isSmartphone(){
  const ua = navigator.userAgent || navigator.vendor || window.opera || "";
  const looksMobileUA = /iPhone|iPod|Android.+Mobile|Mobi/i.test(ua);
  const smallViewport = Math.min(window.innerWidth, window.innerHeight) <= 820; // íƒœë¸”ë¦¿ ì œì™¸ìš© ì—¬ìœ ê°’
  return looksMobileUA && smallViewport;
}

  
let supabase = null;
let channel  = null;
let heartbeat= null;

/* [ìˆ˜ì •] ë‹‰ë„¤ì„ì´ ìˆìœ¼ë©´ ìë™ ì—°ê²° */
window.addEventListener('load', ()=>{ 
    const savedNick = localStorage.getItem("nickname");
    // ë‹‰ë„¤ì„ ë¡œë“œ ë° UI ì—…ë°ì´íŠ¸
    if (savedNick) {
        nicknameInput.value = savedNick;
        meNickEl.textContent = savedNick; // ë‹‰ë„¤ì„ UIì— í‘œì‹œ
    }
    
    // ë‹‰ë„¤ì„ì´ ìˆê³ , ì„¤ì • ì¤€ë¹„ê°€ ë˜ì—ˆìœ¼ë©´ goOnline() ì‹œë„
    if (cfgReady() && savedNick && savedNick.trim() !== "") { 
        goOnline(); 
    }
});

function cfgReady(){
  return SUPABASE_URL.startsWith("https://") && !!SUPABASE_ANON_KEY;
}
function getSnapshot(){
  const st = window.state || {};
  let study = null;
  
  // 1. ê³µë¶€ ì‹œê°„ ê³µê°œê°€ ONì¼ ë•Œë§Œ studyTimeTotal ì „ì†¡ (ë¡¤ë°±ëœ ë¡œì§)
  if(st.shareStudy){
    // [ìœ ì§€] ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì‹œ studyTimeTotalì„ ì •í™•íˆ ë°˜ì˜
    const now = Date.now();
    let currentStudyTotal = st.studyTimeTotal;
    
    // íƒ€ì´ë¨¸ê°€ ì‘ë™ ì¤‘ì´ê³  ì§‘ì¤‘ì¤‘/ì¹´ìš´íŠ¸ì—… ëª¨ë“œë¼ë©´, í˜„ì¬ê¹Œì§€ì˜ ë¸íƒ€ë¥¼ ë”í•´ì¤Œ
    if (st.running && (st.mode === 'timer' || st.isWork)) {
        // studyTimeTotalì€ ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œì (lastUpdateTimestamp)ì„ ê¸°ì¤€ìœ¼ë¡œ ëˆ„ì ë¨.
        // ì—¬ê¸°ì„œëŠ” lastUpdateTimestamp ì´í›„ ê²½ê³¼ëœ ì‹œê°„ë§Œ ì¶”ê°€
        const deltaSeconds = Math.floor((now - st.lastUpdateTimestamp) / 1000);
        currentStudyTotal += deltaSeconds;
    }
    
    study = currentStudyTotal || 0;
  }
  
  let status = "idle"; // ê¸°ë³¸ ìƒíƒœë¥¼ 'idle'ë¡œ ì„¤ì •
  
  if (st.running) {
      // íƒ€ì´ë¨¸ê°€ ì‘ë™ ì¤‘ì¼ ë•Œë§Œ ìƒíƒœë¥¼ work/break/timerë¡œ ì„¤ì •
      status = (st.mode === 'pomodoro') ? (st.isWork ? "work" : "break") : "timer";
  }
  
  return { status, study };
}
function fmtMin(sec){
    const s = sec|0; // ì´ˆ ì •ìˆ˜í™”
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    
    // 1ë¶„ ë¯¸ë§Œì€ 0ë¶„ìœ¼ë¡œ í‘œì‹œ
    if (s < 60) return `0${getTranslation('min_short')}`; 
    
    // 1ì‹œê°„ ì´ìƒì¼ ê²½ìš° "Xì‹œê°„ Yë¶„" í¬ë§·
    if(h > 0) return `${h}${getTranslation('hour_short')} ${m}${getTranslation('min_short')}`;
    
    // 1ì‹œê°„ ë¯¸ë§Œì¼ ê²½ìš° "Yë¶„" í¬ë§·
    return `${m}${getTranslation('min_short')}`;
}

function getTranslation(key) {
    const lang = window.state.lang;
    // ìœˆë„ìš° ê°ì²´ì— TRANSLATIONSê°€ ìˆì„ ê²½ìš° ì‚¬ìš© (ì‹¤ì œ ì•± ë¡œì§)
    if (window.TRANSLATIONS) {
        return window.TRANSLATIONS[lang][key] || window.TRANSLATIONS['en'][key] || key;
    }
    // ë””ë²„ê·¸ ìš© ê¸°ë³¸ê°’
    const debugTranslations = {
        ko: { status_work: "ì§‘ì¤‘ì¤‘", status_break: "íœ´ì‹ì¤‘", status_idle: "ëŒ€ê¸°ì¤‘", timer_mode: "íƒ€ì´ë¨¸", hour_short: "ì‹œê°„", min_short: "ë¶„", no_one_online: "ì•„ì§ ì•„ë¬´ë„ ì—†ì–´ìš”" },
        en: { status_work: "Focusing", status_break: "Resting", status_idle: "Idle", timer_mode: "Timer Mode", hour_short: "h", min_short: "m", no_one_online: "No one online yet" }
    };
    return debugTranslations[lang]?.[key] || key;
}

function renderOnline(presenceState){
  const items = [];
  
  for(const [nick, metas] of Object.entries(presenceState)){
    const meta = metas[metas.length-1] || {};
    const status = meta?.status || "idle";
    // studyê°€ nullì´ë©´ ê³µê°œ OFF, numberë©´ ê³µê°œ ON
    const study  = typeof meta?.study  === "number" ? meta.study  : null; 

    let statusKey = '';
    let dotClass = 'dot';
    
    // 1. ìƒíƒœ ë° ì  ìƒ‰ìƒ ê²°ì •
    if (status === 'work') {
        statusKey = 'status_work';
        dotClass += ' work';
    } else if (status === 'break') {
        statusKey = 'status_break';
        dotClass += ' break';
    } else if (status === 'timer') {
        statusKey = 'timer_mode';
        dotClass += ' work';
    } else { // status === 'idle' (íƒ€ì´ë¨¸ ì •ì§€/ë¯¸ì‹œì‘ ìƒíƒœ)
        statusKey = 'status_idle';
    }

    let rightTxt = getTranslation(statusKey);
    
    // 2. ê³µë¶€ì‹œê°„ ê³µê°œ ì—¬ë¶€ì— ë”°ë¼ í…ìŠ¤íŠ¸ ê²°ì •
    if (study !== null) {
      // ê³µë¶€ì‹œê°„ ê³µê°œ ON: ìƒíƒœ + ëˆ„ì  ê³µë¶€ ì‹œê°„
      const studyTimeText = fmtMin(study);
      // [ìˆ˜ì •] "ì§‘ì¤‘ì¤‘ Â· ëˆ„ì  57ë¶„" í˜•íƒœë¡œ í‘œì‹œ
      rightTxt = `${getTranslation(statusKey)} Â· ëˆ„ì  ${studyTimeText}`; 
    } else {
        // ê³µë¶€ì‹œê°„ ê³µê°œ OFF: ìƒíƒœ í…ìŠ¤íŠ¸ë§Œ ìœ ì§€ (rightTxt = getTranslation(statusKey))
    }
    
    items.push(
      `<div class="person">
         <div><span class="${dotClass}"></span><span class="nick">${nick}</span></div>
         <div style="opacity:.8">${rightTxt}</div>
       </div>`
    );
  }
  
  const noOneOnlineText = getTranslation('no_one_online')
  
  // ë‹‰ë„¤ì„ì´ 'anonymous'ì¸ ì‚¬ìš©ìëŠ” í•„í„°ë§ (ë¡œì»¬ ìœ ì €ê°€ ë‹‰ë„¤ì„ ì„¤ì •ì„ í•˜ì§€ ì•Šì•˜ì„ ê²½ìš°)
  const filteredItems = items.filter(item => !item.includes('<span class="nick">anonymous</span>'));

  presenceList.innerHTML = filteredItems.slice(0,5).join("") || `<div style="opacity:.8">${noOneOnlineText}</div>`;
}

window.__presence_broadcastNow = async function(){
  if(!channel) return;
  try{ await channel.track(getSnapshot()); }catch{}
};
window.__presence_goOnline = goOnline;
window.__presence_goOffline = goOffline;

async function goOnline(){
  if(!cfgReady()){ 
      console.error("Supabase configuration not ready.");
      presencePanel.style.display = "none";
      return; 
  }
  if(!supabase) supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const myNick = (nicknameInput.value || "").trim();
  
  // ë‹‰ë„¤ì„ì´ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ì—°ê²°í•˜ì§€ ì•Šê³  ì¢…ë£Œ
  if (myNick === "" || myNick === "anonymous") {
      goOffline(); // ì—°ê²°ë˜ì–´ ìˆì„ ê²½ìš° ëŠìŒ
      return; 
  }
  
  // ë‹‰ë„¤ì„ ë³€ê²½/ì„¤ì • ë¡œì§
  localStorage.setItem("nickname", myNick); 
  meNickEl.textContent = myNick;
  presencePanel.style.display = "block";

  // ì±„ë„ì´ ì´ë¯¸ ì¡´ì¬í•˜ê±°ë‚˜ ë‹‰ë„¤ì„ì´ ë³€ê²½ë˜ì—ˆë‹¤ë©´ ì¬ì—°ê²°
  if (channel) {
      await channel.unsubscribe();
      if(heartbeat){ clearInterval(heartbeat); heartbeat = null; }
  }

  channel = supabase.channel("studyroom", { config: { presence: { key: myNick } } });
  channel.on("presence", { event: "sync" }, ()=>{ renderOnline(channel.presenceState()); });

  channel.subscribe(async (status)=>{
    if(status === "SUBSCRIBED"){
      try{ await channel.track(getSnapshot()); }catch{}
      // [ìœ ì§€] heartbeatëŠ” ê·¸ëŒ€ë¡œ 15ì´ˆ ê°„ê²© ìœ ì§€ (ì‹¤ì‹œê°„ ë°˜ì˜ ìœ„í•¨)
      heartbeat = setInterval(async ()=>{ 
          try{ await channel.track(getSnapshot()); }catch{} 
      }, 15000);
    }
  });

  presenceToggle.textContent = getTranslation('public_on');
}
async function goOffline(){
  if(heartbeat){ clearInterval(heartbeat); heartbeat = null; }
  if(channel){ try{ await channel.unsubscribe(); }catch{} }
  channel = null;
  presenceToggle.textContent = getTranslation('public_off');
  presencePanel.style.display = "none";
  presenceList.innerHTML = "";
}

// ë‹‰ë„¤ì„ ì ìš© ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
applyNick.addEventListener('click', goOnline);

// [ìˆ˜ì •] ë‹‰ë„¤ì„ ì…ë ¥ ì‹œ localStorage ì—…ë°ì´íŠ¸ ë° UI ë°˜ì˜ë§Œ. ì—°ê²°ì€ ì ìš© ë²„íŠ¼ìœ¼ë¡œ ë¶„ë¦¬.
nicknameInput.addEventListener('input', ()=>{
    const currentNick = nicknameInput.value.trim();
    localStorage.setItem("nickname", currentNick);
    meNickEl.textContent = currentNick; // ì¦‰ì‹œ UI ë°˜ì˜
    if (currentNick === "" && channel) {
        // ë‹‰ë„¤ì„ì´ ë¹„ì–´ ìˆê³  í˜„ì¬ ì—°ê²°ë˜ì–´ ìˆë‹¤ë©´, ì˜¤í”„ë¼ì¸ìœ¼ë¡œ ì „í™˜
        goOffline(); 
    }
});


presenceToggle?.addEventListener("click", async ()=>{
  if(!channel){ await goOnline(); } else { await goOffline(); }
});
</script>
</body>
</html>
